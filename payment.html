<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ì‚¬ ê²°ì œ ë° ì¸ì¦</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 40px 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .store-badge { background: #E3F2FD; color: #2196F3; font-weight: bold; padding: 8px 15px; border-radius: 20px; display: inline-block; margin-bottom: 10px; }
        h1 { margin: 0 0 20px 0; font-size: 26px; color: #333; }
        
        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 13px; color: #666; margin-bottom: 5px; font-weight: bold; }
        .input-group input { width: 95%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; outline: none; background: #fafafa; }
        .input-group input:focus { border-color: #2196F3; background: #fff; }

        .btn-confirm { width: 100%; background: #333; color: white; padding: 16px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        
        /* ê¸ˆì•¡ ì…ë ¥ í™”ë©´ (ìˆ¨ê¹€) */
        #amountSection { display: none; border-top: 2px solid #eee; margin-top: 20px; padding-top: 20px; animation: slideDown 0.3s; }
        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }
        
        #amountInput { font-size: 32px; text-align: center; color: #2196F3; font-weight: bold; letter-spacing: 1px; }

        /* ì‹ê¶Œ (í‹°ì¼“) ìŠ¤íƒ€ì¼ */
        #ticketView { display: none; }
        .ticket-box {
            background: linear-gradient(45deg, #2196F3, #21CBF3, #2196F3);
            background-size: 200% 200%;
            animation: gradientMove 3s ease infinite;
            color: white; padding: 30px 20px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 30px rgba(33, 150, 243, 0.4); margin-top: 20px;
        }
        @keyframes gradientMove { 0% {background-position: 0% 50%} 50% {background-position: 100% 50%} 100% {background-position: 0% 50%} }
        .ticket-amount { font-size: 40px; font-weight: bold; margin: 15px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .ticket-time { font-size: 16px; background: rgba(0,0,0,0.2); padding: 5px 15px; border-radius: 20px; font-family: monospace; display: inline-block; }
    </style>
</head>
<body>

<div class="container" id="loginView">
    <div class="store-badge" id="displayStore">ì‹ë‹¹ ì´ë¦„</div>
    <h1>ì²­ì†Œë…„ ì¸ì¦ ë° ê²°ì œ</h1>
    
    <div id="loginSection">
        <div class="input-group">
            <label>ì•„ì´ë”” (ì´ë¦„+ìƒë…„ì›”ì¼)</label>
            <input type="text" id="loginId" placeholder="ì˜ˆ: ë°•ë“œë¦¼081212">
        </div>
        <div class="input-group">
            <label>ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        </div>
        <button class="btn-confirm" onclick="verifyUser()">ì¸ì¦í•˜ê¸°</button>
    </div>

    <div id="amountSection">
        <p style="color:#2196F3; font-weight:bold; font-size:18px;">âœ… ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤!</p>
        <p style="color:#666; margin-bottom:15px;">ì‹ì‚¬ í›„ ê²°ì œí•  ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
        <div class="input-group">
            <input type="number" id="payAmount" placeholder="ê¸ˆì•¡ (ì˜ˆ: 8000)" id="amountInput">
        </div>
        <button class="btn-confirm" onclick="processPayment()" style="background-color: #2196F3;">ê²°ì œ í™•ì¸ (ì‹ê¶Œë°œí–‰)</button>
    </div>
</div>

<div class="container" id="ticketView">
    <div class="store-badge" id="ticketStoreName"></div>
    <h2>âœ… ì‹ì‚¬ ê²°ì œ ì™„ë£Œ</h2>
    <div class="ticket-box">
        <div style="font-size: 24px; font-weight: bold;" id="ticketUserName">ì´ë¦„</div>
        <div class="ticket-amount" id="ticketAmount">0ì›</div>
        <div class="ticket-time" id="ticketTime">00:00:00</div>
        <div style="margin-top: 20px; font-size: 14px; opacity: 0.9;">ë§›ìˆê²Œ ë“œì„¸ìš”! ğŸ˜‹</div>
    </div>
    <button class="btn-confirm" style="background:#fff; color:#333; border:1px solid #ddd; margin-top:20px;" onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAalHhoEK-ko55Jep-7k8ULHeaWWU99oh8",
      authDomain: "dream-meal-support.firebaseapp.com",
      projectId: "dream-meal-support",
      storageBucket: "dream-meal-support.firebasestorage.app",
      messagingSenderId: "230720243044",
      appId: "1:230720243044:web:eb38ecc28353a1c70aa671"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // URLì—ì„œ ì‹ë‹¹ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
    const urlParams = new URLSearchParams(window.location.search);
    const storeName = urlParams.get('store') || "ì•Œ ìˆ˜ ì—†ëŠ” ì‹ë‹¹";
    document.getElementById('displayStore').innerText = storeName;
    document.getElementById('ticketStoreName').innerText = storeName;

    let currentUser = null;
    let applicationDocId = null;

    // 1. ìœ ì € ì¸ì¦ ë° ì‹ ì²­ ë‚´ì—­ í™•ì¸
    window.verifyUser = async () => {
        const rawId = document.getElementById('loginId').value.replace(/\s/g, ''); 
        const pw = document.getElementById('loginPw').value;
        const idMatch = rawId.match(/^([ê°€-í£a-zA-Z]+)(\d{6})$/);

        if(!idMatch) return alert("ì•„ì´ë”” í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.");
        const name = idMatch[1];
        const birth = idMatch[2];

        try {
            // A. ìœ ì € í™•ì¸
            const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth), where("password", "==", pw));
            const snapshot = await getDocs(q);
            if(snapshot.empty) return alert("íšŒì› ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.");
            
            currentUser = snapshot.docs[0].data();
            const userId = snapshot.docs[0].id;
            const today = new Date().toISOString().split('T')[0];

            // B. ê¸‰ì‹ ì‹ ì²­ ë‚´ì—­ í™•ì¸ (ì˜¤ëŠ˜ ë‚ ì§œ)
            const appQ = query(collection(db, "meal_applications"), where("student_id", "==", userId), where("date", "==", today));
            const appSnap = await getDocs(appQ);

            if (appSnap.empty) {
                // ì‹ ì²­ ë‚´ì—­ì´ ì•„ì˜ˆ ì—†ìŒ
                alert("â›” ê²°ì œ ë¶ˆê°€\n\nì„¼í„°ì—ì„œ ì¶œì„ ë° ì‹ì‚¬ ì‹ ì²­ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.\ní˜¹ì€ ì„ ìƒë‹˜ê»˜ ìŠ¹ì¸ì„ ìš”ì²­í•˜ì„¸ìš”.");
                return;
            }

            const appData = appSnap.docs[0].data();
            applicationDocId = appSnap.docs[0].id;

            // ìƒíƒœ ì²´í¬ (ì‹ ì²­ë¨ OR ìŠ¹ì¸ë¨)
            // 'applied': ì„¼í„°ì—ì„œ ì‹ ì²­í•¨ / 'approved': ì„ ìƒë‹˜ì´ ìŠ¹ì¸í•¨
            if(appData.status === 'applied' || appData.status === 'approved') {
                // ì„±ê³µ: ê¸ˆì•¡ ì…ë ¥ì°½ ë³´ì—¬ì£¼ê¸°
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('amountSection').style.display = 'block';
            } else if (appData.status === 'completed') {
                alert("ì´ë¯¸ ì‹ì‚¬ë¥¼ ì™„ë£Œí•˜ì…¨ìŠµë‹ˆë‹¤.");
            } else {
                alert("ì´ìš©í•  ìˆ˜ ì—†ëŠ” ìƒíƒœì…ë‹ˆë‹¤.");
            }

        } catch(e) {
            console.error(e);
            alert("ì‹œìŠ¤í…œ ì˜¤ë¥˜");
        }
    };

    // 2. ê²°ì œ ì²˜ë¦¬
    window.processPayment = async () => {
        const amount = document.getElementById('payAmount').value;
        if(!amount || amount < 1000) return alert("ê¸ˆì•¡ì„ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");

        try {
            // DB ì—…ë°ì´íŠ¸: ê¸ˆì•¡ ì €ì¥, ìƒíƒœ ì™„ë£Œ, ì‚¬ìš© ì‹œê°„ ê¸°ë¡
            // ì‹ë‹¹ ì´ë¦„ì´ ë‹¤ë¥¼ ê²½ìš°, í˜„ì¬ QRì½”ë“œ ì‹ë‹¹ ì´ë¦„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ìœ ì—°ì„±)
            await updateDoc(doc(db, "meal_applications", applicationDocId), {
                amount: Number(amount),
                status: 'completed',
                used_at: Timestamp.now(),
                store_name: storeName // ì‹¤ì œ ë¨¹ì€ ì‹ë‹¹ìœ¼ë¡œ ë®ì–´ì”€
            });

            // í™”ë©´ ì „í™˜ (ì‹ê¶Œ í‘œì‹œ)
            document.getElementById('loginView').style.display = 'none';
            document.getElementById('ticketView').style.display = 'block';
            
            document.getElementById('ticketUserName').innerText = currentUser.name;
            document.getElementById('ticketAmount').innerText = Number(amount).toLocaleString() + "ì›";
            
            // ì‹œê³„
            setInterval(() => {
                document.getElementById('ticketTime').innerText = new Date().toLocaleTimeString();
            }, 1000);

        } catch(e) {
            alert("ê²°ì œ ì²˜ë¦¬ ì‹¤íŒ¨");
        }
    };
</script>
</body>
</html>