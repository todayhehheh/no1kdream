<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모바일 식권 결제</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f8f9fa;
            margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%; max-width: 400px;
            background: white; border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 30px 20px; text-align: center;
        }
        h2 { color: #333; margin-bottom: 20px; font-weight: 800; }
        .store-name { color: #6C5CE7; font-size: 1.2rem; margin-bottom: 30px; font-weight: bold; }
        
        input {
            width: 100%; padding: 15px; margin-bottom: 15px;
            border: 2px solid #eee; border-radius: 12px;
            font-size: 16px; box-sizing: border-box; transition: 0.2s;
        }
        input:focus { border-color: #6C5CE7; outline: none; }
        
        .btn-main {
            width: 100%; padding: 15px;
            background: #6C5CE7; color: white;
            border: none; border-radius: 12px;
            font-size: 18px; font-weight: bold; cursor: pointer;
            transition: 0.2s;
        }
        .btn-main:active { transform: scale(0.98); }

        /* 식권 화면 스타일 */
        .ticket-view { display: none; }
        .ticket-box {
            border: 2px dashed #6C5CE7; border-radius: 15px;
            padding: 20px; background: #f3f0ff; margin-top: 20px;
        }
        .ticket-time { font-size: 2em; font-weight: 900; color: #2d3436; margin: 10px 0; }
        .ticket-check { font-size: 50px; color: #00b894; margin-bottom: 10px; }
        
        #loadingOverlay {
            display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #6C5CE7;
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loadingOverlay"><div class="spinner"></div><p style="margin-top:10px; font-weight:bold;">처리중...</p></div>

    <div class="container" id="loginView">
        <h2>꿈드림 급식 결제</h2>
        <div class="store-name">현재 식당: <span id="displayStore">로딩중...</span></div>
        
        <div id="loginSection">
            <input type="text" id="loginId" placeholder="아이디 (이름+생년월일6자리)">
            <input type="password" id="loginPw" placeholder="비밀번호">
            <button class="btn-main" onclick="verifyUser()">내역 조회</button>
        </div>

        <div id="amountSection" style="display:none;">
            <p style="color:#666; font-size:14px; margin-bottom:10px;">식사하신 금액을 입력해주세요</p>
            <input type="number" id="payAmount" placeholder="금액 입력 (원)" inputmode="numeric">
            <button class="btn-main" style="background:#00b894;" onclick="processPayment()">결제 하기</button>
        </div>
    </div>

    <div class="container ticket-view" id="ticketView">
        <div class="ticket-check">✅</div>
        <h2>식사 결제 완료</h2>
        <div class="ticket-box">
            <div style="font-size:14px; color:#666;">식당명</div>
            <div id="ticketStoreName" style="font-weight:bold; font-size:18px; margin-bottom:15px;">-</div>
            
            <div style="font-size:14px; color:#666;">이용자</div>
            <div id="ticketUserName" style="font-weight:bold; font-size:18px; margin-bottom:15px;">-</div>

            <div style="font-size:14px; color:#666;">결제 금액</div>
            <div id="ticketAmount" style="font-weight:bold; font-size:24px; color:#6C5CE7;">0원</div>
        </div>
        <div class="ticket-time" id="ticketTime">00:00:00</div>
        <p style="color:#888; font-size:12px; margin-top:20px;">이 화면을 사장님께 보여주세요.</p>
    </div>

    <script type="module">
        import { db, collection, query, where, getDocs, updateDoc, doc, Timestamp } from "./js/firebase-config.js";

        const urlParams = new URLSearchParams(window.location.search);
        const storeName = urlParams.get('store') || "알 수 없는 식당";

        document.getElementById('displayStore').innerText = storeName;
        document.getElementById('ticketStoreName').innerText = storeName;

        let currentUser = null;
        let applicationDocId = null;

        const getTodayStr = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        };

        const showLoading = (show) => {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        window.verifyUser = async () => {
            const rawId = document.getElementById('loginId').value.replace(/\s/g, '');
            const pw = document.getElementById('loginPw').value;
            const idMatch = rawId.match(/^([가-힣a-zA-Z]+)(\d{6})$/);

            if (!idMatch) return Swal.fire('오류', '아이디 형식을 확인해주세요.<br>(이름+생년월일 6자리)', 'warning');

            const name = idMatch[1];
            const birth = idMatch[2];

            showLoading(true);

            try {
                const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth), where("password", "==", pw));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    showLoading(false);
                    return Swal.fire('인증 실패', '회원 정보가 일치하지 않습니다.', 'error');
                }

                currentUser = snapshot.docs[0].data();
                const userId = snapshot.docs[0].id;
                const today = getTodayStr();

                // approved 상태 조회 (키오스크에서 바로 승인됨)
                const appQ = query(collection(db, "meal_applications"), 
                    where("student_id", "==", userId), 
                    where("date", "==", today),
                    where("status", "==", "approved") 
                );
                const appSnap = await getDocs(appQ);

                if (appSnap.empty) {
                    showLoading(false);
                    // 이미 결제 완료했는지 체크
                    const completedQ = query(collection(db, "meal_applications"), 
                        where("student_id", "==", userId), 
                        where("date", "==", today),
                        where("status", "==", "completed")
                    );
                    const completedSnap = await getDocs(completedQ);

                    if(!completedSnap.empty) return Swal.fire('사용 완료', '오늘 이미 식사를 하셨습니다.', 'info');
                    else return Swal.fire('신청 내역 없음', '키오스크에서 먼저 식사를 신청해주세요.', 'error');
                }

                const appDoc = appSnap.docs[0];
                const appData = appDoc.data();

                if (appData.store_name !== storeName) {
                    showLoading(false);
                    return Swal.fire({
                        icon: 'error',
                        title: '식당 불일치',
                        html: `신청하신 식당: <b>${appData.store_name}</b><br>현재 접속 식당: <b>${storeName}</b><br><br>올바른 식당 QR코드를 스캔해주세요.`
                    });
                }

                applicationDocId = appDoc.id;
                showLoading(false);
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('amountSection').style.display = 'block';

            } catch (e) {
                console.error(e);
                showLoading(false);
                Swal.fire('오류', '시스템 처리 중 문제가 발생했습니다.', 'error');
            }
        };

        window.processPayment = async () => {
            const amount = document.getElementById('payAmount').value;
            if (!amount) return Swal.fire('알림', '금액을 입력해주세요.', 'warning');

            const numAmount = Number(amount);
            if (numAmount > 30000) return Swal.fire('한도 초과', '금액이 너무 큽니다. 확인해주세요.', 'warning');
            if (numAmount < 100) return Swal.fire('금액 오류', '올바른 금액을 입력해주세요.', 'warning');

            const result = await Swal.fire({
                title: `${numAmount.toLocaleString()}원`,
                text: "결제하시겠습니까?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '결제하기',
                confirmButtonColor: '#6C5CE7'
            });

            if (!result.isConfirmed) return;

            showLoading(true);

            try {
                // 식사 완료 처리 (정산은 나중에)
                await updateDoc(doc(db, "meal_applications", applicationDocId), {
                    amount: numAmount,
                    status: 'completed',
                    is_settled: false,
                    used_at: Timestamp.now()
                });

                showLoading(false);
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('ticketView').style.display = 'block';
                document.getElementById('ticketUserName').innerText = currentUser.name;
                document.getElementById('ticketAmount').innerText = numAmount.toLocaleString() + "원";

                const updateTime = () => {
                    document.getElementById('ticketTime').innerText = new Date().toLocaleTimeString();
                };
                updateTime();
                setInterval(updateTime, 1000);

            } catch (e) {
                console.error(e);
                showLoading(false);
                Swal.fire('실패', '결제 저장 실패. 다시 시도해주세요.', 'error');
            }
        };
    </script>
</body>
</html>
