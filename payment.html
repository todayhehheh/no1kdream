<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹ì‚¬ ê²°ì œ ë° ì¸ì¦</title>
    <!-- Shared Style -->
    <link rel="stylesheet" href="css/style.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .glass-container {
            max-width: 450px;
            text-align: center;
        }

        .store-badge {
            background: rgba(33, 150, 243, 0.1);
            color: #2196F3;
            font-weight: 800;
            padding: 6px 15px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 20px;
            font-size: 14px;
            border: 1px solid rgba(33, 150, 243, 0.2);
        }

        /* Amount Section Animation */
        #amountSection {
            display: none;
            margin-top: 20px;
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Ticket Design */
        #ticketView {
            display: none;
        }

        .ticket-box {
            background: linear-gradient(135deg, #6C5CE7, #a29bfe);
            color: white;
            padding: 40px 30px;
            border-radius: 24px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(108, 92, 231, 0.4);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        /* Holographic Shine Effect */
        .ticket-box::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% {
                left: -150%;
            }

            100% {
                left: 150%;
            }
        }

        .ticket-user {
            font-size: 24px;
            font-weight: 800;
            opacity: 0.9;
            margin-bottom: 5px;
            position: relative;
        }

        .ticket-amount {
            font-size: 48px;
            font-weight: 900;
            margin: 15px 0;
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .ticket-time {
            font-size: 14px;
            background: rgba(0, 0, 0, 0.2);
            padding: 6px 14px;
            border-radius: 30px;
            font-family: monospace;
            display: inline-block;
            position: relative;
        }

        .btn-confirm {
            width: 100%;
            margin-top: 15px;
            padding: 16px;
            font-size: 18px;
        }
    </style>
</head>

<body>

    <!-- Loading -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Login & Payment View -->
    <div class="glass-container" id="loginView">
        <div class="store-badge" id="displayStore">ì‹ë‹¹ ì´ë¦„</div>
        <h1>ì²­ì†Œë…„ ì¸ì¦ ë° ê²°ì œ</h1>

        <div id="loginSection">
            <div class="input-group">
                <label>ì•„ì´ë”” (ì´ë¦„+ìƒë…„ì›”ì¼)</label>
                <input type="text" id="loginId" class="input-field" placeholder="ì˜ˆ: ë°•ë“œë¦¼081212">
            </div>
            <div class="input-group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="loginPw" class="input-field" placeholder="ë¹„ë°€ë²ˆí˜¸">
            </div>
            <button class="btn btn-primary btn-confirm" onclick="verifyUser()">ì¸ì¦í•˜ê¸°</button>
        </div>

        <div id="amountSection">
            <div style="font-size: 40px; margin-bottom: 10px;">âœ…</div>
            <h2 style="color: var(--primary-color);">ì¸ì¦ ì„±ê³µ!</h2>
            <p style="color:#666; margin-bottom: 20px; font-size: 15px;">ì‹ì‚¬ í›„ ê²°ì œí•  ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.<br>(ìµœëŒ€ 10,000ì›)</p>

            <div class="input-group">
                <input type="number" id="payAmount" class="input-field" placeholder="ê¸ˆì•¡ (ì˜ˆ: 8000)"
                    style="font-size:28px; text-align:center; font-weight:bold; color:var(--primary-color); height: 60px;">
            </div>
            <button class="btn btn-primary btn-confirm" onclick="processPayment()">ê²°ì œ í™•ì¸ (ì‹ê¶Œë°œí–‰)</button>
        </div>
    </div>

    <!-- Ticket View -->
    <div class="glass-container" id="ticketView">
        <div class="store-badge" id="ticketStoreName"></div>
        <h2>âœ… ê²°ì œ ì™„ë£Œ</h2>

        <div class="ticket-box">
            <div class="ticket-user" id="ticketUserName">ì´ë¦„</div>
            <div class="ticket-amount" id="ticketAmount">0ì›</div>
            <div class="ticket-time" id="ticketTime">00:00:00</div>
            <div style="margin-top: 25px; font-size: 15px; opacity: 0.9; position: relative; font-weight: 600;">ë§›ìˆê²Œ ë“œì„¸ìš”!
                ğŸ˜‹</div>
        </div>

        <button class="btn btn-confirm" style="background:white; color:#333; border:1px solid #ddd; margin-top:25px;"
            onclick="location.reload()">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>

    <script type="module">
        import { db, collection, query, where, getDocs, updateDoc, doc, Timestamp } from "./js/firebase-config.js";

        // Constants
        const urlParams = new URLSearchParams(window.location.search);
        const storeName = urlParams.get('store') || "ì•Œ ìˆ˜ ì—†ëŠ” ì‹ë‹¹";

        // Init UI
        document.getElementById('displayStore').innerText = storeName;
        document.getElementById('ticketStoreName').innerText = storeName;

        let currentUser = null;
        let applicationDocId = null;

        const getTodayStr = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        };

        const showLoading = (show) => {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        window.verifyUser = async () => {
            const rawId = document.getElementById('loginId').value.replace(/\s/g, '');
            const pw = document.getElementById('loginPw').value;
            const idMatch = rawId.match(/^([ê°€-í£a-zA-Z]+)(\d{6})$/);

            if (!idMatch) return Swal.fire('ì˜¤ë¥˜', 'ì•„ì´ë”” í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.<br>(ì´ë¦„+ìƒë…„ì›”ì¼ 6ìë¦¬)', 'warning');

            const name = idMatch[1];
            const birth = idMatch[2];

            showLoading(true);

            try {
                // A. User Check
                const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth), where("password", "==", pw));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    showLoading(false);
                    return Swal.fire('ì¸ì¦ ì‹¤íŒ¨', 'íšŒì› ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.', 'error');
                }

                currentUser = snapshot.docs[0].data();
                const userId = snapshot.docs[0].id;
                const today = getTodayStr();

                // B. Check Application
                const appQ = query(collection(db, "meal_applications"), where("student_id", "==", userId), where("date", "==", today));
                const appSnap = await getDocs(appQ);

                if (appSnap.empty) {
                    showLoading(false);
                    return Swal.fire('ê²°ì œ ë¶ˆê°€', 'ì„¼í„°ì—ì„œ ë¨¼ì € ì¶œì„ ë° ì‹ ì²­ì„ í•´ì£¼ì„¸ìš”.', 'error');
                }

                // Find active app
                const apps = appSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const activeApp = apps.find(a => a.status === 'applied' || a.status === 'approved');

                if (activeApp) {
                    // Check Store Match
                    if (activeApp.store_name !== storeName) {
                        showLoading(false);
                        return Swal.fire({
                            icon: 'error',
                            title: 'ì‹ë‹¹ ë¶ˆì¼ì¹˜',
                            html: `ì‹ ì²­í•œ ì‹ë‹¹: <b>${activeApp.store_name}</b><br>í˜„ì¬ ì‹ë‹¹: <b>${storeName}</b><br><br>ì„ ìƒë‹˜ê»˜ ë³€ê²½ì„ ìš”ì²­í•˜ì„¸ìš”.`
                        });
                    }

                    // Success
                    applicationDocId = activeApp.id;
                    showLoading(false);
                    document.getElementById('loginSection').style.display = 'none';
                    document.getElementById('amountSection').style.display = 'block';

                } else {
                    showLoading(false);
                    return Swal.fire('ê²°ì œ ë¶ˆê°€', 'ì´ë¯¸ ì‹ì‚¬ë¥¼ ì™„ë£Œí•˜ì…¨ê±°ë‚˜ ìŠ¹ì¸ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
                }

            } catch (e) {
                console.error(e);
                showLoading(false);
                Swal.fire('ì‹œìŠ¤í…œ ì˜¤ë¥˜', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        };

        window.processPayment = async () => {
            const amount = document.getElementById('payAmount').value;
            if (!amount) return Swal.fire('ì•Œë¦¼', 'ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');

            const numAmount = Number(amount);
            if (numAmount > 10000) return Swal.fire('í•œë„ ì´ˆê³¼', 'ìµœëŒ€ 10,000ì›ê¹Œì§€ë§Œ ê²°ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'warning');
            if (numAmount < 1000) return Swal.fire('ê¸ˆì•¡ ì˜¤ë¥˜', 'ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');

            // Confirm
            const result = await Swal.fire({
                title: `${numAmount.toLocaleString()}ì›`,
                text: "ê²°ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'ë„¤, ê²°ì œí•©ë‹ˆë‹¤',
                cancelButtonText: 'ì·¨ì†Œ'
            });

            if (!result.isConfirmed) return;

            showLoading(true);

            try {
                // Update DB
                await updateDoc(doc(db, "meal_applications", applicationDocId), {
                    amount: numAmount,
                    status: 'completed',
                    used_at: Timestamp.now(),
                    store_name: storeName
                });

                showLoading(false);

                // Show Ticket View
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('ticketView').style.display = 'block';

                document.getElementById('ticketUserName').innerText = currentUser.name;
                document.getElementById('ticketAmount').innerText = numAmount.toLocaleString() + "ì›";

                // Live Clock
                const updateTime = () => {
                    document.getElementById('ticketTime').innerText = new Date().toLocaleTimeString();
                };
                updateTime();
                setInterval(updateTime, 1000);

            } catch (e) {
                console.error(e);
                showLoading(false);
                Swal.fire('ì‹¤íŒ¨', 'ê²°ì œ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        };
    </script>
</body>

</html>