<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .glass-container { max-width: 1200px; margin: 0 auto; padding: 30px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h1 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; color: #2d3436; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .refresh-btn { background: #fff; border: 1px solid #ddd; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 18px; }
        .refresh-btn:hover { background: #f8f9fa; transform: rotate(180deg); }
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; background: #f1f3f5; padding: 5px; border-radius: 12px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 700; color: #868e96; font-size: 15px; transition: 0.2s; white-space: nowrap; }
        .tab-btn.active { background: white; color: #6C5CE7; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .tab-btn:hover:not(.active) { background: rgba(255, 255, 255, 0.5); }
        .table-box { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; font-size: 14px; }
        th { background-color: #f8f9fa; color: #495057; font-weight: 700; padding: 12px; border-bottom: 2px solid #dee2e6; text-align: center; }
        td { padding: 12px; border-bottom: 1px solid #f1f3f5; vertical-align: middle; color: #212529; text-align: center; }
        tr:hover td { background-color: #f8f9fa; }
        .btn-small { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: bold; margin: 0 2px; transition: 0.2s; }
        .btn-blue { background: #e7f5ff; color: #1c7ed6; } .btn-blue:hover { background: #d0ebff; }
        .btn-red { background: #fff5f5; color: #fa5252; } .btn-red:hover { background: #ffe3e3; }
        .btn-green { background: #ebfbee; color: #2f9e44; } .btn-green:hover { background: #d3f9d8; }
        .btn-dark { background: #343a40; color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: bold; border:none; cursor: pointer; }
        .btn-dark:hover { background: #212529; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-blue { background: #e7f5ff; color: #1971c2; }
        .badge-green { background: #ebfbee; color: #2f9e44; }
        .store-toggles { display: flex; gap: 4px; justify-content: center; }
        .toggle-btn { padding: 6px 10px; border: 1px solid #dee2e6; background: white; color: #adb5bd; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .toggle-btn:hover { background: #f8f9fa; }
        .active-dalin { background: #fff9db; color: #f08c00; border-color: #fcc419; }
        .active-mystery { background: #f3d9fa; color: #be4bdb; border-color: #e599f7; }
        .active-yeon { background: #e6fcf5; color: #0ca678; border-color: #63e6be; }
        .filter-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; background: #f8f9fa; padding: 15px; border-radius: 12px; }
        .filter-bar label { font-size: 14px; font-weight: bold; color: #495057; }
        .filter-bar select, .filter-bar input { border: 1px solid #ced4da; padding: 8px; border-radius: 6px; outline: none; }
        .summary-box { background: #e7f5ff; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-around; font-weight: 700; color: #1864ab; }
        .ad-setting-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 800px) { .ad-setting-box { grid-template-columns: 1fr; } }
        .ad-card { background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #dee2e6; }
        
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #495057; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; }
        #loadingOverlay { display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #6C5CE7; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #hidden-print-zone { position: fixed; top: 0; left: 0; width: 210mm; min-height: 297mm; background: white; z-index: -9999; padding: 20mm; box-sizing: border-box; opacity: 0; pointer-events: none; }
    </style>
</head>

<body>

    <div id="loadingOverlay"><div class="spinner"></div></div>

    <div class="glass-container">
        <h1>
            <div class="header-left">
                <span>ğŸ“‹ ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</span>
                <button class="btn-dark" onclick="registerThisDevice()" title="ì´ PCë¥¼ í‚¤ì˜¤ìŠ¤í¬ë¡œ ì¸ì¦í•©ë‹ˆë‹¤">ğŸ–¥ï¸ ê¸°ê¸° ë“±ë¡</button>
                <button class="btn-small btn-red" onclick="unregisterThisDevice()" title="ì¸ì¦ í•´ì œ">ğŸš« í•´ì œ</button>
            </div>
            <button class="refresh-btn" onclick="refreshData()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
        </h1>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('users')">1. ì „ì²´ ì²­ì†Œë…„ & ê¸‰ì‹</button>
            <button class="tab-btn" onclick="switchTab('settlement')">2. ì •ì‚° ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchTab('records')">3. í†µí•© ê¸°ë¡</button>
            <button class="tab-btn" onclick="switchTab('ads')">4. ê´‘ê³  ì„¤ì •</button>
            <button class="tab-btn" onclick="switchTab('education')">5. ê¸°ì´ˆì†Œì–‘êµìœ¡</button>
        </div>

        <div id="tab-users" class="table-box">
            <div style="margin-bottom: 10px; color:#555; font-size:14px;">ğŸ“… <strong>ì˜¤ëŠ˜ (<span id="todayDisplay"></span>)</strong> ê¸°ì¤€ ìƒíƒœ</div>
            <table>
                <thead>
                    <tr>
                        <th width="15%">ì´ë¦„ (ìƒì¼)</th>
                        <th width="20%">ìƒíƒœ</th>
                        <th width="35%">ìŠ¹ì¸/ë³€ê²½</th>
                        <th width="20%">ê³„ì •</th>
                        <th width="10%">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"><tr><td colspan="5">ë¡œë”© ì¤‘...</td></tr></tbody>
            </table>
        </div>

        <div id="tab-settlement" class="table-box" style="display:none;">
            <div class="filter-bar">
                <label>ê¸°ê°„:</label><input type="date" id="settleStart"> ~ <input type="date" id="settleEnd">
                <label>ì—…ì²´:</label><select id="settleStore">
                    <option value="all">ì „ì²´</option>
                    <option value="ë‹¬ì¸ë³´ìŒˆ">ë‹¬ì¸ë³´ìŒˆ</option>
                    <option value="ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹">ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹</option>
                    <option value="ì—°ê¹€ë°¥">ì—°ê¹€ë°¥</option>
                </select>
                <label>ìƒíƒœ:</label><select id="settleStatus">
                    <option value="all">ì „ì²´</option>
                    <option value="no">âŒ ë¯¸ì •ì‚°</option>
                    <option value="yes">âœ… ì •ì‚°ì™„ë£Œ</option>
                </select>
                <button class="btn-small btn-blue" onclick="loadSettlementData()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('settleTable', 'ì •ì‚°ë‚´ì—­')">ì—‘ì…€</button>
            </div>
            <div class="summary-box">
                <span>ì´ ê±´ìˆ˜: <span id="sumCount">0</span></span>
                <span>ì´ ë§¤ì¶œ: <span id="sumPrice">0</span></span>
                <span style="color:#e03131">ë¯¸ì •ì‚°(ì§€ê¸‰ì˜ˆì •): <span id="sumUnpaid">0</span></span>
            </div>
            <table id="settleTable">
                <thead><tr><th>ë‚ ì§œ</th> <th>ì´ë¦„ (ìƒë…„ì›”ì¼)</th> <th>ì—…ì²´</th> <th>ê¸ˆì•¡</th> <th>ì •ì‚°ìƒíƒœ</th></tr></thead>
                <tbody id="settleBody"></tbody>
            </table>
        </div>

        <div id="tab-records" class="table-box" style="display:none;">
            <div class="filter-bar">
                <label>ê¸°ê°„:</label><input type="date" id="recStart"> ~ <input type="date" id="recEnd">
                <label>í™œë™:</label><select id="recActivity">
                    <option value="">ì „ì²´</option>
                    <option value="ê¸°ì´ˆì†Œì–‘êµìœ¡">ê¸°ì´ˆì†Œì–‘</option>
                    <option value="í”„ë¡œê·¸ë¨">í”„ë¡œê·¸ë¨</option>
                    <option value="ìŠ¤í„°ë””ì¹´í˜">ìŠ¤í„°ë””</option>
                </select>
                <button class="btn-small btn-blue" onclick="loadRecords()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('recordTable', 'í™œë™ê¸°ë¡')">ì—‘ì…€</button>
            </div>
            <table id="recordTable">
                <thead><tr><th>ì´ë¦„ (ìƒë…„ì›”ì¼)</th> <th>ì¼ì</th> <th>í™œë™ë‚´ì—­</th></tr></thead>
                <tbody id="recBody"></tbody>
            </table>
        </div>

        <div id="tab-ads" class="table-box" style="display:none;">
            <h2>ğŸ“¢ í‚¤ì˜¤ìŠ¤í¬ ê´‘ê³  ë°°ë„ˆ ì„¤ì •</h2>
            <div class="ad-setting-box">
                <div class="ad-card">
                    <h3>ê´‘ê³  1 (ì™¼ìª½)</h3>
                    <div class="input-group"><label>ì´ë¯¸ì§€ URL</label><input type="text" id="ad1Img" class="input-field"></div>
                    <div class="input-group"><label>ì´ë™ ë§í¬</label><input type="text" id="ad1Link" class="input-field"></div>
                </div>
                <div class="ad-card">
                    <h3>ê´‘ê³  2 (ê°€ìš´ë°)</h3>
                    <div class="input-group"><label>ì´ë¯¸ì§€ URL</label><input type="text" id="ad2Img" class="input-field"></div>
                    <div class="input-group"><label>ì´ë™ ë§í¬</label><input type="text" id="ad2Link" class="input-field"></div>
                </div>
                <div class="ad-card">
                    <h3>ê´‘ê³  3 (ì˜¤ë¥¸ìª½)</h3>
                    <div class="input-group"><label>ì´ë¯¸ì§€ URL</label><input type="text" id="ad3Img" class="input-field"></div>
                    <div class="input-group"><label>ì´ë™ ë§í¬</label><input type="text" id="ad3Link" class="input-field"></div>
                </div>
            </div>
            <button class="btn-dark" style="width:100%; margin-top:20px; padding:15px;" onclick="saveAds()">ì„¤ì • ì €ì¥</button>
        </div>

        <div id="tab-education" class="table-box" style="display:none;">
            <div class="filter-bar">
                <label>ê¸°ê°„:</label><input type="date" id="eduStart"> ~ <input type="date" id="eduEnd">
                <label>ì´ë¦„:</label><input type="text" id="eduSearchName" placeholder="ì „ì²´">
                <button class="btn-small btn-blue" onclick="loadEducationStats()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('eduTable', 'ê¸°ì´ˆì†Œì–‘êµìœ¡_ì´ìˆ˜ëŒ€ì¥')">ì—‘ì…€</button>
            </div>
            <table id="eduTable">
                <thead><tr><th>ìˆ˜ê°•ì¼ì</th> <th>ì´ë¦„</th> <th>ìƒë…„ì›”ì¼</th> <th>ìˆ˜ê°•ê³¼ëª©</th> <th>ê°•ì˜ëª…</th></tr></thead>
                <tbody id="eduBody"><tr><td colspan="5">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { db, collection, getDocs, getDoc, setDoc, query, where, orderBy, updateDoc, addDoc, deleteDoc, doc, Timestamp } from "./js/firebase-config.js";

        const ADMIN_PW = "1388";
        const showLoading = (show) => { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
        const getTodayStr = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        };

        window.onload = async () => {
            const { value: inputPw } = await Swal.fire({
                title: 'ê´€ë¦¬ì ì ‘ì†', input: 'password', inputPlaceholder: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                allowOutsideClick: false, confirmButtonText: 'ì ‘ì†'
            });
            if (inputPw !== ADMIN_PW) {
                document.body.innerHTML = "<div style='text-align:center;margin-top:20%;color:red;'><h2>â›” ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</h2><button onclick='location.reload()'>ë‹¤ì‹œ ì‹œë„</button></div>";
                return;
            }
            const todayStr = getTodayStr();
            const monthAgo = new Date(); monthAgo.setMonth(monthAgo.getMonth() - 1);
            const monthAgoStr = monthAgo.toISOString().split('T')[0];

            document.getElementById('todayDisplay').innerText = todayStr;
            // ë‚ ì§œ ì´ˆê¸°í™” (ëª¨ë“  íƒ­)
            ['settle', 'rec', 'edu'].forEach(prefix => {
                document.getElementById(`${prefix}Start`).value = monthAgoStr;
                document.getElementById(`${prefix}End`).value = todayStr;
            });

            loadAllUsersAndApps();
        };

        // --- Tab 1: íšŒì› ë° ê¸‰ì‹ ê´€ë¦¬ ---
        window.loadAllUsersAndApps = async () => {
            showLoading(true);
            const today = getTodayStr();
            const tbody = document.getElementById('userTableBody');
            
            try {
                const userSnap = await getDocs(query(collection(db, "users"), orderBy("name")));
                const appSnap = await getDocs(query(collection(db, "meal_applications"), where("date", "==", today)));

                let appsMap = {};
                appSnap.forEach(doc => {
                    const d = doc.data();
                    if (!appsMap[d.student_id]) appsMap[d.student_id] = [];
                    // ì‹œê°„ìˆœ ì •ë ¬ì„ ìœ„í•´ timestamp ì €ì¥ (ì—†ìœ¼ë©´ ë‚ ì§œê¸°ë°˜ 0ì‹œ)
                    appsMap[d.student_id].push({ docId: doc.id, ...d, ts: d.timestamp ? d.timestamp.toMillis() : new Date(d.date).getTime() });
                });

                tbody.innerHTML = "";
                if (userSnap.empty) { tbody.innerHTML = "<tr><td colspan='5'>íšŒì› ì—†ìŒ</td></tr>"; showLoading(false); return; }

                userSnap.forEach(userDoc => {
                    const u = userDoc.data();
                    const userId = userDoc.id;
                    let studentApps = appsMap[userId] || [];
                    
                    // ìµœì‹ ìˆœ ì •ë ¬
                    studentApps.sort((a,b) => b.ts - a.ts);
                    let activeApp = studentApps.find(app => app.status === 'applied' || app.status === 'approved');
                    let completedCount = studentApps.filter(app => app.status === 'completed').length;

                    let statusText = `<span style="color:#ccc;">-</span>`;
                    let buttonsHtml = '';

                    if (activeApp) {
                        const store = activeApp.store_name;
                        const status = activeApp.status;
                        const appId = activeApp.docId;

                        if (status === 'applied') statusText = `<span class="badge badge-blue">${store} (ì‹ ì²­)</span>`;
                        else statusText = `<span class="badge badge-green" style="background:#fff9db; color:#f08c00;">${store} (ìŠ¹ì¸)</span>`;

                        const cD = store === 'ë‹¬ì¸ë³´ìŒˆ' ? 'active-dalin' : '';
                        const cM = store === 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹' ? 'active-mystery' : '';
                        const cY = store === 'ì—°ê¹€ë°¥' ? 'active-yeon' : '';

                        buttonsHtml = `<div class="store-toggles">
                            <button class="toggle-btn ${cD}" onclick="changeStore('${appId}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button>
                            <button class="toggle-btn ${cM}" onclick="changeStore('${appId}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
                            <button class="toggle-btn ${cY}" onclick="changeStore('${appId}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
                        </div>`;
                    } else {
                        buttonsHtml = `<div class="store-toggles">
                            <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button>
                            <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
                            <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
                        </div>`;
                        if(completedCount > 0) statusText = `<span class="badge badge-green">ì™„ë£Œ (${completedCount})</span>`;
                    }

                    tbody.innerHTML += `<tr>
                        <td><div style="font-weight:bold;">${u.name}</div><div style="font-size:12px; color:#888;">${u.birth}</div></td>
                        <td>${statusText}</td>
                        <td>${buttonsHtml}</td>
                        <td><button class="btn-small" onclick="viewPw('${u.password}')">ë¹„ë²ˆ</button><button class="btn-small btn-blue" onclick="changePw('${userId}')">ë³€ê²½</button></td>
                        <td><button class="btn-small btn-red" onclick="deleteUser('${userId}', '${u.name}')">ì‚­ì œ</button></td>
                    </tr>`;
                });
            } catch(e) { console.error(e); }
            showLoading(false);
        };

        window.changeStore = async (docId, newStore) => {
            showLoading(true);
            try {
                await updateDoc(doc(db, "meal_applications", docId), { store_name: newStore, status: "approved" });
                loadAllUsersAndApps();
            } catch(e) { console.error(e); Swal.fire("ì˜¤ë¥˜", "ë³€ê²½ ì‹¤íŒ¨", "error"); }
            showLoading(false);
        };

        window.forceApprove = async (userId, userName, storeName) => {
            if(confirm(`${userName}ë‹˜ì—ê²Œ [${storeName}] ì‹ì‚¬ê¶Œì„ ë°œê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                await addDoc(collection(db, "meal_applications"), {
                    student_id: userId, student_name: userName, store_name: storeName,
                    status: "approved", date: getTodayStr(), 
                    activity: "ê´€ë¦¬ììŠ¹ì¸", timestamp: Timestamp.now(), is_settled: false
                });
                loadAllUsersAndApps();
            }
        };

        // --- Tab 2: ì •ì‚° ê´€ë¦¬ (ì‹œê°„ìˆœ ì •ë ¬ + ì‹œê°„ ìˆ¨ê¹€ + ìƒë…„ì›”ì¼ í‘œì‹œ) ---
        window.loadSettlementData = async () => {
            showLoading(true);
            const start = document.getElementById('settleStart').value;
            const end = document.getElementById('settleEnd').value;
            const targetStore = document.getElementById('settleStore').value;
            const targetStatus = document.getElementById('settleStatus').value;
            const tbody = document.getElementById('settleBody');
            
            try {
                let userMap = {};
                const uSnap = await getDocs(collection(db, "users"));
                uSnap.forEach(d => userMap[d.id] = d.data());

                // ì‹œê°„ìˆœ(timestamp desc)ìœ¼ë¡œ ê°€ì ¸ì˜´
                const snap = await getDocs(query(collection(db, "meal_applications"), orderBy("timestamp", "desc")));
                let list = [], totalCnt=0, totalPrice=0, totalUnpaid=0;

                snap.forEach(doc => {
                    const d = doc.data();
                    if (d.date < start || d.date > end) return;
                    if (targetStore !== 'all' && d.store_name !== targetStore) return;
                    if (d.status !== 'completed') return; // ì‹ì‚¬ ì™„ë£Œëœ ê±´ë§Œ

                    const isSettled = d.is_settled === true;
                    if (targetStatus === 'no' && isSettled) return;
                    if (targetStatus === 'yes' && !isSettled) return;

                    const price = d.amount ? Number(d.amount) : 0;
                    totalCnt++; 
                    totalPrice += price;
                    if(!isSettled) totalUnpaid += price;
                    
                    const u = userMap[d.student_id] || { name: d.student_name, birth: '' };
                    list.push({ id: doc.id, ...d, price, isSettled, uName: u.name, uBirth: u.birth });
                });

                document.getElementById('sumCount').innerText = totalCnt + "ê±´";
                document.getElementById('sumPrice').innerText = totalPrice.toLocaleString() + "ì›";
                document.getElementById('sumUnpaid').innerText = totalUnpaid.toLocaleString() + "ì›";

                tbody.innerHTML = list.length ? "" : "<tr><td colspan='5'>ë‚´ì—­ ì—†ìŒ</td></tr>";
                list.forEach(item => {
                    // isSettledê°€ falseë©´ 'ë¯¸ì •ì‚°', trueë©´ 'ì •ì‚°ì™„ë£Œ'
                    const btn = item.isSettled ? 
                        `<button class="btn-small btn-green" onclick="toggleSettle('${item.id}', false)">ğŸŸ¢ ì •ì‚°ì™„ë£Œ</button>` : 
                        `<button class="btn-small btn-red" onclick="toggleSettle('${item.id}', true)">ğŸ”´ ë¯¸ì •ì‚° (ì…ê¸ˆì „)</button>`; 
                    
                    // ë‚ ì§œë§Œ í‘œì‹œ (ì‹œê°„ ìˆ¨ê¹€)
                    tbody.innerHTML += `<tr>
                        <td>${item.date}</td>
                        <td>${item.uName} <span style="font-size:12px;color:#888;">(${item.uBirth})</span></td>
                        <td>${item.store_name}</td>
                        <td>${item.price.toLocaleString()}ì›</td>
                        <td>${btn}</td>
                    </tr>`;
                });
            } catch(e) { console.error(e); }
            showLoading(false);
        };

        window.toggleSettle = async (id, state) => {
            if(confirm("ì •ì‚° ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await updateDoc(doc(db, "meal_applications", id), { is_settled: state });
                loadSettlementData();
            }
        };

        // --- Tab 3: í†µí•© ê¸°ë¡ (ì‹œê°„ìˆœ ì •ë ¬ + ì‹œê°„ ìˆ¨ê¹€ + ìƒë…„ì›”ì¼ í‘œì‹œ) ---
        window.loadRecords = async () => {
            showLoading(true);
            const start = document.getElementById('recStart').value;
            const end = document.getElementById('recEnd').value;
            const filterAct = document.getElementById('recActivity').value;
            const tbody = document.getElementById('recBody');
            
            try {
                let userMap = {};
                const uSnap = await getDocs(collection(db, "users"));
                uSnap.forEach(d => userMap[d.id] = d.data());

                let records = [];
                const add = (snap, type) => snap.forEach(d => {
                    const data = d.data();
                    if(data.date >= start && data.date <= end) {
                        let actName = data.activity || (type==='meal' ? 'ì‹ì‚¬' : 'ê°„ì‹');
                        
                        if(actName.includes('ê´€ë¦¬ì')) return; 
                        if(filterAct && actName !== filterAct) return;

                        // timestamp ê¸°ì¤€ ì •ë ¬ê°’ ìƒì„±
                        const ts = data.timestamp ? data.timestamp.toMillis() : new Date(data.date).getTime();
                        const u = userMap[data.student_id] || { name: data.student_name, birth: '' };

                        records.push({ 
                            date: data.date, 
                            name: u.name, 
                            birth: u.birth,
                            act: actName,
                            ts: ts 
                        });
                    }
                });

                const [attSnap, mealSnap, snackSnap] = await Promise.all([
                    getDocs(query(collection(db, "attendance"))),
                    getDocs(query(collection(db, "meal_applications"))),
                    getDocs(query(collection(db, "snacks")))
                ]);

                add(attSnap, 'attendance'); add(mealSnap, 'meal'); add(snackSnap, 'snack');
                
                // ì‹œê°„ ì—­ìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
                records.sort((a,b) => b.ts - a.ts);

                tbody.innerHTML = records.length ? "" : "<tr><td colspan='3'>ê¸°ë¡ ì—†ìŒ</td></tr>";
                records.forEach(r => tbody.innerHTML += `<tr>
                    <td>${r.name} <span style="font-size:12px;color:#888;">(${r.birth})</span></td>
                    <td>${r.date}</td>
                    <td>${r.act}</td>
                </tr>`);
            } catch(e) { console.error(e); }
            showLoading(false);
        };

        // --- Tab 4: ê´‘ê³  ì„¤ì • ---
        window.loadAds = async () => {
            try {
                const docSnap = await getDoc(doc(db, "settings", "ads"));
                if(docSnap.exists()) {
                    const d = docSnap.data();
                    document.getElementById('ad1Img').value = d.ad1_img || "";
                    document.getElementById('ad1Link').value = d.ad1_link || "";
                    document.getElementById('ad2Img').value = d.ad2_img || "";
                    document.getElementById('ad2Link').value = d.ad2_link || "";
                    document.getElementById('ad3Img').value = d.ad3_img || "";
                    document.getElementById('ad3Link').value = d.ad3_link || "";
                }
            } catch(e) {}
        };

        window.saveAds = async () => {
            const data = {
                ad1_img: document.getElementById('ad1Img').value,
                ad1_link: document.getElementById('ad1Link').value,
                ad2_img: document.getElementById('ad2Img').value,
                ad2_link: document.getElementById('ad2Link').value,
                ad3_img: document.getElementById('ad3Img').value,
                ad3_link: document.getElementById('ad3Link').value
            };
            await setDoc(doc(db, "settings", "ads"), data);
            Swal.fire("ì €ì¥ ì™„ë£Œ", "í‚¤ì˜¤ìŠ¤í¬ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.", "success");
        };

        // --- Tab 5: ê¸°ì´ˆì†Œì–‘êµìœ¡ (ìë™ ë¡œë”©) ---
        window.loadEducationStats = async () => {
            showLoading(true);
            const tbody = document.getElementById('eduBody');
            const searchName = document.getElementById('eduSearchName').value.trim();
            const start = document.getElementById('eduStart').value;
            const end = document.getElementById('eduEnd').value;
            
            try {
                // ì‹œê°„ìˆœ ì •ë ¬ (timestamp desc)
                const q = query(collection(db, "education_records"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                let records = [];
                
                querySnapshot.forEach(doc => {
                    const d = doc.data();
                    if (d.date < start || d.date > end) return;
                    if (searchName && !d.student_name.includes(searchName)) return;
                    records.push(d);
                });

                tbody.innerHTML = "";
                if (records.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='5'>ì¡°íšŒëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                } else {
                    records.forEach(d => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${d.date}</td>
                                <td>${d.student_name}</td>
                                <td>${d.student_birth || '-'}</td>
                                <td><span class="badge badge-blue">${d.category}</span></td>
                                <td style="text-align:left; padding-left:15px;">${d.video_title}</td>
                            </tr>
                        `;
                    });
                }
            } catch(e) { console.error(e); tbody.innerHTML = "<tr><td colspan='5'>ë¡œë”© ì‹¤íŒ¨</td></tr>"; }
            showLoading(false);
        };

        // --- ê¸°íƒ€ ìœ í‹¸ ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.table-box').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            
            const idx = ['users','settlement','records','ads','education'].indexOf(tabName);
            if(idx>=0) document.querySelectorAll('.tab-btn')[idx].classList.add('active');
            
            if(tabName==='users') loadAllUsersAndApps();
            if(tabName==='settlement') loadSettlementData();
            if(tabName==='records') loadRecords();
            if(tabName==='ads') loadAds();
            if(tabName==='education') loadEducationStats(); 
        };
        window.refreshData = () => { 
            const activeTabBtn = document.querySelector('.tab-btn.active');
            if (activeTabBtn) {
                const idx = Array.from(document.querySelectorAll('.tab-btn')).indexOf(activeTabBtn);
                if (idx === 0) loadAllUsersAndApps();
                if (idx === 1) loadSettlementData();
                if (idx === 2) loadRecords();
                if (idx === 3) loadAds();
                if (idx === 4) loadEducationStats();
                
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
                Toast.fire({ icon: 'success', title: 'ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ' });
            }
        };
        window.viewPw = (pw) => Swal.fire('ë¹„ë°€ë²ˆí˜¸', pw, 'info');
        window.changePw = async (userId) => { /* ê¸°ì¡´ ìœ ì§€ */ };
        window.deleteUser = async (userId, name) => { /* ê¸°ì¡´ ìœ ì§€ */ };
        window.registerThisDevice = () => { /* ê¸°ì¡´ ìœ ì§€ */ };
        window.unregisterThisDevice = () => { /* ê¸°ì¡´ ìœ ì§€ */ };
        window.downloadTableAsExcel = (id, name) => { const wb = XLSX.utils.table_to_book(document.getElementById(id)); XLSX.writeFile(wb, name + ".xlsx"); };
        window.generateSettlementPDF = () => { alert("ê¸°ëŠ¥ ì¤€ë¹„ì¤‘"); };
        window.generateRecordPDF = () => { alert("ê¸°ëŠ¥ ì¤€ë¹„ì¤‘"); };

    </script>
</body>
</html>
