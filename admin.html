<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        body { font-family: 'Pretendard', sans-serif; background-color: #f5f7fa; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; display: flex; justify-content: space-between; align-items: center; }
        .refresh-btn { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 15px; }
        .tab-btn { padding: 12px 25px; border: none; background: #eee; border-radius: 20px; cursor: pointer; font-weight: bold; color: #666; font-size: 15px; transition: 0.2s; }
        .tab-btn.active { background: #333; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        .table-box { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        /* í…Œì´ë¸” ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background-color: #f1f3f5; color: #333; font-weight: bold; }
        tr:hover { background-color: #f9f9f9; }
        .btn-small { padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; cursor: pointer; background: white; font-size: 12px; font-weight: bold; margin: 0 2px; }
        .btn-blue { background: #2196F3; color: white; border: none; }
        .btn-red { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }
        .btn-green { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .btn-gray { background: #757575; color: white; border: none; }
        .btn-excel { background: #217346; color: white; border: none; }
        .btn-pdf { background: #b71c1c; color: white; border: none; }
        .store-toggles { display: flex; gap: 4px; justify-content: center; }
        .toggle-btn { padding: 6px 8px; border: 1px solid #ddd; background: #f9f9f9; color: #ccc; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .toggle-btn:hover { background: #eee; }
        .toggle-btn.active-dalin { background: #fff8e1; color: #ff6f00; border-color: #ffca28; box-shadow: 0 0 5px #ffca28; }
        .toggle-btn.active-mystery { background: #f3e5f5; color: #7b1fa2; border-color: #ce93d8; box-shadow: 0 0 5px #ce93d8; }
        .toggle-btn.active-yeon { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; box-shadow: 0 0 5px #a5d6a7; }
        .filter-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; background: #fafafa; padding: 15px; border-radius: 8px; }
        input[type="date"], select, input[type="text"] { padding: 8px; border-radius: 6px; border: 1px solid #ddd; }
        .summary-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-around; font-weight: bold; color: #0D47A1; }
        .completed-box { display: flex; align-items: center; justify-content: center; gap: 5px; }
        .completed-text { font-weight: bold; color: #4CAF50; background: #E8F5E9; padding: 5px 10px; border-radius: 15px; font-size: 12px; border: 1px solid #A5D6A7; }
        
        /* [ì¶”ê°€] ê´‘ê³  ê´€ë¦¬ìš© ìŠ¤íƒ€ì¼ */
        .ad-setting-box { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .ad-card { background: #fafafa; padding: 20px; border-radius: 10px; border: 1px solid #ddd; }
        .ad-card h3 { margin-top: 0; color: #333; }
        .input-block { margin-bottom: 15px; }
        .input-block label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .input-block input { width: 95%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
        .btn-save { width: 100%; padding: 15px; background: #333; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .btn-save:hover { background: #555; }

        /* PDF ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ìœ ì§€) */
        #hidden-print-zone { position: absolute; top: -9999px; left: -9999px; width: 210mm; background: white; padding: 20mm; box-sizing: border-box; }
        .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .report-title { font-size: 24px; font-weight: bold; margin: 0 0 10px 0; }
        .report-summary { border: 2px solid #333; background: #f8f9fa; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-between; font-weight: bold; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .report-table th, .report-table td { border: 1px solid #999; padding: 8px; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>
        <span>ğŸ“‹ ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</span>
        <button class="refresh-btn" onclick="location.reload()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('users')">1. ì „ì²´ ì²­ì†Œë…„ & ê¸‰ì‹ê´€ë¦¬</button>
        <button class="tab-btn" onclick="switchTab('settlement')">2. ì •ì‚° ê´€ë¦¬</button>
        <button class="tab-btn" onclick="switchTab('records')">3. í†µí•© ê¸°ë¡</button>
        <button class="tab-btn" onclick="switchTab('ads')">4. ê´‘ê³  ê´€ë¦¬</button>
    </div>

    <div id="tab-users" class="table-box">
        <div style="margin-bottom: 10px; color:#555; font-size:14px;">ğŸ“¢ <strong>ì˜¤ëŠ˜({today})</strong> ê¸°ì¤€ ì „ì²´ í•™ìƒ ë¦¬ìŠ¤íŠ¸</div>
        <table>
            <thead><tr><th width="15%">ì´ë¦„</th><th width="15%">ìƒíƒœ</th><th width="35%">ìŠ¹ì¸/ë³€ê²½</th><th width="25%">ê³„ì •</th><th width="10%">ì‚­ì œ</th></tr></thead>
            <tbody id="userTableBody"><tr><td colspan="5">ë¡œë”© ì¤‘...</td></tr></tbody>
        </table>
    </div>

    <div id="tab-settlement" class="table-box" style="display:none;">
        <div class="filter-bar">
            <label>ê¸°ê°„:</label><input type="date" id="settleStart"> ~ <input type="date" id="settleEnd">
            <label>ì—…ì²´:</label><select id="settleStore"><option value="all">ì „ì²´</option><option value="ë‹¬ì¸ë³´ìŒˆ">ë‹¬ì¸ë³´ìŒˆ</option><option value="ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹">ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹</option><option value="ì—°ê¹€ë°¥">ì—°ê¹€ë°¥</option></select>
            <label>ìƒíƒœ:</label><select id="settleStatus"><option value="all">ì „ì²´</option><option value="no">âŒ ë¯¸ì •ì‚°</option><option value="yes">âœ… ì •ì‚°ì™„ë£Œ</option></select>
            <button class="btn-small btn-blue" onclick="loadSettlementData()">ì¡°íšŒ</button>
            <button class="btn-small btn-excel" onclick="downloadTableAsExcel('settleTable', 'ì •ì‚°ë‚´ì—­')">ì—‘ì…€</button>
            <button class="btn-small btn-pdf" onclick="generateSettlementPDF()">PDF</button>
        </div>
        <div class="summary-box"><span>ì´ ê±´ìˆ˜: <span id="sumCount">0</span></span><span>ì´ ê¸ˆì•¡: <span id="sumPrice">0</span></span><span style="color:#d32f2f">ë¯¸ì •ì‚°: <span id="sumUnpaid">0</span></span></div>
        <table id="settleTable"><thead><tr><th>ë‚ ì§œ</th><th>ì´ë¦„</th><th>ì—…ì²´</th><th>ê¸ˆì•¡</th><th>ê´€ë¦¬</th></tr></thead><tbody id="settleBody"></tbody></table>
    </div>

    <div id="tab-records" class="table-box" style="display:none;">
        <div class="filter-bar">
            <label>ê¸°ê°„:</label><input type="date" id="recStart"> ~ <input type="date" id="recEnd">
            <label>í™œë™:</label><select id="recActivity" style="width:150px;"><option value="">ì „ì²´</option><option value="ê¸°ì´ˆì†Œì–‘êµìœ¡">ê¸°ì´ˆì†Œì–‘</option><option value="í”„ë¡œê·¸ë¨">í”„ë¡œê·¸ë¨</option><option value="ìŠ¤í„°ë””ì¹´í˜">ìŠ¤í„°ë””</option></select>
            <button class="btn-small btn-blue" onclick="loadRecords()">ì¡°íšŒ</button>
            <button class="btn-small btn-excel" onclick="downloadTableAsExcel('recordTable', 'í™œë™ê¸°ë¡')">ì—‘ì…€</button>
            <button class="btn-small btn-pdf" onclick="generateRecordPDF()">PDF</button>
        </div>
        <table id="recordTable"><thead><tr><th>ì´ë¦„</th><th>ì¼ì</th><th>í™œë™</th></tr></thead><tbody id="recBody"></tbody></table>
    </div>

    <div id="tab-ads" class="table-box" style="display:none;">
        <h2>ğŸ“¢ í‚¤ì˜¤ìŠ¤í¬ ê´‘ê³  ë°°ë„ˆ ì„¤ì •</h2>
        <div class="ad-setting-box">
            <div class="ad-card">
                <h3>ê´‘ê³  1 (ì™¼ìª½)</h3>
                <div class="input-block">
                    <label>ì´ë¯¸ì§€ ì£¼ì†Œ (URL)</label>
                    <input type="text" id="ad1Img" placeholder="https://...">
                </div>
                <div class="input-block">
                    <label>í´ë¦­ ì‹œ ì´ë™í•  ë§í¬</label>
                    <input type="text" id="ad1Link" placeholder="https://...">
                </div>
            </div>
            
            <div class="ad-card">
                <h3>ê´‘ê³  2 (ì˜¤ë¥¸ìª½)</h3>
                <div class="input-block">
                    <label>ì´ë¯¸ì§€ ì£¼ì†Œ (URL)</label>
                    <input type="text" id="ad2Img" placeholder="https://...">
                </div>
                <div class="input-block">
                    <label>í´ë¦­ ì‹œ ì´ë™í•  ë§í¬</label>
                    <input type="text" id="ad2Link" placeholder="https://...">
                </div>
            </div>
        </div>
        <button class="btn-save" onclick="saveAds()">ì„¤ì • ì €ì¥ ë° ì¦‰ì‹œ ë°˜ì˜</button>
    </div>

</div>

<div id="hidden-print-zone"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, getDoc, setDoc, query, where, orderBy, updateDoc, addDoc, deleteDoc, doc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAalHhoEK-ko55Jep-7k8ULHeaWWU99oh8",
      authDomain: "dream-meal-support.firebaseapp.com",
      projectId: "dream-meal-support",
      storageBucket: "dream-meal-support.firebasestorage.app",
      messagingSenderId: "230720243044",
      appId: "1:230720243044:web:eb38ecc28353a1c70aa671"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ADMIN_PW = "1388"; 

    // ë‚ ì§œ í•¨ìˆ˜ ë“± ê¸°ì¡´ ìœ í‹¸ë¦¬í‹°
    const getTodayStr = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    window.onload = async () => {
        const inputPw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(inputPw !== ADMIN_PW) { document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px; color:red;'>â›” ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</h2>"; return; }

        const todayStr = getTodayStr();
        const monthAgo = new Date(); monthAgo.setMonth(monthAgo.getMonth() - 1);
        const monthAgoStr = monthAgo.toISOString().split('T')[0];

        document.body.innerHTML = document.body.innerHTML.replace("{today}", todayStr);
        document.getElementById('settleStart').value = monthAgoStr;
        document.getElementById('settleEnd').value = todayStr;
        document.getElementById('recStart').value = monthAgoStr;
        document.getElementById('recEnd').value = todayStr;

        loadAllUsersAndApps(); 
    };

    // --- íƒ­ ì „í™˜ ---
    window.switchTab = (tabName) => {
        document.querySelectorAll('.table-box').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).style.display = 'block';
        event.target.classList.add('active');
        
        if(tabName === 'users') loadAllUsersAndApps();
        if(tabName === 'ads') loadAds(); // [ì¶”ê°€] ê´‘ê³  íƒ­ ëˆ„ë¥´ë©´ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    };

    // ============================================================
    // [ì‹ ê·œ] TAB 4: ê´‘ê³  ê´€ë¦¬ ë¡œì§
    // ============================================================
    
    // 1. ê´‘ê³  ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
    window.loadAds = async () => {
        try {
            // 'settings' ì»¬ë ‰ì…˜ì˜ 'ads' ë¬¸ì„œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            const docRef = doc(db, "settings", "ads");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('ad1Img').value = data.ad1_img || "";
                document.getElementById('ad1Link').value = data.ad1_link || "";
                document.getElementById('ad2Img').value = data.ad2_img || "";
                document.getElementById('ad2Link').value = data.ad2_link || "";
            }
        } catch(e) {
            console.error("ê´‘ê³  ë¡œë”© ì‹¤íŒ¨:", e);
        }
    };

    // 2. ê´‘ê³  ì„¤ì • ì €ì¥í•˜ê¸°
    window.saveAds = async () => {
        const ad1_img = document.getElementById('ad1Img').value;
        const ad1_link = document.getElementById('ad1Link').value;
        const ad2_img = document.getElementById('ad2Img').value;
        const ad2_link = document.getElementById('ad2Link').value;

        try {
            // 'settings' ì»¬ë ‰ì…˜ì˜ 'ads' ë¬¸ì„œì— ì €ì¥ (ì—†ìœ¼ë©´ ìƒì„±)
            await setDoc(doc(db, "settings", "ads"), {
                ad1_img, ad1_link, ad2_img, ad2_link,
                updatedAt: Timestamp.now()
            }, { merge: true }); // ê¸°ì¡´ ë°ì´í„° ìœ ì§€í•˜ë©° ì—…ë°ì´íŠ¸

            alert("ê´‘ê³  ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\ní‚¤ì˜¤ìŠ¤í¬ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ë°˜ì˜ë©ë‹ˆë‹¤.");
        } catch(e) {
            console.error(e);
            alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        }
    };

    // (ì´í•˜ ê¸°ì¡´ íƒ­1, 2, 3 ë¡œì§ë“¤... ê·¸ëŒ€ë¡œ ìœ ì§€)
    // loadAllUsersAndApps, changeStore, forceApprove, resetApp
    // viewPw, changePw, deleteUser
    // loadSettlementData, toggleSettle
    // loadRecords
    // generateSettlementPDF, generateRecordPDF, downloadTableAsExcel
    // ì§€ë©´ìƒ ìƒëµí•˜ì§€ë§Œ, ì‹¤ì œë¡œëŠ” ìœ„ìª½ ì½”ë“œ ë¸”ë¡ì—ì„œ ì‘ì„±í–ˆë˜ ë‚´ìš©ì´ ì—¬ê¸°ì— ë‹¤ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
    
    // ... [ì´ì „ ë‹µë³€ì˜ admin.html í•˜ë‹¨ ìŠ¤í¬ë¦½íŠ¸ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê¸°] ...
    
    // í¸ì˜ë¥¼ ìœ„í•´ í•µì‹¬ í•¨ìˆ˜ë§Œ ë‹¤ì‹œ ì •ì˜í•©ë‹ˆë‹¤ (ì‹¤ì œ ì ìš©ì‹œì—” ì´ì „ ì½”ë“œ ë‚´ìš© ê¼­ í¬í•¨í•˜ì„¸ìš”!)
    window.loadAllUsersAndApps = async () => { /* ... ì´ì „ ì½”ë“œì™€ ë™ì¼ ... */ 
        const today = getTodayStr(); const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = "<tr><td colspan='5'>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>";
        /* (ì¤‘ë³µ ìƒëµ: ì´ì „ ë‹µë³€ì˜ loadAllUsersAndApps ë¡œì§ ì „ì²´ ì‚¬ìš©) */
        // ì—¬ê¸°ì„œëŠ” ìƒëµí–ˆì§€ë§Œ ì‹¤ì œ íŒŒì¼ì—” ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        try {
            const userSnap = await getDocs(query(collection(db, "users"), orderBy("name")));
            const appSnap = await getDocs(query(collection(db, "meal_applications"), where("date", "==", today)));
            let appsMap = {};
            appSnap.forEach(doc => { const d = doc.data(); if(!appsMap[d.student_id]) appsMap[d.student_id]=[]; appsMap[d.student_id].push({ docId: doc.id, ...d }); });
            tbody.innerHTML = "";
            if(userSnap.empty) { tbody.innerHTML = "<tr><td colspan='5'>ê°€ì…ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; return; }
            userSnap.forEach(userDoc => {
                const u = userDoc.data(); const userId = userDoc.id; const studentApps = appsMap[userId] || [];
                let activeApp = studentApps.find(app => app.status === 'applied' || app.status === 'approved');
                let completedCount = studentApps.filter(app => app.status === 'completed').length;
                let statusText = `<span style="color:#aaa">ë¯¸ì‹ ì²­</span>`; let buttonsHtml = '';
                let countBadge = completedCount > 0 ? `<span style="font-size:11px; background:#eee; padding:2px 6px; border-radius:10px;">(${completedCount}íšŒ ì™„ë£Œ)</span>` : '';
                if (activeApp) {
                    const store = activeApp.store_name; const status = activeApp.status; const appId = activeApp.docId;
                    if(status === 'applied') statusText = `<span style="color:#2196F3; font-weight:bold">${store} (ì‹ ì²­)</span>`;
                    else statusText = `<span style="color:#FF9800; font-weight:bold">${store} (ìŠ¹ì¸ë¨)</span>`;
                    statusText += " " + countBadge;
                    const cD = store === 'ë‹¬ì¸ë³´ìŒˆ' ? 'active-dalin' : ''; const cM = store === 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹' ? 'active-mystery' : ''; const cY = store === 'ì—°ê¹€ë°¥' ? 'active-yeon' : '';
                    buttonsHtml = `<div class="store-toggles"><button class="toggle-btn ${cD}" onclick="changeStore('${appId}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button><button class="toggle-btn ${cM}" onclick="changeStore('${appId}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button><button class="toggle-btn ${cY}" onclick="changeStore('${appId}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button></div>`;
                } else {
                    if(completedCount > 0) statusText = `<span style="color:#4CAF50; font-weight:bold">ì‹ì‚¬ ì™„ë£Œ</span> ` + countBadge;
                    else statusText = `<span style="color:#aaa">ë¯¸ì‹ ì²­</span>`;
                    buttonsHtml = `<div class="store-toggles"><button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button><button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button><button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button></div>`;
                }
                tbody.innerHTML += `<tr><td><div style="font-weight:bold;">${u.name}</div><div style="font-size:12px; color:#888;">${u.birth}</div></td><td>${statusText}</td><td>${buttonsHtml}</td><td><button class="btn-small" onclick="viewPw('${u.password}')">ë¹„ë²ˆ</button><button class="btn-small btn-blue" onclick="changePw('${userId}', '${u.name}')">ë³€ê²½</button></td><td><button class="btn-small btn-red" onclick="deleteUser('${userId}', '${u.name}')">ì‚­ì œ</button></td></tr>`;
            });
        } catch(e) { console.error(e); }
    };
    
    // (ê¸°ëŠ¥ í•¨ìˆ˜ë“¤ ì¬ì„ ì–¸)
    window.changeStore = async (docId, newStore) => { if(!confirm(`[${newStore}]ë¡œ ë³€ê²½?`)) return; await updateDoc(doc(db, "meal_applications", docId), { store_name: newStore, status: "approved" }); loadAllUsersAndApps(); };
    window.forceApprove = async (userId, userName, storeName) => { if(!confirm(`[${userName}] -> [${storeName}] ìŠ¹ì¸?`)) return; const today = getTodayStr(); await addDoc(collection(db, "meal_applications"), { student_id: userId, student_name: userName, store_name: storeName, status: "approved", date: today, activity: "ê¸°ì´ˆì†Œì–‘êµìœ¡", timestamp: Timestamp.now() }); loadAllUsersAndApps(); };
    window.resetApp = async (docId) => { if(!confirm("ë¦¬ì…‹í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; await updateDoc(doc(db, "meal_applications", docId), { status: "approved", amount: 0, used_at: null, is_settled: false }); loadAllUsersAndApps(); };
    window.viewPw = (pw) => alert(`ë¹„ë°€ë²ˆí˜¸: ${pw}`);
    window.changePw = async (userId, name) => { const np = prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸:"); if(np) { await updateDoc(doc(db, "users", userId), { password: np }); alert("ë³€ê²½ì™„ë£Œ"); } };
    window.deleteUser = async (userId, name) => { if(prompt("ê´€ë¦¬ì ì•”í˜¸(1388):") === ADMIN_PW && confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) { await deleteDoc(doc(db, "users", userId)); alert("ì‚­ì œì™„ë£Œ"); loadAllUsersAndApps(); }};
    window.loadSettlementData = async () => { /* ì´ì „ ì½”ë“œì™€ ë™ì¼ */ const start = document.getElementById('settleStart').value; const end = document.getElementById('settleEnd').value; const targetStore = document.getElementById('settleStore').value; const targetStatus = document.getElementById('settleStatus').value; const tbody = document.getElementById('settleBody'); tbody.innerHTML = "<tr><td colspan='5'>ì¡°íšŒ ì¤‘...</td></tr>"; let userMap = {}; const uSnap = await getDocs(collection(db, "users")); uSnap.forEach(d => userMap[d.id] = d.data()); const snap = await getDocs(query(collection(db, "meal_applications"), orderBy("date", "desc"))); let list = []; let totalCnt = 0; let totalPrice = 0; let totalUnpaid = 0; snap.forEach(doc => { const d = doc.data(); if(d.date < start || d.date > end) return; if(targetStore !== 'all' && d.store_name !== targetStore) return; const isSettled = d.is_settled === true; if(targetStatus === 'no' && isSettled) return; if(targetStatus === 'yes' && !isSettled) return; const price = d.amount ? Number(d.amount) : 0; if(price === 0) return; const u = userMap[d.student_id] || {name: d.student_name, birth: ''}; totalCnt++; totalPrice += price; if(!isSettled) totalUnpaid += price; list.push({ id: doc.id, ...d, price, isSettled, uName: u.name, uBirth: u.birth }); }); document.getElementById('sumCount').innerText = totalCnt; document.getElementById('sumPrice').innerText = totalPrice.toLocaleString(); document.getElementById('sumUnpaid').innerText = totalUnpaid.toLocaleString(); tbody.innerHTML = ""; if(list.length === 0) { tbody.innerHTML = "<tr><td colspan='5'>ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; return; } list.forEach(item => { const statusHtml = item.isSettled ? `<span class="btn-green btn-small" onclick="toggleSettle('${item.id}', false)">âœ… ì •ì‚°ì™„ë£Œ</span>` : `<span class="btn-red btn-small" onclick="toggleSettle('${item.id}', true)">âŒ ë¯¸ì •ì‚°</span>`; tbody.innerHTML += `<tr><td>${item.date}</td><td>${item.uName} (${item.uBirth})</td><td>${item.store_name}</td><td>${item.price.toLocaleString()}ì›</td><td>${statusHtml}</td></tr>`; }); };
    window.toggleSettle = async (id, state) => { if(confirm("ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await updateDoc(doc(db, "meal_applications", id), { is_settled: state }); loadSettlementData(); }};
    window.loadRecords = async () => { /* ì´ì „ ì½”ë“œì™€ ë™ì¼ */ const start = document.getElementById('recStart').value; const end = document.getElementById('recEnd').value; const selectedActivity = document.getElementById('recActivity').value; const tbody = document.getElementById('recBody'); tbody.innerHTML = "<tr><td colspan='3'>ì²˜ë¦¬ ì¤‘...</td></tr>"; let userMap = {}; const uSnap = await getDocs(collection(db, "users")); uSnap.forEach(d => userMap[d.id] = d.data()); let dailyRecordMap = {}; const process = (doc, type, priority) => { const d = doc.data(); if(d.date < start || d.date > end) return; const u = userMap[d.student_id] || {name: d.student_name, birth: ''}; let act = d.activity || (type === 'meal' ? d.store_name+"(ì‹ì‚¬)" : "ê°„ì‹"); if(selectedActivity && act !== selectedActivity) return; const key = `${d.date}_${d.student_id}`; if (!dailyRecordMap[key] || dailyRecordMap[key].priority < priority) { dailyRecordMap[key] = { priority: priority, date: d.date, name: `${u.name} (${u.birth})`, activity: act, sortName: u.name }; } }; const attSnap = await getDocs(query(collection(db, "attendance"), orderBy("date", "desc"))); attSnap.forEach(doc => process(doc, "attendance", 3)); const mealSnap = await getDocs(query(collection(db, "meal_applications"), orderBy("date", "desc"))); mealSnap.forEach(doc => process(doc, "meal", 2)); const snackSnap = await getDocs(query(collection(db, "snacks"), orderBy("date", "desc"))); snackSnap.forEach(doc => process(doc, "snack", 1)); let finalRecords = Object.values(dailyRecordMap); finalRecords.sort((a, b) => b.date.localeCompare(a.date) || a.sortName.localeCompare(b.sortName)); tbody.innerHTML = ""; if(finalRecords.length === 0) { tbody.innerHTML = "<tr><td colspan='3'>ê¸°ë¡ ì—†ìŒ</td></tr>"; return; } finalRecords.forEach(r => tbody.innerHTML += `<tr><td>${r.name}</td><td>${r.date}</td><td>${r.activity}</td></tr>`); };
    window.generateSettlementPDF = () => { /* ìƒëµ */ const zone = document.getElementById('hidden-print-zone'); const start = document.getElementById('settleStart').value; const end = document.getElementById('settleEnd').value; const store = document.getElementById('settleStore').options[document.getElementById('settleStore').selectedIndex].text; const count = document.getElementById('sumCount').innerText; const price = document.getElementById('sumPrice').innerText; const unpaid = document.getElementById('sumUnpaid').innerText; const originalTable = document.getElementById('settleTable').cloneNode(true); originalTable.className = "report-table"; zone.innerHTML = `<div class="report-header"><h1 class="report-title">ê¸‰ì‹ ì •ì‚° ë‚´ì—­ì„œ</h1><div class="report-info">ì¡°íšŒ ê¸°ê°„: ${start} ~ ${end} <br>ëŒ€ìƒ ì—…ì²´: ${store}</div></div><div class="report-summary"><div>ì´ ì‹ ì²­: ${count}ê±´</div><div>ì´ í•©ê³„: ${price}ì›</div><div style="color:red">ë¯¸ì •ì‚° ì”ì•¡: ${unpaid}ì›</div></div>`; zone.appendChild(originalTable); downloadPDFFromElement(zone, `ì •ì‚°ë‚´ì—­ì„œ_${start}_${store}`); };
    window.generateRecordPDF = () => { /* ìƒëµ */ const zone = document.getElementById('hidden-print-zone'); const start = document.getElementById('recStart').value; const end = document.getElementById('recEnd').value; const act = document.getElementById('recActivity').value || "ì „ì²´ í™œë™"; const originalTable = document.getElementById('recordTable').cloneNode(true); originalTable.className = "report-table"; zone.innerHTML = `<div class="report-header"><h1 class="report-title">ì²­ì†Œë…„ í†µí•© í™œë™ ê¸°ë¡ë¶€</h1><div class="report-info">ì¡°íšŒ ê¸°ê°„: ${start} ~ ${end} <br>ì„ íƒ í™œë™: ${act}</div></div>`; zone.appendChild(originalTable); downloadPDFFromElement(zone, `í™œë™ê¸°ë¡ë¶€_${start}`); };
    function downloadPDFFromElement(element, fileName) { html2canvas(element, { scale: 2 }).then(canvas => { const imgData = canvas.toDataURL('image/png'); const pdf = new jspdf.jsPDF('p', 'mm', 'a4'); const imgWidth = 210; const pageHeight = 297; const imgHeight = canvas.height * imgWidth / canvas.width; let heightLeft = imgHeight; let position = 0; pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= pageHeight; while (heightLeft >= 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= pageHeight; } pdf.save(fileName + ".pdf"); element.innerHTML = ""; }); }
    window.downloadTableAsExcel = (id, name) => { const wb = XLSX.utils.table_to_book(document.getElementById(id)); XLSX.writeFile(wb, name + ".xlsx"); };
</script>

</body>
</html>
