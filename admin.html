<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        
        .glass-container { 
            max-width: 1200px; margin: 0 auto; padding: 30px; 
            background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);
        }
        
        h1 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; color: #2d3436; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        
        .refresh-btn { 
            background: #fff; border: 1px solid #ddd; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 18px; 
        }
        .refresh-btn:hover { background: #f8f9fa; transform: rotate(180deg); }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; background: #f1f3f5; padding: 5px; border-radius: 12px; flex-wrap: wrap; }
        .tab-btn { 
            flex: 1; padding: 12px; border: none; background: transparent; border-radius: 8px; 
            cursor: pointer; font-weight: 700; color: #868e96; font-size: 15px; transition: 0.2s; white-space: nowrap; 
        }
        .tab-btn.active { background: white; color: #6C5CE7; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .tab-btn:hover:not(.active) { background: rgba(255, 255, 255, 0.5); }
        
        .table-box { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; font-size: 14px; }
        th { background-color: #f8f9fa; color: #495057; font-weight: 700; padding: 12px; border-bottom: 2px solid #dee2e6; text-align: center; }
        td { padding: 12px; border-bottom: 1px solid #f1f3f5; vertical-align: middle; color: #212529; text-align: center; }
        tr:hover td { background-color: #f8f9fa; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-small { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: bold; margin: 0 2px; transition: 0.2s; }
        .btn-blue { background: #e7f5ff; color: #1c7ed6; } .btn-blue:hover { background: #d0ebff; }
        .btn-red { background: #fff5f5; color: #fa5252; } .btn-red:hover { background: #ffe3e3; }
        .btn-green { background: #ebfbee; color: #2f9e44; } .btn-green:hover { background: #d3f9d8; }
        .btn-dark { background: #343a40; color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: bold; border:none; cursor: pointer; }
        .btn-dark:hover { background: #212529; }

        /* ìƒíƒœ ë±ƒì§€ */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-blue { background: #e7f5ff; color: #1971c2; }
        .badge-green { background: #ebfbee; color: #2f9e44; }

        .store-toggles { display: flex; gap: 4px; justify-content: center; }
        .toggle-btn { padding: 6px 10px; border: 1px solid #dee2e6; background: white; color: #adb5bd; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.2s; }
        .toggle-btn:hover { background: #f8f9fa; }
        .active-dalin { background: #fff9db; color: #f08c00; border-color: #fcc419; }
        .active-mystery { background: #f3d9fa; color: #be4bdb; border-color: #e599f7; }
        .active-yeon { background: #e6fcf5; color: #0ca678; border-color: #63e6be; }
        
        .filter-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; background: #f8f9fa; padding: 15px; border-radius: 12px; }
        .filter-bar label { font-size: 14px; font-weight: bold; color: #495057; }
        .filter-bar select, .filter-bar input { border: 1px solid #ced4da; padding: 8px; border-radius: 6px; outline: none; }
        
        .summary-box { background: #e7f5ff; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-around; font-weight: 700; color: #1864ab; }
        
        .ad-setting-box { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .ad-card { background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #dee2e6; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #495057; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; }

        /* ë¡œë”© ì˜¤ë²„ë ˆì´ */
        #loadingOverlay {
            display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999;
            justify-content: center; align-items: center;
        }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid #6C5CE7;
            border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ì¸ì‡„ìš© ìˆ¨ê¹€ ì˜ì—­ */
        #hidden-print-zone {
            position: fixed; top: 0; left: 0; width: 210mm; min-height: 297mm;
            background: white; z-index: -9999; padding: 20mm; box-sizing: border-box;
            opacity: 0; pointer-events: none;
        }
        .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
        .report-title { font-size: 24px; font-weight: bold; margin: 0; color: #000; }
        .report-summary-box { border: 1px solid #000; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-around; font-weight: bold; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .report-table th, .report-table td { border: 1px solid #000; padding: 8px; text-align: center; }
    </style>
</head>

<body>

    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="glass-container">
        <h1>
            <div class="header-left">
                <span>ğŸ“‹ ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</span>
                <button class="btn-dark" onclick="registerThisDevice()" title="ì´ PCë¥¼ í‚¤ì˜¤ìŠ¤í¬ë¡œ ì¸ì¦í•©ë‹ˆë‹¤">ğŸ–¥ï¸ ê¸°ê¸° ë“±ë¡</button>
                <button class="btn-small btn-red" onclick="unregisterThisDevice()" title="ì¸ì¦ í•´ì œ">ğŸš« í•´ì œ</button>
            </div>
            <button class="refresh-btn" onclick="refreshData()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
        </h1>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('users')">1. ì „ì²´ ì²­ì†Œë…„ & ê¸‰ì‹</button>
            <button class="tab-btn" onclick="switchTab('settlement')">2. ì •ì‚° ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchTab('records')">3. í†µí•© ê¸°ë¡</button>
            <button class="tab-btn" onclick="switchTab('ads')">4. ê´‘ê³  ì„¤ì •</button>
            <button class="tab-btn" onclick="switchTab('education')">5. ê¸°ì´ˆì†Œì–‘êµìœ¡</button>
        </div>

        <div id="tab-users" class="table-box">
            <div style="margin-bottom: 10px; color:#555; font-size:14px;">ğŸ“… <strong>ì˜¤ëŠ˜ (<span id="todayDisplay"></span>)</strong> ê¸°ì¤€ ìƒíƒœ</div>
            <table>
                <thead>
                    <tr>
                        <th width="15%">ì´ë¦„</th>
                        <th width="20%">ìƒíƒœ</th>
                        <th width="35%">ìŠ¹ì¸/ë³€ê²½</th>
                        <th width="20%">ê³„ì •</th>
                        <th width="10%">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr><td colspan="5">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="tab-settlement" class="table-box" style="display:none;">
            <div class="filter-bar">
                <label>ê¸°ê°„:</label><input type="date" id="settleStart"> ~ <input type="date" id="settleEnd">
                <label>ì—…ì²´:</label><select id="settleStore">
                    <option value="all">ì „ì²´</option>
                    <option value="ë‹¬ì¸ë³´ìŒˆ">ë‹¬ì¸ë³´ìŒˆ</option>
                    <option value="ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹">ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹</option>
                    <option value="ì—°ê¹€ë°¥">ì—°ê¹€ë°¥</option>
                </select>
                <label>ìƒíƒœ:</label><select id="settleStatus">
                    <option value="all">ì „ì²´</option>
                    <option value="no">âŒ ë¯¸ì •ì‚°</option>
                    <option value="yes">âœ… ì •ì‚°ì™„ë£Œ</option>
                </select>
                <button class="btn-small btn-blue" onclick="loadSettlementData()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('settleTable', 'ì •ì‚°ë‚´ì—­')">ì—‘ì…€</button>
                <button class="btn-small btn-red" onclick="generateSettlementPDF()">PDF</button>
            </div>
            <div class="summary-box">
                <span>ì´ ê±´ìˆ˜: <span id="sumCount">0</span></span>
                <span>ì´ ë§¤ì¶œ: <span id="sumPrice">0</span></span>
                <span style="color:#e03131">ë¯¸ì •ì‚° ì”ì•¡: <span id="sumUnpaid">0</span></span>
            </div>
            <table id="settleTable">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th> <th>ì´ë¦„</th> <th>ì—…ì²´</th> <th>ê¸ˆì•¡</th> <th>ì •ì‚°ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody id="settleBody"></tbody>
            </table>
        </div>

        <div id="tab-records" class="table-box" style="display:none;">
            <div class="filter-bar">
                <label>ê¸°ê°„:</label><input type="date" id="recStart"> ~ <input type="date" id="recEnd">
                <label>í™œë™:</label><select id="recActivity">
                    <option value="">ì „ì²´</option>
                    <option value="ê¸°ì´ˆì†Œì–‘êµìœ¡">ê¸°ì´ˆì†Œì–‘</option>
                    <option value="í”„ë¡œê·¸ë¨">í”„ë¡œê·¸ë¨</option>
                    <option value="ìŠ¤í„°ë””ì¹´í˜">ìŠ¤í„°ë””</option>
                </select>
                <button class="btn-small btn-blue" onclick="loadRecords()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('recordTable', 'í™œë™ê¸°ë¡')">ì—‘ì…€</button>
                <button class="btn-small btn-red" onclick="generateRecordPDF()">PDF</button>
            </div>
            <table id="recordTable">
                <thead>
                    <tr>
                        <th>ì´ë¦„</th> <th>ì¼ì</th> <th>í™œë™ë‚´ì—­</th>
                    </tr>
                </thead>
                <tbody id="recBody"></tbody>
            </table>
        </div>

        <div id="tab-ads" class="table-box" style="display:none;">
            <h2>ğŸ“¢ í‚¤ì˜¤ìŠ¤í¬ ê´‘ê³  ë°°ë„ˆ ì„¤ì •</h2>
            <div class="ad-setting-box">
                <div class="ad-card">
                    <h3>ê´‘ê³  1 (ì™¼ìª½)</h3>
                    <div class="input-group">
                        <label>ì´ë¯¸ì§€ URL</label>
                        <input type="text" id="ad1Img" class="input-field" placeholder="https://...">
                    </div>
                    <div class="input-group">
                        <label>ì´ë™ ë§í¬</label>
                        <input type="text" id="ad1Link" class="input-field" placeholder="https://...">
                    </div>
                </div>
                <div class="ad-card">
                    <h3>ê´‘ê³  2 (ì˜¤ë¥¸ìª½)</h3>
                    <div class="input-group">
                        <label>ì´ë¯¸ì§€ URL</label>
                        <input type="text" id="ad2Img" class="input-field" placeholder="https://...">
                    </div>
                    <div class="input-group">
                        <label>ì´ë™ ë§í¬</label>
                        <input type="text" id="ad2Link" class="input-field" placeholder="https://...">
                    </div>
                </div>
            </div>
            <button class="btn-dark" style="width:100%; margin-top:20px; padding:15px;" onclick="saveAds()">ì„¤ì • ì €ì¥</button>
        </div>

        <div id="tab-education" class="table-box" style="display:none;">
            <div class="filter-bar">
                <label>ì´ë¦„ ê²€ìƒ‰:</label>
                <input type="text" id="eduSearchName" placeholder="ì˜ˆ: í™ê¸¸ë™">
                <button class="btn-small btn-blue" onclick="loadEducationStats()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('eduTable', 'ê¸°ì´ˆì†Œì–‘êµìœ¡_ì´ìˆ˜ëŒ€ì¥')">ì—‘ì…€</button>
            </div>
            <div style="font-size:13px; color:#868e96; margin-bottom:10px;">â„¹ï¸ ì´ë¦„ì„ ë¹„ì›Œë‘ê³  ì¡°íšŒí•˜ë©´ ì „ì²´ ëª©ë¡ì´ ë‚˜ì˜µë‹ˆë‹¤.</div>
            <table id="eduTable">
                <thead>
                    <tr>
                        <th width="15%">ìˆ˜ê°•ì¼ì</th>
                        <th width="15%">ì´ë¦„</th>
                        <th width="15%">ìƒë…„ì›”ì¼</th>
                        <th width="20%">ìˆ˜ê°•ê³¼ëª©</th>
                        <th width="35%">ê°•ì˜ëª…</th>
                    </tr>
                </thead>
                <tbody id="eduBody">
                    <tr><td colspan="5">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
                </tbody>
            </table>
        </div>

    </div>

    <div id="hidden-print-zone"></div>

    <script type="module">
        import { db, collection, getDocs, getDoc, setDoc, query, where, orderBy, updateDoc, addDoc, deleteDoc, doc, Timestamp } from "./js/firebase-config.js";

        const ADMIN_PW = "1388";
        const showLoading = (show) => { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }

        const getTodayStr = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- ì´ˆê¸°í™” ë° ì¸ì¦ ---
        window.onload = async () => {
            const { value: inputPw } = await Swal.fire({
                title: 'ê´€ë¦¬ì ì ‘ì†',
                input: 'password',
                inputPlaceholder: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                allowOutsideClick: false,
                confirmButtonText: 'ì ‘ì†'
            });

            if (inputPw !== ADMIN_PW) {
                document.body.innerHTML = "<div style='display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column;'><h2 style='color:#fa5252;'>â›” ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</h2><button onclick='location.reload()' style='padding:10px 20px; cursor:pointer;'>ë‹¤ì‹œ ì‹œë„</button></div>";
                return;
            }

            // ë‚ ì§œ ì´ˆê¸°ê°’ ì„¤ì •
            const todayStr = getTodayStr();
            const monthAgo = new Date(); monthAgo.setMonth(monthAgo.getMonth() - 1);
            const monthAgoStr = monthAgo.toISOString().split('T')[0];

            document.getElementById('todayDisplay').innerText = todayStr;
            document.getElementById('settleStart').value = monthAgoStr;
            document.getElementById('settleEnd').value = todayStr;
            document.getElementById('recStart').value = monthAgoStr;
            document.getElementById('recEnd').value = todayStr;

            loadAllUsersAndApps();
        };

        // --- ê¸°ê¸° ë“±ë¡/í•´ì œ ---
        window.registerThisDevice = () => {
            if(confirm("ì´ PCë¥¼ í‚¤ì˜¤ìŠ¤í¬ìš© ê¸°ê¸°ë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në“±ë¡ëœ ê¸°ê¸°ì—ì„œë§Œ 'í‚¤ì˜¤ìŠ¤í¬ í™”ë©´' ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.")) {
                localStorage.setItem('kiosk_auth_token', 'dream_center_pc');
                Swal.fire("ë“±ë¡ ì™„ë£Œ", "ì´ì œ ì´ ë¸Œë¼ìš°ì €ì—ì„œ í‚¤ì˜¤ìŠ¤í¬ í™”ë©´ ì ‘ì†ì´ í—ˆìš©ë©ë‹ˆë‹¤.", "success");
            }
        };
        window.unregisterThisDevice = () => {
            if(confirm("ì´ ê¸°ê¸°ì˜ ë“±ë¡ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('kiosk_auth_token');
                Swal.fire("í•´ì œ ì™„ë£Œ", "í‚¤ì˜¤ìŠ¤í¬ ì ‘ì† ê¶Œí•œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
            }
        };

        // --- íƒ­ ì „í™˜ ë¡œì§ ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.table-box').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).style.display = 'block';

            // ë²„íŠ¼ í™œì„±í™” ì²˜ë¦¬ (ì¸ë±ìŠ¤ ë§¤í•‘)
            const map = { 'users': 0, 'settlement': 1, 'records': 2, 'ads': 3, 'education': 4 };
            document.querySelectorAll('.tab-btn')[map[tabName]].classList.add('active');

            if (tabName === 'users') loadAllUsersAndApps();
            if (tabName === 'ads') loadAds();
            if (tabName === 'education') loadEducationStats();
        };

        window.refreshData = () => {
            // í˜„ì¬ í™œì„± íƒ­ì— ë”°ë¼ ìƒˆë¡œê³ ì¹¨
            if (document.getElementById('tab-users').style.display !== 'none') loadAllUsersAndApps();
            else if (document.getElementById('tab-settlement').style.display !== 'none') loadSettlementData();
            else if (document.getElementById('tab-records').style.display !== 'none') loadRecords();
            else if (document.getElementById('tab-ads').style.display !== 'none') loadAds();
            else if (document.getElementById('tab-education').style.display !== 'none') loadEducationStats();
            
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
            Toast.fire({ icon: 'success', title: 'ë°ì´í„° ê°±ì‹ ë¨' });
        };

        // --- [TAB 1] ì „ì²´ íšŒì› & ê¸‰ì‹ ê´€ë¦¬ ---
        window.loadAllUsersAndApps = async () => {
            showLoading(true);
            const today = getTodayStr();
            const tbody = document.getElementById('userTableBody');
            
            try {
                const userSnap = await getDocs(query(collection(db, "users"), orderBy("name")));
                const appSnap = await getDocs(query(collection(db, "meal_applications"), where("date", "==", today)));

                let appsMap = {};
                appSnap.forEach(doc => {
                    const d = doc.data();
                    if (!appsMap[d.student_id]) appsMap[d.student_id] = [];
                    appsMap[d.student_id].push({ docId: doc.id, ...d });
                });

                tbody.innerHTML = "";
                if (userSnap.empty) { 
                    tbody.innerHTML = "<tr><td colspan='5'>ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; 
                    showLoading(false); return; 
                }

                userSnap.forEach(userDoc => {
                    const u = userDoc.data();
                    const userId = userDoc.id;
                    const studentApps = appsMap[userId] || [];

                    // ì§„í–‰ ì¤‘ì¸ ì‹ ì²­(ìŠ¹ì¸ or ì‹ ì²­) ì°¾ê¸°
                    let activeApp = studentApps.find(app => app.status === 'applied' || app.status === 'approved');
                    let completedCount = studentApps.filter(app => app.status === 'completed').length;

                    let statusText = `<span style="color:#adb5bd; font-size:12px;">-</span>`;
                    let buttonsHtml = '';
                    
                    if (activeApp) {
                        const store = activeApp.store_name;
                        const status = activeApp.status;
                        const appId = activeApp.docId;

                        if (status === 'applied') statusText = `<span class="badge badge-blue">${store} (ì‹ ì²­)</span>`;
                        else statusText = `<span class="badge badge-green" style="background:#fff9db; color:#f08c00;">${store} (ìŠ¹ì¸)</span>`;

                        // í˜„ì¬ ì„ íƒëœ ê°€ê²Œ ìŠ¤íƒ€ì¼ ì ìš©
                        const cD = store === 'ë‹¬ì¸ë³´ìŒˆ' ? 'active-dalin' : '';
                        const cM = store === 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹' ? 'active-mystery' : '';
                        const cY = store === 'ì—°ê¹€ë°¥' ? 'active-yeon' : '';

                        buttonsHtml = `
                            <div class="store-toggles">
                                <button class="toggle-btn ${cD}" onclick="changeStore('${appId}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button>
                                <button class="toggle-btn ${cM}" onclick="changeStore('${appId}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
                                <button class="toggle-btn ${cY}" onclick="changeStore('${appId}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
                            </div>`;
                    } else {
                        buttonsHtml = `
                            <div class="store-toggles">
                                <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button>
                                <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
                                <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
                            </div>`;
                        if (completedCount > 0) statusText = `<span class="badge badge-green">ì‹ì‚¬ ì™„ë£Œ (${completedCount})</span>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td><div style="font-weight:bold;">${u.name}</div><div style="font-size:12px; color:#868e96;">${u.birth}</div></td>
                            <td>${statusText}</td>
                            <td>${buttonsHtml}</td>
                            <td><button class="btn-small" onclick="viewPw('${u.password}')">í™•ì¸</button><button class="btn-small btn-blue" onclick="changePw('${userId}')">ë³€ê²½</button></td>
                            <td><button class="btn-small btn-red" onclick="deleteUser('${userId}', '${u.name}')">ì‚­ì œ</button></td>
                        </tr>`;
                });
            } catch(e) { console.error(e); Swal.fire("ì˜¤ë¥˜", "ë°ì´í„° ë¡œë”© ì‹¤íŒ¨", "error"); }
            showLoading(false);
        };

        // ê°€ê²Œ ë³€ê²½ ë° ìŠ¹ì¸ (í†µí•©)
        window.changeStore = async (docId, newStore) => {
            try {
                await updateDoc(doc(db, "meal_applications", docId), { store_name: newStore, status: "approved" });
                loadAllUsersAndApps();
            } catch(e) { console.error(e); }
        };

        // ê°•ì œ ìŠ¹ì¸ (ê´€ë¦¬ìê°€ ì§ì ‘ ì…ë ¥)
        window.forceApprove = async (userId, userName, storeName) => {
            if(confirm(`${userName}ë‹˜ì—ê²Œ [${storeName}] ì‹ì‚¬ê¶Œì„ ë°œê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const today = getTodayStr();
                await addDoc(collection(db, "meal_applications"), {
                    student_id: userId, student_name: userName, store_name: storeName,
                    status: "approved", date: today, activity: "ê´€ë¦¬ììŠ¹ì¸", timestamp: Timestamp.now()
                });
                loadAllUsersAndApps();
            }
        };

        window.viewPw = (pw) => Swal.fire('ë¹„ë°€ë²ˆí˜¸', pw, 'info');
        window.changePw = async (userId) => {
            const { value: np } = await Swal.fire({ title: 'ìƒˆ ë¹„ë°€ë²ˆí˜¸', input: 'text', showCancelButton: true });
            if (np) { await updateDoc(doc(db, "users", userId), { password: np }); Swal.fire('ì™„ë£Œ', 'ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); }
        };
        window.deleteUser = async (userId, name) => {
            if(confirm(`${name} íšŒì›ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                await deleteDoc(doc(db, "users", userId));
                loadAllUsersAndApps();
            }
        };

        // --- [TAB 2] ì •ì‚° ê´€ë¦¬ ---
        window.loadSettlementData = async () => {
            showLoading(true);
            const start = document.getElementById('settleStart').value;
            const end = document.getElementById('settleEnd').value;
            const targetStore = document.getElementById('settleStore').value;
            const targetStatus = document.getElementById('settleStatus').value;
            const tbody = document.getElementById('settleBody');
            
            try {
                const snap = await getDocs(query(collection(db, "meal_applications"), orderBy("date", "desc")));
                let list = [], totalCnt=0, totalPrice=0, totalUnpaid=0;

                snap.forEach(doc => {
                    const d = doc.data();
                    if (d.date < start || d.date > end) return;
                    if (targetStore !== 'all' && d.store_name !== targetStore) return;
                    
                    const isSettled = d.is_settled === true;
                    if (targetStatus === 'no' && isSettled) return;
                    if (targetStatus === 'yes' && !isSettled) return;

                    const price = d.amount ? Number(d.amount) : 0;
                    if (price > 0) {
                        totalCnt++; totalPrice += price;
                        if(!isSettled) totalUnpaid += price;
                        list.push({ id: doc.id, ...d, price, isSettled });
                    }
                });

                document.getElementById('sumCount').innerText = totalCnt + "ê±´";
                document.getElementById('sumPrice').innerText = totalPrice.toLocaleString() + "ì›";
                document.getElementById('sumUnpaid').innerText = totalUnpaid.toLocaleString() + "ì›";

                tbody.innerHTML = list.length ? "" : "<tr><td colspan='5'>ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                list.forEach(item => {
                    const btn = item.isSettled ? 
                        `<button class="btn-small btn-green" onclick="toggleSettle('${item.id}', false)">âœ… ì™„ë£Œ</button>` : 
                        `<button class="btn-small btn-red" onclick="toggleSettle('${item.id}', true)">âŒ ë¯¸ì •ì‚°</button>`;
                    
                    tbody.innerHTML += `<tr><td>${item.date}</td><td>${item.student_name}</td><td>${item.store_name}</td><td>${item.price.toLocaleString()}</td><td>${btn}</td></tr>`;
                });
            } catch(e) { console.error(e); }
            showLoading(false);
        };

        window.toggleSettle = async (id, state) => {
            if(confirm("ì •ì‚° ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await updateDoc(doc(db, "meal_applications", id), { is_settled: state });
                loadSettlementData();
            }
        };

        // --- [TAB 3] í™œë™ ê¸°ë¡ ---
        window.loadRecords = async () => {
            showLoading(true);
            const start = document.getElementById('recStart').value;
            const end = document.getElementById('recEnd').value;
            const filterAct = document.getElementById('recActivity').value;
            const tbody = document.getElementById('recBody');
            
            try {
                // ì—¬ëŸ¬ ì»¬ë ‰ì…˜ í•©ì¹˜ê¸° (ì¶œì„, ê¸‰ì‹, ê°„ì‹)
                let records = [];
                const add = (snap, type) => snap.forEach(d => {
                    const data = d.data();
                    if(data.date >= start && data.date <= end) {
                        let actName = data.activity || (type==='meal' ? 'ì‹ì‚¬' : 'ê°„ì‹');
                        if(!filterAct || actName === filterAct) {
                            records.push({ date: data.date, name: data.student_name, act: actName });
                        }
                    }
                });

                const [attSnap, mealSnap, snackSnap] = await Promise.all([
                    getDocs(query(collection(db, "attendance"))),
                    getDocs(query(collection(db, "meal_applications"))),
                    getDocs(query(collection(db, "snacks")))
                ]);

                add(attSnap, 'attendance'); add(mealSnap, 'meal'); add(snackSnap, 'snack');
                
                // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                records.sort((a,b) => b.date.localeCompare(a.date));

                tbody.innerHTML = records.length ? "" : "<tr><td colspan='3'>ê¸°ë¡ ì—†ìŒ</td></tr>";
                records.forEach(r => tbody.innerHTML += `<tr><td>${r.name}</td><td>${r.date}</td><td>${r.act}</td></tr>`);
            } catch(e) { console.error(e); }
            showLoading(false);
        };

        // --- [TAB 4] ê´‘ê³  ì„¤ì • ---
        window.loadAds = async () => {
            try {
                const docSnap = await getDoc(doc(db, "settings", "ads"));
                if(docSnap.exists()) {
                    const d = docSnap.data();
                    document.getElementById('ad1Img').value = d.ad1_img || "";
                    document.getElementById('ad1Link').value = d.ad1_link || "";
                    document.getElementById('ad2Img').value = d.ad2_img || "";
                    document.getElementById('ad2Link').value = d.ad2_link || "";
                }
            } catch(e) {}
        };

        window.saveAds = async () => {
            const data = {
                ad1_img: document.getElementById('ad1Img').value,
                ad1_link: document.getElementById('ad1Link').value,
                ad2_img: document.getElementById('ad2Img').value,
                ad2_link: document.getElementById('ad2Link').value
            };
            await setDoc(doc(db, "settings", "ads"), data);
            Swal.fire("ì €ì¥ ì™„ë£Œ", "í‚¤ì˜¤ìŠ¤í¬ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.", "success");
        };

        // --- [TAB 5] ê¸°ì´ˆì†Œì–‘êµìœ¡ ì´ìˆ˜ ëŒ€ì¥ (ì‹ ê·œ) ---
        window.loadEducationStats = async () => {
            showLoading(true);
            const tbody = document.getElementById('eduBody');
            const searchName = document.getElementById('eduSearchName').value.trim();
            
            try {
                const q = query(collection(db, "education_records"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                let records = [];
                
                querySnapshot.forEach(doc => records.push(doc.data()));

                if (searchName) {
                    records = records.filter(r => r.student_name && r.student_name.includes(searchName));
                }

                tbody.innerHTML = "";
                if (records.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='5'>ì¡°íšŒëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                } else {
                    records.forEach(d => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${d.date}</td>
                                <td>${d.student_name}</td>
                                <td>${d.student_birth || '-'}</td>
                                <td><span class="badge badge-blue">${d.category}</span></td>
                                <td style="text-align:left; padding-left:15px;">${d.video_title}</td>
                            </tr>
                        `;
                    });
                }
            } catch(e) { console.error(e); tbody.innerHTML = "<tr><td colspan='5'>ë¡œë”© ì‹¤íŒ¨</td></tr>"; }
            showLoading(false);
        };

        // --- ìœ í‹¸ë¦¬í‹° (ì—‘ì…€/PDF) ---
        window.downloadTableAsExcel = (id, name) => { 
            const wb = XLSX.utils.table_to_book(document.getElementById(id)); 
            XLSX.writeFile(wb, name + ".xlsx"); 
        };

        window.generateSettlementPDF = () => {
            // (ìƒëµ: ê¸°ì¡´ê³¼ ë™ì¼í•œ ë¡œì§, í•„ìš”ì‹œ ì´ì „ ì½”ë“œ ì°¸ì¡°)
            alert("PDF ê¸°ëŠ¥ì€ ì„œë²„ í™˜ê²½ì´ë‚˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        };
        window.generateRecordPDF = () => {
            alert("PDF ê¸°ëŠ¥ ì¤€ë¹„ì¤‘");
        };

    </script>
</body>
</html>
