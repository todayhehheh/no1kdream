<script type="module">
        import { db, collection, query, where, getDocs, updateDoc, doc, Timestamp } from "./js/firebase-config.js";

        const urlParams = new URLSearchParams(window.location.search);
        const storeName = urlParams.get('store') || "알 수 없는 식당";

        document.getElementById('displayStore').innerText = storeName;
        document.getElementById('ticketStoreName').innerText = storeName;

        let currentUser = null;
        let applicationDocId = null;

        const getTodayStr = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        };

        const showLoading = (show) => {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        }

        window.verifyUser = async () => {
            const rawId = document.getElementById('loginId').value.replace(/\s/g, '');
            const pw = document.getElementById('loginPw').value;
            const idMatch = rawId.match(/^([가-힣a-zA-Z]+)(\d{6})$/);

            if (!idMatch) return Swal.fire('오류', '아이디 형식을 확인해주세요.<br>(이름+생년월일 6자리)', 'warning');

            const name = idMatch[1];
            const birth = idMatch[2];

            showLoading(true);

            try {
                // 1. 유저 인증
                const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth), where("password", "==", pw));
                const snapshot = await getDocs(q);
                
                if (snapshot.empty) {
                    showLoading(false);
                    return Swal.fire('인증 실패', '회원 정보가 일치하지 않습니다.', 'error');
                }

                currentUser = snapshot.docs[0].data();
                const userId = snapshot.docs[0].id;
                const today = getTodayStr();

                // 2. 신청 내역 조회 (오늘 + 승인된 것)
                const appQ = query(collection(db, "meal_applications"), 
                    where("student_id", "==", userId), 
                    where("date", "==", today),
                    where("status", "==", "approved") 
                );
                const appSnap = await getDocs(appQ);

                if (appSnap.empty) {
                    showLoading(false);
                    const pendingQ = query(collection(db, "meal_applications"), where("student_id", "==", userId), where("date", "==", today));
                    const pendingSnap = await getDocs(pendingQ);
                    
                    if(!pendingSnap.empty) return Swal.fire('승인 대기중', '선생님의 승인을 기다려주세요.', 'info');
                    else return Swal.fire('신청 내역 없음', '먼저 키오스크에서 식사를 신청해주세요.', 'error');
                }

                const appDoc = appSnap.docs[0];
                const appData = appDoc.data();

                // 3. 중복 사용 체크 (이미 식사완료/정산완료 여부 확인)
                // is_settled가 아니라 status가 completed인지 확인해야 함 (정산은 나중에 하니까)
                if (appData.status === 'completed') {
                    showLoading(false);
                    return Swal.fire('이미 사용', '이미 사용 처리된 식권입니다.', 'info');
                }

                if (appData.store_name !== storeName) {
                    showLoading(false);
                    return Swal.fire({
                        icon: 'error',
                        title: '식당 불일치',
                        html: `신청 내역: <b>${appData.store_name}</b><br>현재 접속: <b>${storeName}</b><br><br>올바른 식당 QR코드를 스캔해주세요.`
                    });
                }

                // 4. 성공 -> 결제창 이동
                applicationDocId = appDoc.id;
                showLoading(false);
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('amountSection').style.display = 'block';

            } catch (e) {
                console.error(e);
                showLoading(false);
                Swal.fire('오류', '시스템 처리 중 문제가 발생했습니다.', 'error');
            }
        };

        window.processPayment = async () => {
            const amount = document.getElementById('payAmount').value;
            if (!amount) return Swal.fire('알림', '금액을 입력해주세요.', 'warning');

            const numAmount = Number(amount);
            if (numAmount > 15000) return Swal.fire('한도 초과', '금액이 너무 큽니다.', 'warning');
            if (numAmount < 1000) return Swal.fire('금액 오류', '올바른 금액을 입력해주세요.', 'warning');

            const result = await Swal.fire({
                title: `${numAmount.toLocaleString()}원`,
                text: "결제하시겠습니까?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: '결제하기',
                confirmButtonColor: '#6C5CE7'
            });

            if (!result.isConfirmed) return;

            showLoading(true);

            try {
                // [핵심 수정] is_settled: false로 저장 (선생님이 나중에 정산하기 위해)
                await updateDoc(doc(db, "meal_applications", applicationDocId), {
                    amount: numAmount,
                    status: 'completed',    // 식사는 완료됨
                    is_settled: false,      // 돈은 아직 정산 안 됨 (관리자 페이지에 빨간색으로 뜸)
                    used_at: Timestamp.now()
                });

                showLoading(false);
                document.getElementById('loginView').style.display = 'none';
                document.getElementById('ticketView').style.display = 'block';
                document.getElementById('ticketUserName').innerText = currentUser.name;
                document.getElementById('ticketAmount').innerText = numAmount.toLocaleString() + "원";

                const updateTime = () => {
                    document.getElementById('ticketTime').innerText = new Date().toLocaleTimeString();
                };
                updateTime();
                setInterval(updateTime, 1000);

            } catch (e) {
                console.error(e);
                showLoading(false);
                Swal.fire('실패', '결제 저장 실패. 다시 시도해주세요.', 'error');
            }
        };
    </script>
