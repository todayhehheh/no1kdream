<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; }
        .glass-container { max-width: 1200px; margin: 0 auto; padding: 30px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        h1 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; color: #2d3436; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .refresh-btn { background: #fff; border: 1px solid #ddd; padding: 8px 12px; border-radius: 8px; cursor: pointer; transition: 0.2s; font-size: 18px; }
        .refresh-btn:hover { background: #f8f9fa; transform: rotate(180deg); }
        .tabs { display: flex; gap: 10px; margin-bottom: 25px; background: #f1f3f5; padding: 5px; border-radius: 12px; flex-wrap: wrap; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 8px; cursor: pointer; font-weight: 700; color: #868e96; font-size: 15px; transition: 0.2s; white-space: nowrap; }
        .tab-btn.active { background: white; color: #6C5CE7; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05); }
        .tab-btn:hover:not(.active) { background: rgba(255, 255, 255, 0.5); }
        .table-box { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; font-size: 14px; }
        th { background-color: #f8f9fa; color: #495057; font-weight: 700; padding: 12px; border-bottom: 2px solid #dee2e6; text-align: center; }
        td { padding: 12px; border-bottom: 1px solid #f1f3f5; vertical-align: middle; color: #212529; text-align: center; }
        tr:hover td { background-color: #f8f9fa; }
        .btn-small { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: bold; margin: 0 2px; transition: 0.2s; }
        .btn-blue { background: #e7f5ff; color: #1c7ed6; } .btn-blue:hover { background: #d0ebff; }
        .btn-red { background: #fff5f5; color: #fa5252; } .btn-red:hover { background: #ffe3e3; }
        .btn-green { background: #ebfbee; color: #2f9e44; } .btn-green:hover { background: #d3f9d8; }
        .btn-dark { background: #343a40; color: white; padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: bold; border:none; cursor: pointer; }
        .btn-dark:hover { background: #212529; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .badge-blue { background: #e7f5ff; color: #1971c2; }
        .badge-green { background: #ebfbee; color: #2f9e44; }
        
        .store-toggles { display: flex; gap: 4px; justify-content: center; flex-wrap: wrap; }
        .toggle-btn { padding: 6px 8px; border: 1px solid #dee2e6; background: white; color: #adb5bd; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 11px; transition: 0.2s; margin-bottom: 2px; }
        .toggle-btn:hover { background: #f8f9fa; }
        
        .active-dalin { background: #fff9db; color: #f08c00; border-color: #fcc419; }
        .active-mystery { background: #f3d9fa; color: #be4bdb; border-color: #e599f7; }
        .active-yeon { background: #e6fcf5; color: #0ca678; border-color: #63e6be; }
        .active-dduk { background: #ffe3e3; color: #e03131; border-color: #ffa8a8; }
        .active-meal { background: #e7f5ff; color: #1c7ed6; border-color: #74c0fc; }

        .filter-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; background: #f8f9fa; padding: 15px; border-radius: 12px; }
        .filter-bar label { font-size: 14px; font-weight: bold; color: #495057; }
        .filter-bar select, .filter-bar input { border: 1px solid #ced4da; padding: 8px; border-radius: 6px; outline: none; }
        .summary-box { background: #e7f5ff; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-around; font-weight: 700; color: #1864ab; }
        .ad-setting-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        @media (max-width: 800px) { .ad-setting-box { grid-template-columns: 1fr; } }
        .ad-card { background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #dee2e6; }
        
        /* ì„ ê²°ì œ ì”ì•¡ ê´€ë¦¬ ë°•ìŠ¤ */
        .balance-manage-box { 
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 20px; 
        }
        @media (max-width: 1000px) { .balance-manage-box { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 600px) { .balance-manage-box { grid-template-columns: repeat(2, 1fr); } }

        .balance-item { 
            background: white; border: 1px solid #dee2e6; border-radius: 12px; padding: 15px; 
            text-align: center; cursor: pointer; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }
        .balance-item:hover { transform: translateY(-3px); border-color: #6C5CE7; }
        .balance-store { font-size: 14px; color: #868e96; font-weight: bold; margin-bottom: 5px; }
        .balance-value { font-size: 18px; color: #212529; font-weight: 900; }

        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 13px; color: #495057; }
        .input-field { width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; }
        #loadingOverlay { display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #6C5CE7; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #hidden-print-zone { position: fixed; top: 0; left: 0; width: 210mm; min-height: 297mm; background: white; z-index: -9999; padding: 15mm; box-sizing: border-box; opacity: 0; pointer-events: none; color: black !important; }
        .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
        .report-title { font-size: 28px; font-weight: bold; margin: 0; color: #000; }
        .report-sub { margin-top: 10px; font-size: 14px; color: #333; }
        .report-summary-box { border: 2px solid #333; background-color: #f8f9fa; padding: 15px; margin-bottom: 20px; display: flex; justify-content: space-around; font-weight: bold; font-size: 14px; }
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .report-table th, .report-table td { border: 1px solid #999; padding: 8px; text-align: center; color: #000; }
        .report-table th { background-color: #eee; }
    </style>
</head>

<body>

    <div id="loadingOverlay"><div class="spinner"></div></div>

    <div class="glass-container">
        <h1>
            <div class="header-left">
                <span>ğŸ“‹ ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</span>
                <button class="btn-dark" onclick="registerThisDevice()" title="ì´ PCë¥¼ í‚¤ì˜¤ìŠ¤í¬ë¡œ ì¸ì¦í•©ë‹ˆë‹¤">ğŸ–¥ï¸ ê¸°ê¸° ë“±ë¡</button>
                <button class="btn-small btn-red" onclick="unregisterThisDevice()" title="ì¸ì¦ í•´ì œ">ğŸš« í•´ì œ</button>
            </div>
            <button class="refresh-btn" onclick="refreshData()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>
        </h1>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('users')">1. ì „ì²´ ì²­ì†Œë…„ & ê¸‰ì‹</button>
            <button class="tab-btn" onclick="switchTab('settlement')">2. ì •ì‚° ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchTab('records')">3. í†µí•© ê¸°ë¡</button>
            <button class="tab-btn" onclick="switchTab('ads')">4. ê´‘ê³  ì„¤ì •</button>
            <button class="tab-btn" onclick="switchTab('education')">5. ê¸°ì´ˆì†Œì–‘êµìœ¡</button>
            <button class="tab-btn" onclick="switchTab('snacks')">6. ë¶€ì‹ í†µê³„</button>
        </div>

        <div id="tab-users" class="table-box">
            <div style="margin-bottom: 10px; color:#555; font-size:14px;">ğŸ“… <strong>ì˜¤ëŠ˜ (<span id="todayDisplay"></span>)</strong> ê¸°ì¤€ ìƒíƒœ</div>
            <table>
                <thead>
                    <tr>
                        <th width="15%">ì´ë¦„ (ìƒì¼)</th>
                        <th width="20%">ìƒíƒœ</th>
                        <th width="35%">ìŠ¹ì¸/ë³€ê²½</th>
                        <th width="20%">ê³„ì •</th>
                        <th width="10%">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"><tr><td colspan="5">ë¡œë”© ì¤‘...</td></tr></tbody>
            </table>
        </div>

        <div id="tab-settlement" class="table-box" style="display:none;">
            <h3 style="margin-bottom:10px; color:#495057;">ğŸ’³ ê°€ê²Œë³„ ì„ ê²°ì œ ì”ì•¡ ê´€ë¦¬ (í´ë¦­í•˜ì—¬ ìˆ˜ì •)</h3>
            <div class="balance-manage-box" id="balanceBox">
                <div style="grid-column: 1/-1; text-align:center; padding:20px; color:#aaa;">ì”ì•¡ ë¡œë”© ì¤‘...</div>
            </div>

            <div class="filter-bar">
                <label>ê¸°ê°„:</label><input type="date" id="settleStart"> ~ <input type="date" id="settleEnd">
                <label>ì—…ì²´:</label><select id="settleStore">
                    <option value="all">ì „ì²´</option>
                    <option value="ë‹¬ì¸ë³´ìŒˆ">ë‹¬ì¸ë³´ìŒˆ</option>
                    <option value="ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹">ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹</option>
                    <option value="ì—°ê¹€ë°¥">ì—°ê¹€ë°¥</option>
                    <option value="ë™ì¼ë¡œì¦‰ì„ë–¡ë³¶ì´">ë™ì¼ë¡œì¦‰ì„ë–¡ë³¶ì´</option>
                    <option value="ìš°ë¦¬ë™ë„¤ ì²«ë¼">ìš°ë¦¬ë™ë„¤ ì²«ë¼</option>
                </select>
                <label>ìƒíƒœ:</label><select id="settleStatus">
                    <option value="all">ì „ì²´</option>
                    <option value="no">âŒ ë¯¸ì •ì‚°</option>
                    <option value="yes">âœ… ì •ì‚°ì™„ë£Œ</option>
                </select>
                <button class="btn-small btn-blue" onclick="loadSettlementData()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('settleTable', 'ì •ì‚°ë‚´ì—­')">ì—‘ì…€</button>
                <button class="btn-small btn-red" onclick="generateSettlementPDF()">PDF</button>
            </div>
            <div class="summary-box">
                <span>ì´ ê±´ìˆ˜: <span id="sumCount">0</span></span>
                <span>ì´ ë§¤ì¶œ: <span id="sumPrice">0</span></span>
                <span style="color:#e03131">ë¯¸ì •ì‚°(ì§€ê¸‰ì˜ˆì •): <span id="sumUnpaid">0</span></span>
            </div>
            <table id="settleTable">
                <thead><tr><th>ë‚ ì§œ</th> <th>ì´ë¦„ (ìƒë…„ì›”ì¼)</th> <th>ì—…ì²´</th> <th>ê¸ˆì•¡</th> <th>ì •ì‚°/ê´€ë¦¬</th></tr></thead>
                <tbody id="settleBody"><tr><td colspan="5">ê¸°ê°„ ì„ íƒ í›„ [ì¡°íšŒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr></tbody>
            </table>
        </div>

        <div id="tab-records" class="table-box" style="display:none;">
            <div class="filter-bar">
                <label>ê¸°ê°„:</label><input type="date" id="recStart"> ~ <input type="date" id="recEnd">
                <label>í™œë™:</label><select id="recActivity">
                    <option value="">ì „ì²´</option>
                    <option value="ê¸°ì´ˆì†Œì–‘êµìœ¡">ê¸°ì´ˆì†Œì–‘</option>
                    <option value="í”„ë¡œê·¸ë¨">í”„ë¡œê·¸ë¨</option>
                    <option value="ìŠ¤í„°ë””ì¹´í˜">ìŠ¤í„°ë””</option>
                </select>
                <button class="btn-small btn-blue" onclick="loadRecords()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('recordTable', 'í™œë™ê¸°ë¡')">ì—‘ì…€</button>
                <button class="btn-small btn-red" onclick="generateRecordPDF()">PDF</button>
            </div>
            <table id="recordTable">
                <thead><tr><th>ì´ë¦„ (ìƒë…„ì›”ì¼)</th> <th>ì¼ì</th> <th>í™œë™ë‚´ì—­</th></tr></thead>
                <tbody id="recBody"><tr><td colspan="3">ê¸°ê°„ ì„ íƒ í›„ [ì¡°íšŒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr></tbody>
            </table>
        </div>

        <div id="tab-ads" class="table-box" style="display:none;">
            <h2>ğŸ“¢ í‚¤ì˜¤ìŠ¤í¬ ê´‘ê³  ë°°ë„ˆ ì„¤ì •</h2>
            <div class="ad-setting-box">
                <div class="ad-card"><h3>ê´‘ê³  1 (ì™¼ìª½)</h3><div class="input-group"><label>ì´ë¯¸ì§€ URL</label><input type="text" id="ad1Img" class="input-field"></div><div class="input-group"><label>ì´ë™ ë§í¬</label><input type="text" id="ad1Link" class="input-field"></div></div>
                <div class="ad-card"><h3>ê´‘ê³  2 (ê°€ìš´ë°)</h3><div class="input-group"><label>ì´ë¯¸ì§€ URL</label><input type="text" id="ad2Img" class="input-field"></div><div class="input-group"><label>ì´ë™ ë§í¬</label><input type="text" id="ad2Link" class="input-field"></div></div>
                <div class="ad-card"><h3>ê´‘ê³  3 (ì˜¤ë¥¸ìª½)</h3><div class="input-group"><label>ì´ë¯¸ì§€ URL</label><input type="text" id="ad3Img" class="input-field"></div><div class="input-group"><label>ì´ë™ ë§í¬</label><input type="text" id="ad3Link" class="input-field"></div></div>
            </div>
            <button class="btn-dark" style="width:100%; margin-top:20px; padding:15px;" onclick="saveAds()">ì„¤ì • ì €ì¥</button>
        </div>

        <div id="tab-education" class="table-box" style="display:none;">
            <div class="filter-bar">
                <label>ê¸°ê°„:</label><input type="date" id="eduStart"> ~ <input type="date" id="eduEnd">
                <label>ì´ë¦„:</label><input type="text" id="eduSearchName" placeholder="ì „ì²´">
                <button class="btn-small btn-blue" onclick="loadEducationStats()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('eduTable', 'ê¸°ì´ˆì†Œì–‘êµìœ¡_ì´ìˆ˜ëŒ€ì¥')">ì—‘ì…€</button>
            </div>
            <table id="eduTable">
                <thead><tr><th>ìˆ˜ê°•ì¼ì</th> <th>ì´ë¦„</th> <th>ìƒë…„ì›”ì¼</th> <th>ìˆ˜ê°•ê³¼ëª©</th> <th>ê°•ì˜ëª…</th></tr></thead>
                <tbody id="eduBody"><tr><td colspan="5">ê¸°ê°„ ì„ íƒ í›„ [ì¡°íšŒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr></tbody>
            </table>
        </div>

        <div id="tab-snacks" class="table-box" style="display:none;">
            <div class="filter-bar">
                <label>ê¸°ê°„:</label><input type="date" id="snackStart"> ~ <input type="date" id="snackEnd">
                <label>ì´ë¦„:</label><input type="text" id="snackSearchName" placeholder="ì „ì²´">
                <button class="btn-small btn-blue" onclick="loadSnackStats()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('snackTable', 'ë¶€ì‹ëŒ€ì¥')">ì—‘ì…€</button>
            </div>
            <table id="snackTable">
                <thead><tr><th>ì¼ì</th> <th>ì´ë¦„</th> <th>ìƒë…„ì›”ì¼</th> <th>ì‹ ì²­ë‚´ì—­</th></tr></thead>
                <tbody id="snackBody"><tr><td colspan="4">ê¸°ê°„ ì„ íƒ í›„ [ì¡°íšŒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr></tbody>
            </table>
        </div>
    </div>

    <div id="hidden-print-zone"></div>

    <script type="module">
        import { db, collection, getDocs, getDoc, setDoc, query, where, orderBy, updateDoc, addDoc, deleteDoc, doc, Timestamp } from "./js/firebase-config.js";

        const ADMIN_PW = "1388";
        const showLoading = (show) => { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }
        
        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
        const getTodayStr = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        };
        const get3DaysAgoStr = () => {
            const d = new Date();
            d.setDate(d.getDate() - 3); // 3ì¼ ì „
            return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
        };

        const STORE_LIST = ['ë‹¬ì¸ë³´ìŒˆ', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹', 'ì—°ê¹€ë°¥', 'ë™ì¼ë¡œì¦‰ì„ë–¡ë³¶ì´', 'ìš°ë¦¬ë™ë„¤ ì²«ë¼'];

        window.onload = async () => {
            const { value: inputPw } = await Swal.fire({
                title: 'ê´€ë¦¬ì ì ‘ì†', input: 'password', inputPlaceholder: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                allowOutsideClick: false, confirmButtonText: 'ì ‘ì†'
            });
            if (inputPw !== ADMIN_PW) {
                document.body.innerHTML = "<div style='text-align:center;margin-top:20%;color:red;'><h2>â›” ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</h2><button onclick='location.reload()'>ë‹¤ì‹œ ì‹œë„</button></div>";
                return;
            }
            
            document.getElementById('todayDisplay').innerText = getTodayStr();
            loadAllUsersAndApps(); // 1ë²ˆ íƒ­(íšŒì›)ë§Œ ìë™ ë¡œë”©
        };

        // --- 3. ìºì‹± ì „ëµ ì„¤ëª… (localStorage) ---
        // ì•„ë˜ í•¨ìˆ˜ë“¤ì€ í‚¤ì˜¤ìŠ¤í¬ ìª½ì—ì„œ ì“¸ ìˆ˜ ìˆëŠ” ì˜ˆì‹œì…ë‹ˆë‹¤. (ì–´ë“œë¯¼ì—” ì ìš© X, í‚¤ì˜¤ìŠ¤í¬ì— ì ìš©í•˜ë©´ ì¢‹ìŒ)
        // ê°œë…: "ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ ë‚´ ì»´í“¨í„°(ë¸Œë¼ìš°ì €)ì— ëª°ë˜ ì €ì¥í•´ë‘ê³ , ë‹¤ìŒì—” ì„œë²„ ì•ˆ ë¶€ë¥´ê³  ê·¸ê±° ì“°ê¸°"

        // --- 2. í†µê³„ ë¬¸ì„œ(Aggregation) ì „ëµ ì„¤ëª… ---
        // ê°œë…: "ë¼ì§€ì €ê¸ˆí†µ(ì „ì²´ ë¬¸ì„œ)ì„ ë§¤ë²ˆ í„¸ì–´ì„œ ì„¸ì§€ ë§ê³ , ë™ì „ ë„£ì„ ë•Œë§ˆë‹¤ ë…¸íŠ¸(í†µê³„ ë¬¸ì„œ)ì— '+100ì›' ì´ë¼ê³  ì ì–´ë‘ê¸°"
        // ì§€ê¸ˆì€ ì ìš©í•˜ì§€ ì•Šì•˜ì§€ë§Œ, ë‚˜ì¤‘ì— í•™ìƒì´ 1,000ëª… ë„˜ì–´ê°€ë©´ ê·¸ë•Œ ì œê°€ ì½”ë“œë¥¼ ì§œë“œë¦¬ë©´ ë©ë‹ˆë‹¤.

        // --- íƒ­ ì „í™˜ ë¡œì§ (ìˆ˜ì •ë¨: ìë™ ë¡œë”© ë” & ë‚ ì§œ ì„¸íŒ…) ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.table-box').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            
            const idx = ['users','settlement','records','ads','education','snacks'].indexOf(tabName);
            if(idx>=0) document.querySelectorAll('.tab-btn')[idx].classList.add('active');
            
            // [ì¤‘ìš”] 1ë²ˆ íƒ­ë§Œ ìë™ ë¡œë”©, ë‚˜ë¨¸ì§€ëŠ” ë‚ ì§œë§Œ ì„¸íŒ…í•˜ê³  ëŒ€ê¸°
            if(tabName === 'users') {
                loadAllUsersAndApps();
            } else if (['settlement', 'records', 'education', 'snacks'].includes(tabName)) {
                // ë‚ ì§œ ê¸°ë³¸ê°’ ì„¸íŒ… (3ì¼ ì „ ~ ì˜¤ëŠ˜)
                const prefix = tabName === 'settlement' ? 'settle' : (tabName === 'records' ? 'rec' : (tabName === 'education' ? 'edu' : 'snack'));
                document.getElementById(`${prefix}Start`).value = get3DaysAgoStr();
                document.getElementById(`${prefix}End`).value = getTodayStr();
                
                // í…Œì´ë¸” ì´ˆê¸°í™” (ì¡°íšŒ ëˆ„ë¥´ë¼ê³  ì•ˆë‚´)
                const tbodyId = tabName === 'settlement' ? 'settleBody' : (tabName === 'records' ? 'recBody' : (tabName === 'education' ? 'eduBody' : 'snackBody'));
                const colSpan = tabName === 'settlement' ? 5 : (tabName === 'records' ? 3 : (tabName === 'education' ? 5 : 4));
                document.getElementById(tbodyId).innerHTML = `<tr><td colspan='${colSpan}' style="padding:30px; color:#888;">ğŸ” ê¸°ê°„ì„ í™•ì¸í•˜ê³  <b>[ì¡°íšŒ]</b> ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>`;
                
                // ì •ì‚°ê´€ë¦¬ íƒ­ì¼ ê²½ìš° ì”ì•¡ì€ ë³´ì—¬ì¤Œ (ì”ì•¡ì€ ë°ì´í„° 1ê°œë¼ ê°€ë²¼ì›€)
                if(tabName === 'settlement') loadStoreBalances();
            } else if (tabName === 'ads') {
                loadAds(); // ê´‘ê³  ì„¤ì •ì€ ê°€ë²¼ìš°ë‹ˆ ìë™ ë¡œë”©
            }
        };

        // --- [ì‹ ê·œ ê¸°ëŠ¥] ê°€ê²Œë³„ ì„ ê²°ì œ ì”ì•¡ ê´€ë¦¬ ---
        window.loadStoreBalances = async () => {
            const box = document.getElementById('balanceBox');
            box.innerHTML = '';
            for (const store of STORE_LIST) {
                let balance = 0;
                try {
                    const docRef = doc(db, "stores", store);
                    const docSnap = await getDoc(docRef);
                    if(docSnap.exists()) balance = docSnap.data().balance || 0;
                } catch(e) { console.error(e); }
                box.innerHTML += `
                    <div class="balance-item" onclick="updateStoreBalance('${store}', ${balance})">
                        <div class="balance-store">${store}</div>
                        <div class="balance-value" style="color:${balance < 0 ? 'red':'#212529'}">${balance.toLocaleString()}ì›</div>
                    </div>
                `;
            }
        };

        window.updateStoreBalance = async (storeName, currentBalance) => {
            const { value: newAmount } = await Swal.fire({
                title: `${storeName} ì”ì•¡ ìˆ˜ì •`, input: 'number', inputValue: currentBalance,
                text: 'í˜„ì¬ ì„ ê²°ì œ ì”ì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.', showCancelButton: true
            });
            if (newAmount !== null && newAmount !== "") {
                try {
                    showLoading(true);
                    await setDoc(doc(db, "stores", storeName), { balance: Number(newAmount) }, { merge: true });
                    showLoading(false); Swal.fire("ìˆ˜ì • ì™„ë£Œ", "ì”ì•¡ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.", "success");
                    loadStoreBalances();
                } catch(e) { showLoading(false); console.error(e); Swal.fire("ì˜¤ë¥˜", "ì €ì¥ ì‹¤íŒ¨", "error"); }
            }
        };

        // --- Tab 1: íšŒì› ë° ê¸‰ì‹ ê´€ë¦¬ (ê¸°ì¡´ ìœ ì§€) ---
        window.loadAllUsersAndApps = async () => {
            showLoading(true);
            const today = getTodayStr();
            const tbody = document.getElementById('userTableBody');
            try {
                const userSnap = await getDocs(query(collection(db, "users"), orderBy("name")));
                const appSnap = await getDocs(query(collection(db, "meal_applications"), where("date", "==", today)));
                let appsMap = {};
                appSnap.forEach(doc => { const d = doc.data(); if (!appsMap[d.student_id]) appsMap[d.student_id] = []; appsMap[d.student_id].push({ docId: doc.id, ...d, ts: d.timestamp ? d.timestamp.toMillis() : 0 }); });
                tbody.innerHTML = "";
                if (userSnap.empty) { tbody.innerHTML = "<tr><td colspan='5'>íšŒì› ì—†ìŒ</td></tr>"; showLoading(false); return; }
                userSnap.forEach(userDoc => {
                    const u = userDoc.data(); const userId = userDoc.id; let studentApps = appsMap[userId] || [];
                    studentApps.sort((a,b) => b.ts - a.ts);
                    let activeApp = studentApps.find(app => app.status === 'applied' || app.status === 'approved');
                    let completedCount = studentApps.filter(app => app.status === 'completed').length;
                    let statusText = `<span style="color:#ccc;">-</span>`; let buttonsHtml = '';
                    if (activeApp) {
                        const store = activeApp.store_name; const status = activeApp.status; const appId = activeApp.docId;
                        if (status === 'applied') statusText = `<span class="badge badge-blue">${store} (ì‹ ì²­)</span>`;
                        else statusText = `<span class="badge badge-green" style="background:#fff9db; color:#f08c00;">${store} (ìŠ¹ì¸)</span>`;
                        const cD = store === 'ë‹¬ì¸ë³´ìŒˆ' ? 'active-dalin' : ''; const cM = store === 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹' ? 'active-mystery' : ''; const cY = store === 'ì—°ê¹€ë°¥' ? 'active-yeon' : ''; const cT = store === 'ë™ì¼ë¡œì¦‰ì„ë–¡ë³¶ì´' ? 'active-dduk' : ''; const cW = store === 'ìš°ë¦¬ë™ë„¤ ì²«ë¼' ? 'active-meal' : '';
                        buttonsHtml = `<div class="store-toggles"><button class="toggle-btn ${cD}" onclick="changeStore('${appId}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button><button class="toggle-btn ${cM}" onclick="changeStore('${appId}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button><button class="toggle-btn ${cY}" onclick="changeStore('${appId}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button><button class="toggle-btn ${cT}" onclick="changeStore('${appId}', 'ë™ì¼ë¡œì¦‰ì„ë–¡ë³¶ì´')">ë–¡ë³¶ì´</button><button class="toggle-btn ${cW}" onclick="changeStore('${appId}', 'ìš°ë¦¬ë™ë„¤ ì²«ë¼')">ì²«ë¼</button></div>`;
                    } else {
                        buttonsHtml = `<div class="store-toggles"><button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button><button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button><button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button><button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë™ì¼ë¡œì¦‰ì„ë–¡ë³¶ì´')">ë–¡ë³¶ì´</button><button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ìš°ë¦¬ë™ë„¤ ì²«ë¼')">ì²«ë¼</button></div>`;
                        if(completedCount > 0) statusText = `<span class="badge badge-green">ì™„ë£Œ (${completedCount})</span>`;
                    }
                    tbody.innerHTML += `<tr><td><div style="font-weight:bold;">${u.name}</div><div style="font-size:12px; color:#888;">${u.birth}</div></td><td>${statusText}</td><td>${buttonsHtml}</td><td><button class="btn-small" onclick="viewPw('${u.password}')">ë¹„ë²ˆ</button><button class="btn-small btn-blue" onclick="changePw('${userId}')">ë³€ê²½</button></td><td><button class="btn-small btn-red" onclick="deleteUser('${userId}', '${u.name}')">ì‚­ì œ</button></td></tr>`;
                });
            } catch(e) { console.error(e); } showLoading(false);
        };
        window.changeStore = async (docId, newStore) => { showLoading(true); try { await updateDoc(doc(db, "meal_applications", docId), { store_name: newStore, status: "approved" }); loadAllUsersAndApps(); } catch(e) { Swal.fire("ì˜¤ë¥˜", "ë³€ê²½ ì‹¤íŒ¨", "error"); } showLoading(false); };
        window.forceApprove = async (userId, userName, storeName) => { if(confirm(`${userName}ë‹˜ì—ê²Œ [${storeName}] ì‹ì‚¬ê¶Œì„ ë°œê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { await addDoc(collection(db, "meal_applications"), { student_id: userId, student_name: userName, store_name: storeName, status: "approved", date: getTodayStr(), activity: "ê´€ë¦¬ììŠ¹ì¸", timestamp: Timestamp.now(), is_settled: false }); loadAllUsersAndApps(); } };

        // --- Tab 2: ì •ì‚° ê´€ë¦¬ ---
        window.loadSettlementData = async () => {
            showLoading(true);
            const start = document.getElementById('settleStart').value;
            const end = document.getElementById('settleEnd').value;
            const targetStore = document.getElementById('settleStore').value;
            const targetStatus = document.getElementById('settleStatus').value;
            const tbody = document.getElementById('settleBody');
            
            try {
                let userMap = {}; const uSnap = await getDocs(collection(db, "users")); uSnap.forEach(d => userMap[d.id] = d.data());
                const snap = await getDocs(query(collection(db, "meal_applications"), orderBy("timestamp", "desc")));
                let list = [], totalCnt=0, totalPrice=0, totalUnpaid=0;
                snap.forEach(doc => {
                    const d = doc.data();
                    if (d.date < start || d.date > end) return;
                    if (targetStore !== 'all' && d.store_name !== targetStore) return;
                    if (d.status !== 'completed') return;
                    const isSettled = d.is_settled === true;
                    if (targetStatus === 'no' && isSettled) return;
                    if (targetStatus === 'yes' && !isSettled) return;
                    const price = d.amount ? Number(d.amount) : 0;
                    totalCnt++; totalPrice += price; if(!isSettled) totalUnpaid += price;
                    const u = userMap[d.student_id] || { name: d.student_name, birth: '' };
                    list.push({ id: doc.id, ...d, price, isSettled, uName: u.name, uBirth: u.birth });
                });
                document.getElementById('sumCount').innerText = totalCnt + "ê±´"; document.getElementById('sumPrice').innerText = totalPrice.toLocaleString() + "ì›"; document.getElementById('sumUnpaid').innerText = totalUnpaid.toLocaleString() + "ì›";
                tbody.innerHTML = list.length ? "" : "<tr><td colspan='5'>ë‚´ì—­ ì—†ìŒ</td></tr>";
                list.forEach(item => {
                    const btnToggle = item.isSettled ? `<button class="btn-small btn-green" onclick="toggleSettle('${item.id}', false)">ğŸŸ¢ ì •ì‚°ì™„ë£Œ</button>` : `<button class="btn-small btn-red" onclick="toggleSettle('${item.id}', true)">ğŸ”´ ë¯¸ì •ì‚° (ì…ê¸ˆì „)</button>`;
                    const btnEdit = `<button class="btn-small btn-blue" onclick="editSettlement('${item.id}', '${item.price}', '${item.store_name}')" style="margin-left:5px;">âœï¸</button>`;
                    const btnDel = `<button class="btn-small btn-red" onclick="deleteSettlement('${item.id}')" style="margin-left:2px;">ğŸ—‘ï¸</button>`;
                    tbody.innerHTML += `<tr><td>${item.date}</td><td>${item.uName} <span style="font-size:12px;color:#888;">(${item.uBirth})</span></td><td>${item.store_name}</td><td>${item.price.toLocaleString()}ì›</td><td>${btnToggle} ${btnEdit} ${btnDel}</td></tr>`;
                });
            } catch(e) { console.error(e); } showLoading(false);
        };
        window.toggleSettle = async (id, state) => { if(confirm("ì •ì‚° ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await updateDoc(doc(db, "meal_applications", id), { is_settled: state }); loadSettlementData(); } };
        window.deleteSettlement = async (id) => { if(confirm("ì •ë§ ì´ ë‚´ì—­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { showLoading(true); await deleteDoc(doc(db, "meal_applications", id)); showLoading(false); loadSettlementData(); } };
        window.editSettlement = async (id, oldPrice, oldStore) => {
            const { value: formValues } = await Swal.fire({
                title: 'ì •ì‚° ë‚´ì—­ ìˆ˜ì •', html: `<div>ê¸ˆì•¡ ìˆ˜ì •</div><input id="swal-edit-price" class="swal2-input" type="number" value="${oldPrice}">` + `<div>ê°€ê²Œ ìˆ˜ì •</div><select id="swal-edit-store" class="swal2-input">` + STORE_LIST.map(s => `<option value="${s}" ${oldStore===s?'selected':''}>${s}</option>`).join('') + `</select>`, focusConfirm: false, showCancelButton: true, preConfirm: () => [document.getElementById('swal-edit-price').value, document.getElementById('swal-edit-store').value]
            });
            if (formValues) { showLoading(true); await updateDoc(doc(db, "meal_applications", id), { amount: Number(formValues[0]), store_name: formValues[1] }); showLoading(false); loadSettlementData(); Swal.fire("ìˆ˜ì • ì™„ë£Œ", "", "success"); }
        };

        // --- Tab 3: í†µí•© ê¸°ë¡ ---
        window.loadRecords = async () => {
            showLoading(true);
            const start = document.getElementById('recStart').value;
            const end = document.getElementById('recEnd').value;
            const filterAct = document.getElementById('recActivity').value;
            const tbody = document.getElementById('recBody');
            try {
                let userMap = {}; const uSnap = await getDocs(collection(db, "users")); uSnap.forEach(d => userMap[d.id] = d.data());
                let records = [];
                const add = (snap, type) => snap.forEach(d => {
                    const data = d.data();
                    if(data.date >= start && data.date <= end) {
                        let actName = data.activity || (type==='meal' ? 'ì‹ì‚¬' : 'ê°„ì‹');
                        if(actName.includes('ê´€ë¦¬ì')) return; 
                        if(filterAct && actName !== filterAct) return;
                        const ts = data.timestamp ? data.timestamp.toMillis() : new Date(data.date).getTime();
                        const u = userMap[data.student_id] || { name: data.student_name, birth: '' };
                        records.push({ date: data.date, name: u.name, birth: u.birth, act: actName, ts: ts });
                    }
                });
                const [attSnap, mealSnap, snackSnap] = await Promise.all([ getDocs(query(collection(db, "attendance"))), getDocs(query(collection(db, "meal_applications"))), getDocs(query(collection(db, "snacks"))) ]);
                add(attSnap, 'attendance'); add(mealSnap, 'meal'); add(snackSnap, 'snack');
                records.sort((a,b) => b.ts - a.ts);
                tbody.innerHTML = records.length ? "" : "<tr><td colspan='3'>ê¸°ë¡ ì—†ìŒ</td></tr>";
                records.forEach(r => tbody.innerHTML += `<tr><td>${r.name} <span style="font-size:12px;color:#888;">(${r.birth})</span></td><td>${r.date}</td><td>${r.act}</td></tr>`);
            } catch(e) { console.error(e); } showLoading(false);
        };

        // --- Tab 4,5,6 ---
        window.loadAds = async () => { try { const docSnap = await getDoc(doc(db, "settings", "ads")); if(docSnap.exists()) { const d = docSnap.data(); document.getElementById('ad1Img').value = d.ad1_img || ""; document.getElementById('ad1Link').value = d.ad1_link || ""; document.getElementById('ad2Img').value = d.ad2_img || ""; document.getElementById('ad2Link').value = d.ad2_link || ""; document.getElementById('ad3Img').value = d.ad3_img || ""; document.getElementById('ad3Link').value = d.ad3_link || ""; } } catch(e) {} };
        window.saveAds = async () => { await setDoc(doc(db, "settings", "ads"), { ad1_img: document.getElementById('ad1Img').value, ad1_link: document.getElementById('ad1Link').value, ad2_img: document.getElementById('ad2Img').value, ad2_link: document.getElementById('ad2Link').value, ad3_img: document.getElementById('ad3Img').value, ad3_link: document.getElementById('ad3Link').value }); Swal.fire("ì €ì¥ ì™„ë£Œ", "í‚¤ì˜¤ìŠ¤í¬ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.", "success"); };
        
        window.loadEducationStats = async () => {
            showLoading(true); const tbody = document.getElementById('eduBody'); const searchName = document.getElementById('eduSearchName').value.trim(); const start = document.getElementById('eduStart').value; const end = document.getElementById('eduEnd').value;
            try {
                const q = query(collection(db, "education_records"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q); let records = [];
                querySnapshot.forEach(doc => { const d = doc.data(); if (d.date < start || d.date > end) return; if (searchName && !d.student_name.includes(searchName)) return; records.push(d); });
                tbody.innerHTML = records.length ? "" : "<tr><td colspan='5'>ì¡°íšŒëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                records.forEach(d => { tbody.innerHTML += `<tr><td>${d.date}</td><td>${d.student_name}</td><td>${d.student_birth || '-'}</td><td><span class="badge badge-blue">${d.category}</span></td><td style="text-align:left; padding-left:15px;">${d.video_title}</td></tr>`; });
            } catch(e) { console.error(e); tbody.innerHTML = "<tr><td colspan='5'>ë¡œë”© ì‹¤íŒ¨</td></tr>"; } showLoading(false);
        };

        window.loadSnackStats = async () => {
            showLoading(true); const tbody = document.getElementById('snackBody'); const searchName = document.getElementById('snackSearchName').value.trim(); const start = document.getElementById('snackStart').value; const end = document.getElementById('snackEnd').value;
            try {
                let userMap = {}; const uSnap = await getDocs(collection(db, "users")); uSnap.forEach(d => userMap[d.id] = d.data());
                const q = query(collection(db, "snacks")); const querySnapshot = await getDocs(q); let list = [];
                querySnapshot.forEach(doc => { const d = doc.data(); if (d.date < start || d.date > end) return; if (searchName && !d.student_name.includes(searchName)) return; const ts = d.timestamp ? d.timestamp.toMillis() : new Date(d.date).getTime(); const u = userMap[d.student_id] || { birth: '-' }; list.push({ ...d, ts: ts, birth: u.birth }); });
                list.sort((a, b) => b.ts - a.ts); tbody.innerHTML = list.length ? "" : "<tr><td colspan='4'>ì¡°íšŒëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                list.forEach(item => { tbody.innerHTML += `<tr><td>${item.date}</td><td>${item.student_name}</td><td>${item.birth}</td><td>${item.item || 'ê°„ì‹'}</td></tr>`; });
            } catch(e) { console.error(e); tbody.innerHTML = "<tr><td colspan='4'>ë¡œë”© ì‹¤íŒ¨</td></tr>"; } showLoading(false);
        };

        window.refreshData = () => { 
            const activeTabBtn = document.querySelector('.tab-btn.active');
            if (activeTabBtn) {
                const idx = Array.from(document.querySelectorAll('.tab-btn')).indexOf(activeTabBtn);
                if (idx === 0) loadAllUsersAndApps(); 
                else Swal.fire("ì•Œë¦¼", "ë‹¤ë¥¸ íƒ­ì€ [ì¡°íšŒ] ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.", "info");
            }
        };

        window.registerThisDevice = () => { if(confirm("ì´ PCë¥¼ í‚¤ì˜¤ìŠ¤í¬ë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.setItem('kiosk_auth_token', 'dream_center_pc'); Swal.fire("ë“±ë¡ ì™„ë£Œ", "", "success"); } };
        window.unregisterThisDevice = () => { if(confirm("ë“±ë¡ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { localStorage.removeItem('kiosk_auth_token'); Swal.fire("í•´ì œ ì™„ë£Œ", "", "info"); } };
        window.viewPw = (pw) => Swal.fire('ë¹„ë°€ë²ˆí˜¸', pw, 'info');
        window.changePw = async (userId) => { const { value: np } = await Swal.fire({ title: 'ìƒˆ ë¹„ë°€ë²ˆí˜¸', input: 'text', showCancelButton: true }); if (np) { await updateDoc(doc(db, "users", userId), { password: np }); Swal.fire('ì™„ë£Œ', 'ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); } };
        window.deleteUser = async (userId, name) => { if(confirm(`${name} íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) { await deleteDoc(doc(db, "users", userId)); loadAllUsersAndApps(); } };
        window.downloadTableAsExcel = (id, name) => { const wb = XLSX.utils.table_to_book(document.getElementById(id)); XLSX.writeFile(wb, name + ".xlsx"); };
        window.generateSettlementPDF = () => { const zone = document.getElementById('hidden-print-zone'); const start = document.getElementById('settleStart').value; const end = document.getElementById('settleEnd').value; const storeSelect = document.getElementById('settleStore'); const store = storeSelect.options[storeSelect.selectedIndex].text; const count = document.getElementById('sumCount').innerText; const price = document.getElementById('sumPrice').innerText; const unpaid = document.getElementById('sumUnpaid').innerText; const originalTable = document.getElementById('settleTable').cloneNode(true); originalTable.className = "report-table"; originalTable.querySelectorAll('tr').forEach(row => { const cells = row.querySelectorAll('th, td'); if (cells.length > 0) cells[cells.length - 1].remove(); }); zone.innerHTML = `<div class="report-header"><h1 class="report-title">ê¸‰ì‹ ì •ì‚° ë‚´ì—­ì„œ</h1><div class="report-sub">ê¸°ê°„: ${start} ~ ${end} | ì—…ì²´: ${store}</div></div><div class="report-summary-box"><div>ì´ ê±´ìˆ˜: ${count}</div><div>ì´ ë§¤ì¶œ: ${price}</div><div style="color:#c62828">ë¯¸ì§€ê¸‰ì•¡: ${unpaid}</div></div>`; zone.appendChild(originalTable); downloadPDFFromElement(zone, `ì •ì‚°ë‚´ì—­ì„œ_${start}`); };
        window.generateRecordPDF = () => { const zone = document.getElementById('hidden-print-zone'); const start = document.getElementById('recStart').value; const originalTable = document.getElementById('recordTable').cloneNode(true); originalTable.className = "report-table"; zone.innerHTML = `<div class="report-header"><h1 class="report-title">ì²­ì†Œë…„ í†µí•© í™œë™ ê¸°ë¡ë¶€</h1><div class="report-sub">ê¸°ê°„: ${start} ~ ...</div></div>`; zone.appendChild(originalTable); downloadPDFFromElement(zone, `í™œë™ê¸°ë¡ë¶€_${start}`); };
        function downloadPDFFromElement(element, fileName) { showLoading(true); element.style.opacity = 1; setTimeout(() => { html2canvas(element, { scale: 2, useCORS: true, logging: false }).then(canvas => { const imgData = canvas.toDataURL('image/png'); const pdf = new jspdf.jsPDF('p', 'mm', 'a4'); const imgWidth = 210; const pageHeight = 297; const imgHeight = (canvas.height * imgWidth / canvas.width) || 20; let heightLeft = imgHeight; let position = 0; pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= pageHeight; while (heightLeft > 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= pageHeight; } pdf.save(fileName + ".pdf"); element.innerHTML = ""; element.style.opacity = 0; showLoading(false); }).catch(err => { console.error(err); alert("PDF ìƒì„± ì˜¤ë¥˜"); element.style.opacity = 0; showLoading(false); }); }, 500); }
    </script>
</body>
</html>
