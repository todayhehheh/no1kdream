<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="css/style.css">

    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        .glass-container { max-width: 1200px; padding: 25px; }
        h1 { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        
        /* [ìˆ˜ì •] ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .refresh-btn { background: rgba(255, 255, 255, 0.8); border: 1px solid #ccc; padding: 8px 15px; border-radius: 12px; cursor: pointer; transition: 0.2s; font-size: 16px; }
        .refresh-btn:hover { background: white; transform: rotate(180deg); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .refresh-btn:active { transform: scale(0.95); }

        .tabs { display: flex; gap: 10px; margin-bottom: 25px; background: rgba(255, 255, 255, 0.4); padding: 5px; border-radius: 20px; }
        .tab-btn { flex: 1; padding: 12px; border: none; background: transparent; border-radius: 15px; cursor: pointer; font-weight: 700; color: #636e72; font-size: 15px; transition: 0.3s; }
        .tab-btn.active { background: white; color: #6C5CE7; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); }
        .tab-btn:hover:not(.active) { background: rgba(255, 255, 255, 0.5); }
        .table-box { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.03); animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 15px; font-size: 14px; }
        th { background-color: #f8f9fa; color: #2d3436; font-weight: 700; padding: 12px; border-bottom: 2px solid #edeff2; text-align: center; }
        td { padding: 12px; border-bottom: 1px solid #f1f2f6; vertical-align: middle; color: #2d3436; text-align: center; }
        tr:hover td { background-color: #f8f9fa; }
        .btn-small { padding: 5px 10px; border-radius: 8px; border: none; cursor: pointer; font-size: 12px; font-weight: bold; margin: 0 2px; transition: 0.2s; }
        .btn-blue { background: #e3f2fd; color: #1e88e5; }
        .btn-blue:hover { background: #1e88e5; color: white; }
        .btn-red { background: #ffebee; color: #e53935; }
        .btn-red:hover { background: #e53935; color: white; }
        .btn-green { background: #e8f5e9; color: #43a047; }
        .store-toggles { display: flex; gap: 4px; justify-content: center; }
        .toggle-btn { padding: 6px 10px; border: 1px solid #eee; background: white; color: #b2bec3; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 11px; transition: 0.2s; }
        .toggle-btn:hover { background: #f8f9fa; }
        .toggle-btn.active-dalin { background: #fff8e1; color: #ff6f00; border-color: #ffca28; }
        .toggle-btn.active-mystery { background: #f3e5f5; color: #7b1fa2; border-color: #ce93d8; }
        .toggle-btn.active-yeon { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
        .filter-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 20px; flex-wrap: wrap; background: #fafafa; padding: 15px; border-radius: 15px; }
        .filter-bar label { font-size: 13px; font-weight: bold; color: #636e72; }
        .filter-bar select, .filter-bar input { border: 1px solid #ddd; padding: 8px; border-radius: 8px; outline: none; }
        .summary-box { background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-radius: 15px; margin-bottom: 20px; display: flex; justify-content: space-around; font-weight: 700; color: #1565c0; }
        .ad-setting-box { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .ad-card { background: #fafafa; padding: 20px; border-radius: 15px; border: 1px solid #eee; }

        #hidden-print-zone {
            position: fixed;
            top: 0;
            left: 0;
            width: 210mm; 
            min-height: 297mm;
            background: white; 
            z-index: -9999;
            padding: 20mm;
            box-sizing: border-box;
            font-family: 'Pretendard', sans-serif;
        }

        .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 15px; }
        .report-title { font-size: 28px; font-weight: bold; margin: 0 0 10px 0; color: #000; }
        .report-summary-box {
            border: 2px solid #333;
            background-color: #f8f9fa;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
            font-weight: bold;
            color: #000;
            font-size: 14px;
        }
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .report-table th, .report-table td { border: 1px solid #999; padding: 10px; text-align: center; color: #000; }
        .report-table th { background-color: #eee; }
    </style>
</head>

<body>
<button class="btn-small" style="background:#555; color:white; margin-left:10px;" onclick="registerThisDevice()">ğŸ–¥ï¸ í˜„ì¬ ê¸°ê¸° í‚¤ì˜¤ìŠ¤í¬ë¡œ ë“±ë¡</button>

<script>
    // ... ê¸°ì¡´ ì½”ë“œ ...

    // [ì‹ ê·œ] ê¸°ê¸° ë“±ë¡ í•¨ìˆ˜
    window.registerThisDevice = () => {
        const pw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸(1388)ë¥¼ ì…ë ¥í•˜ë©´ ì´ ê¸°ê¸°ê°€ í‚¤ì˜¤ìŠ¤í¬ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.");
        if(pw === "1388") {
            localStorage.setItem('kiosk_auth_token', 'dream_center_pc');
            alert("âœ… ë“±ë¡ ì™„ë£Œ!\nì´ì œ index.html(í‚¤ì˜¤ìŠ¤í¬)ì— ì ‘ì†í•˜ë©´ ì •ìƒì ìœ¼ë¡œ í™”ë©´ì´ ëœ¹ë‹ˆë‹¤.");
        } else {
            alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
        }
    };
</script>
    <div id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="glass-container">
        <h1>
            <span>ğŸ“‹ ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</span>
            <button class="refresh-btn" onclick="refreshData()" title="ë°ì´í„° ê°±ì‹  (ë¹„ë°€ë²ˆí˜¸ ìœ ì§€)">ğŸ”„</button>
        </h1>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('users')">1. ì „ì²´ ì²­ì†Œë…„ & ê¸‰ì‹</button>
            <button class="tab-btn" onclick="switchTab('settlement')">2. ì •ì‚° ê´€ë¦¬</button>
            <button class="tab-btn" onclick="switchTab('records')">3. í†µí•© ê¸°ë¡</button>
            <button class="tab-btn" onclick="switchTab('ads')">4. ê´‘ê³  ì„¤ì •</button>
        </div>

        <div id="tab-users" class="table-box">
            <div style="margin-bottom: 10px; color:#555; font-size:14px;">ğŸ“… <strong>ì˜¤ëŠ˜ (<span id="todayDisplay"></span>)</strong> ê¸°ì¤€ ì „ì²´ ë¦¬ìŠ¤íŠ¸</div>
            <table>
                <thead>
                    <tr>
                        <th width="15%">ì´ë¦„</th>
                        <th width="15%">ìƒíƒœ</th>
                        <th width="35%">ìŠ¹ì¸/ë³€ê²½</th>
                        <th width="25%">ê³„ì •</th>
                        <th width="10%">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="userTableBody">
                    <tr><td colspan="5">ë¡œë”© ì¤‘...</td></tr>
                </tbody>
            </table>
        </div>

        <div id="tab-settlement" class="table-box" style="display:none;">
            <div class="filter-bar">
                <label>ê¸°ê°„:</label><input type="date" id="settleStart"> ~ <input type="date" id="settleEnd">
                <label>ì—…ì²´:</label><select id="settleStore">
                    <option value="all">ì „ì²´</option>
                    <option value="ë‹¬ì¸ë³´ìŒˆ">ë‹¬ì¸ë³´ìŒˆ</option>
                    <option value="ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹">ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹</option>
                    <option value="ì—°ê¹€ë°¥">ì—°ê¹€ë°¥</option>
                </select>
                <label>ìƒíƒœ:</label><select id="settleStatus">
                    <option value="all">ì „ì²´</option>
                    <option value="no">âŒ ë¯¸ì •ì‚°</option>
                    <option value="yes">âœ… ì •ì‚°ì™„ë£Œ</option>
                </select>
                <button class="btn-small btn-blue" onclick="loadSettlementData()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('settleTable', 'ì •ì‚°ë‚´ì—­')">ì—‘ì…€</button>
                <button class="btn-small btn-red" onclick="generateSettlementPDF()">PDF</button>
            </div>
            <div class="summary-box">
                <span>ì´ ê±´ìˆ˜: <span id="sumCount">0</span></span>
                <span>ì´ ë§¤ì¶œ: <span id="sumPrice">0</span></span>
                <span style="color:#c62828">ë¯¸ì •ì‚°(ì§€ê¸‰ì˜ˆì •): <span id="sumUnpaid">0</span></span>
            </div>
            <table id="settleTable">
                <thead>
                    <tr>
                        <th>ë‚ ì§œ</th>
                        <th>ì´ë¦„</th>
                        <th>ì—…ì²´</th>
                        <th>ê¸ˆì•¡</th>
                        <th>ì •ì‚°ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody id="settleBody"></tbody>
            </table>
        </div>

        <div id="tab-records" class="table-box" style="display:none;">
            <div class="filter-bar">
                <label>ê¸°ê°„:</label><input type="date" id="recStart"> ~ <input type="date" id="recEnd">
                <label>í™œë™:</label><select id="recActivity">
                    <option value="">ì „ì²´</option>
                    <option value="ê¸°ì´ˆì†Œì–‘êµìœ¡">ê¸°ì´ˆì†Œì–‘</option>
                    <option value="í”„ë¡œê·¸ë¨">í”„ë¡œê·¸ë¨</option>
                    <option value="ìŠ¤í„°ë””ì¹´í˜">ìŠ¤í„°ë””</option>
                </select>
                <button class="btn-small btn-blue" onclick="loadRecords()">ì¡°íšŒ</button>
                <button class="btn-small btn-green" onclick="downloadTableAsExcel('recordTable', 'í™œë™ê¸°ë¡')">ì—‘ì…€</button>
                <button class="btn-small btn-red" onclick="generateRecordPDF()">PDF</button>
            </div>
            <table id="recordTable">
                <thead>
                    <tr>
                        <th>ì´ë¦„</th>
                        <th>ì¼ì</th>
                        <th>í™œë™ë‚´ì—­</th>
                    </tr>
                </thead>
                <tbody id="recBody"></tbody>
            </table>
        </div>

        <div id="tab-ads" class="table-box" style="display:none;">
            <h2>ğŸ“¢ í‚¤ì˜¤ìŠ¤í¬ ê´‘ê³  ë°°ë„ˆ ì„¤ì •</h2>
            <div class="ad-setting-box">
                <div class="ad-card">
                    <h3>ê´‘ê³  1 (ì™¼ìª½)</h3>
                    <div class="input-group">
                        <label>ì´ë¯¸ì§€ ì£¼ì†Œ (URL)</label>
                        <input type="text" id="ad1Img" class="input-field" placeholder="https://...">
                    </div>
                    <div class="input-group">
                        <label>í´ë¦­ ë§í¬</label>
                        <input type="text" id="ad1Link" class="input-field" placeholder="https://...">
                    </div>
                </div>
                <div class="ad-card">
                    <h3>ê´‘ê³  2 (ì˜¤ë¥¸ìª½)</h3>
                    <div class="input-group">
                        <label>ì´ë¯¸ì§€ ì£¼ì†Œ (URL)</label>
                        <input type="text" id="ad2Img" class="input-field" placeholder="https://...">
                    </div>
                    <div class="input-group">
                        <label>í´ë¦­ ë§í¬</label>
                        <input type="text" id="ad2Link" class="input-field" placeholder="https://...">
                    </div>
                </div>
            </div>
            <button class="btn btn-primary" style="width:100%; margin-top:20px; padding:15px;" onclick="saveAds()">ì„¤ì • ì €ì¥ ë° ë°˜ì˜</button>
        </div>
    </div>

    <div id="hidden-print-zone"></div>

    <script type="module">
        import { db, collection, getDocs, getDoc, setDoc, query, where, orderBy, updateDoc, addDoc, deleteDoc, doc, Timestamp } from "./js/firebase-config.js";

        const ADMIN_PW = "1388";
        const showLoading = (show) => { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }

        const getTodayStr = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        };

        window.onload = async () => {
            const { value: inputPw } = await Swal.fire({
                title: 'ê´€ë¦¬ì ì ‘ì†',
                input: 'password',
                inputPlaceholder: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                allowOutsideClick: false
            });

            if (inputPw !== ADMIN_PW) {
                document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px; color:red;'>â›” ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</h2>";
                return;
            }

            const todayStr = getTodayStr();
            const monthAgo = new Date(); monthAgo.setMonth(monthAgo.getMonth() - 1);
            const monthAgoStr = monthAgo.toISOString().split('T')[0];

            document.getElementById('todayDisplay').innerText = todayStr;
            document.getElementById('settleStart').value = monthAgoStr;
            document.getElementById('settleEnd').value = todayStr;
            document.getElementById('recStart').value = monthAgoStr;
            document.getElementById('recEnd').value = todayStr;

            loadAllUsersAndApps();
        };

        // [ì‹ ê·œ] ìƒˆë¡œê³ ì¹¨ í•¨ìˆ˜: í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì§€ ì•Šê³ , í˜„ì¬ ë³´ê³  ìˆëŠ” íƒ­ì˜ ë°ì´í„°ë§Œ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜µë‹ˆë‹¤.
        window.refreshData = () => {
            // í˜„ì¬ í™œì„±í™”ëœ(ë³´ì´ëŠ”) íƒ­ì´ ë¬´ì—‡ì¸ì§€ í™•ì¸
            if (document.getElementById('tab-users').style.display !== 'none') {
                loadAllUsersAndApps();
            } else if (document.getElementById('tab-settlement').style.display !== 'none') {
                loadSettlementData();
            } else if (document.getElementById('tab-records').style.display !== 'none') {
                loadRecords();
            } else if (document.getElementById('tab-ads').style.display !== 'none') {
                loadAds();
            }
            
            // í† ìŠ¤íŠ¸ ì•Œë¦¼ìœ¼ë¡œ ê°±ì‹ ë˜ì—ˆë‹¤ê³  ì•Œë ¤ì¤Œ
            const Toast = Swal.mixin({
                toast: true, position: 'top-end', showConfirmButton: false, timer: 1000,
                timerProgressBar: true
            });
            Toast.fire({ icon: 'success', title: 'ë°ì´í„°ê°€ ê°±ì‹ ë˜ì—ˆìŠµë‹ˆë‹¤.' });
        };

        // --- Tab Logic ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.table-box').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).style.display = 'block';

            const btns = document.querySelectorAll('.tab-btn');
            if (tabName == 'users') btns[0].classList.add('active');
            if (tabName == 'settlement') btns[1].classList.add('active');
            if (tabName == 'records') btns[2].classList.add('active');
            if (tabName == 'ads') btns[3].classList.add('active');

            // íƒ­ ëˆ„ë¥¼ ë•Œë„ ìë™ìœ¼ë¡œ ë°ì´í„° ë¡œë“œ
            if (tabName === 'users') loadAllUsersAndApps();
            if (tabName === 'ads') loadAds();
        };

        // --- TAB 1 Logic ---
        window.loadAllUsersAndApps = async () => {
            showLoading(true);
            const today = getTodayStr();
            const tbody = document.getElementById('userTableBody');
            tbody.innerHTML = "<tr><td colspan='5'>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>";

            try {
                const userSnap = await getDocs(query(collection(db, "users"), orderBy("name")));
                const appSnap = await getDocs(query(collection(db, "meal_applications"), where("date", "==", today)));

                let appsMap = {};
                appSnap.forEach(doc => {
                    const d = doc.data();
                    if (!appsMap[d.student_id]) appsMap[d.student_id] = [];
                    appsMap[d.student_id].push({ docId: doc.id, ...d });
                });

                tbody.innerHTML = "";
                if (userSnap.empty) { tbody.innerHTML = "<tr><td colspan='5'>ê°€ì…ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; showLoading(false); return; }

                userSnap.forEach(userDoc => {
                    const u = userDoc.data();
                    const userId = userDoc.id;
                    const studentApps = appsMap[userId] || [];

                    let activeApp = studentApps.find(app => app.status === 'applied' || app.status === 'approved');
                    let completedCount = studentApps.filter(app => app.status === 'completed').length;

                    let statusText = `<span class="badge" style="color:#aaa; background:#f1f2f6;">ë¯¸ì‹ ì²­</span>`;
                    let buttonsHtml = '';
                    let countBadge = completedCount > 0 ? `<span style="font-size:11px; background:#efefef; padding:2px 6px; border-radius:10px; margin-left:5px;">(${completedCount}íšŒ ì™„ë£Œ)</span>` : '';

                    if (activeApp) {
                        const store = activeApp.store_name;
                        const status = activeApp.status;
                        const appId = activeApp.docId;

                        if (status === 'applied') statusText = `<span class="badge badge-blue" style="color:#2196F3; font-weight:bold;">${store} (ì‹ ì²­)</span>`;
                        else statusText = `<span class="badge badge-green" style="background:#fff8e1; color:#ff6f00; font-weight:bold;">${store} (ìŠ¹ì¸ë¨)</span>`;

                        statusText += countBadge;

                        const cD = store === 'ë‹¬ì¸ë³´ìŒˆ' ? 'active-dalin' : '';
                        const cM = store === 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹' ? 'active-mystery' : '';
                        const cY = store === 'ì—°ê¹€ë°¥' ? 'active-yeon' : '';

                        buttonsHtml = `<div class="store-toggles">
                            <button class="toggle-btn ${cD}" onclick="changeStore('${appId}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button>
                            <button class="toggle-btn ${cM}" onclick="changeStore('${appId}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
                            <button class="toggle-btn ${cY}" onclick="changeStore('${appId}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
                        </div>`;
                    } else {
                        if (completedCount > 0) statusText = `<span class="badge badge-green" style="color:#43a047; font-weight:bold;">ì‹ì‚¬ ì™„ë£Œ</span> ` + countBadge;
                        else statusText = `<span style="color:#bdc3c7; font-size:12px;">ë¯¸ì‹ ì²­</span>`;

                        buttonsHtml = `<div class="store-toggles">
                            <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button>
                            <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
                            <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
                        </div>`;
                    }

                    tbody.innerHTML += `<tr>
                        <td><div style="font-weight:bold;">${u.name}</div><div style="font-size:12px; color:#888;">${u.birth}</div></td>
                        <td>${statusText}</td>
                        <td>${buttonsHtml}</td>
                        <td><button class="btn-small" onclick="viewPw('${u.password}')">ë¹„ë²ˆ</button><button class="btn-small btn-blue" onclick="changePw('${userId}', '${u.name}')">ë³€ê²½</button></td>
                        <td><button class="btn-small btn-red" onclick="deleteUser('${userId}', '${u.name}')">ì‚­ì œ</button></td>
                    </tr>`;
                });
                showLoading(false);
            } catch (e) { console.error(e); showLoading(false); Swal.fire('Error', 'ë°ì´í„° ë¡œë”© ì‹¤íŒ¨', 'error'); }
        };

        window.changeStore = async (docId, newStore) => {
            if ((await Swal.fire({ title: `[${newStore}]ë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, showCancelButton: true })).isConfirmed) {
                await updateDoc(doc(db, "meal_applications", docId), { store_name: newStore, status: "approved" });
                loadAllUsersAndApps();
            }
        };

        window.forceApprove = async (userId, userName, storeName) => {
            if ((await Swal.fire({ title: `[${userName}] â†’ [${storeName}] ìŠ¹ì¸?`, showCancelButton: true })).isConfirmed) {
                const today = getTodayStr();
                await addDoc(collection(db, "meal_applications"), {
                    student_id: userId, student_name: userName, store_name: storeName,
                    status: "approved", date: today, activity: "ê¸°ì´ˆì†Œì–‘êµìœ¡", timestamp: Timestamp.now()
                });
                loadAllUsersAndApps();
            }
        };

        window.viewPw = (pw) => Swal.fire('ë¹„ë°€ë²ˆí˜¸', pw, 'info');
        window.changePw = async (userId, name) => {
            const { value: np } = await Swal.fire({ title: 'ìƒˆ ë¹„ë°€ë²ˆí˜¸', input: 'text', showCancelButton: true });
            if (np) { await updateDoc(doc(db, "users", userId), { password: np }); Swal.fire('ì™„ë£Œ', 'ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); }
        };
        window.deleteUser = async (userId, name) => {
            const { value: pw } = await Swal.fire({ title: 'ê´€ë¦¬ì ì•”í˜¸(1388)', input: 'password', showCancelButton: true });
            if (pw === ADMIN_PW) {
                if ((await Swal.fire({ title: `ì •ë§ ${name}ë‹˜ì„ ì‚­ì œí•©ë‹ˆê¹Œ?`, icon: 'warning', showCancelButton: true })).isConfirmed) {
                    await deleteDoc(doc(db, "users", userId));
                    Swal.fire('ì‚­ì œ ì™„ë£Œ', '', 'success');
                    loadAllUsersAndApps();
                }
            } else if (pw) Swal.fire('ì•”í˜¸ ì˜¤ë¥˜', '', 'error');
        };

        // --- TAB 2, 3 Logic ---
        window.loadSettlementData = async () => {
            showLoading(true);
            const start = document.getElementById('settleStart').value;
            const end = document.getElementById('settleEnd').value;
            const targetStore = document.getElementById('settleStore').value;
            const targetStatus = document.getElementById('settleStatus').value;
            const tbody = document.getElementById('settleBody');
            tbody.innerHTML = "";

            try {
                let userMap = {}; const uSnap = await getDocs(collection(db, "users")); uSnap.forEach(d => userMap[d.id] = d.data());
                const snap = await getDocs(query(collection(db, "meal_applications"), orderBy("date", "desc")));

                let list = []; let totalCnt = 0; let totalPrice = 0; let totalUnpaid = 0;

                snap.forEach(doc => {
                    const d = doc.data();
                    if (d.date < start || d.date > end) return;
                    if (targetStore !== 'all' && d.store_name !== targetStore) return;
                    const isSettled = d.is_settled === true;
                    if (targetStatus === 'no' && isSettled) return;
                    if (targetStatus === 'yes' && !isSettled) return;
                    const price = d.amount ? Number(d.amount) : 0;
                    if (price === 0) return;

                    const u = userMap[d.student_id] || { name: d.student_name, birth: '' };
                    totalCnt++; totalPrice += price; if (!isSettled) totalUnpaid += price;

                    list.push({ id: doc.id, ...d, price, isSettled, uName: u.name, uBirth: u.birth });
                });

                document.getElementById('sumCount').innerText = totalCnt;
                document.getElementById('sumPrice').innerText = totalPrice.toLocaleString();
                document.getElementById('sumUnpaid').innerText = totalUnpaid.toLocaleString();

                if (list.length === 0) tbody.innerHTML = "<tr><td colspan='5'>ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";

                list.forEach(item => {
                    const statusHtml = item.isSettled ?
                        `<button class="btn-small btn-green" onclick="toggleSettle('${item.id}', false)">âœ… ì •ì‚°ì™„ë£Œ</button>` :
                        `<button class="btn-small btn-red" onclick="toggleSettle('${item.id}', true)">âŒ ë¯¸ì •ì‚°</button>`;
                    tbody.innerHTML += `<tr><td>${item.date}</td><td>${item.uName}</td><td>${item.store_name}</td><td>${item.price.toLocaleString()}ì›</td><td>${statusHtml}</td></tr>`;
                });
            } catch (e) { console.error(e); }
            showLoading(false);
        };

        window.toggleSettle = async (id, state) => {
            if ((await Swal.fire({ title: 'ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', showCancelButton: true })).isConfirmed) {
                await updateDoc(doc(db, "meal_applications", id), { is_settled: state });
                loadSettlementData();
            }
        };

        window.loadRecords = async () => {
            showLoading(true);
            const start = document.getElementById('recStart').value;
            const end = document.getElementById('recEnd').value;
            const selectedActivity = document.getElementById('recActivity').value;
            const tbody = document.getElementById('recBody');
            tbody.innerHTML = "";

            try {
                let userMap = {}; const uSnap = await getDocs(collection(db, "users")); uSnap.forEach(d => userMap[d.id] = d.data());
                let dailyRecordMap = {};

                const process = (doc, type, priority) => {
                    const d = doc.data();
                    if (d.date < start || d.date > end) return;
                    const u = userMap[d.student_id] || { name: d.student_name, birth: '' };
                    let act = d.activity || (type === 'meal' ? d.store_name + "(ì‹ì‚¬)" : "ê°„ì‹");
                    if (selectedActivity && act !== selectedActivity) return;

                    const key = `${d.date}_${d.student_id}`;
                    if (!dailyRecordMap[key] || dailyRecordMap[key].priority < priority) {
                        dailyRecordMap[key] = { priority: priority, date: d.date, name: `${u.name} (${u.birth})`, activity: act, sortName: u.name };
                    }
                };

                const attSnap = await getDocs(query(collection(db, "attendance"), orderBy("date", "desc"))); attSnap.forEach(doc => process(doc, "attendance", 3));
                const mealSnap = await getDocs(query(collection(db, "meal_applications"), orderBy("date", "desc"))); mealSnap.forEach(doc => process(doc, "meal", 2));
                const snackSnap = await getDocs(query(collection(db, "snacks"), orderBy("date", "desc"))); snackSnap.forEach(doc => process(doc, "snack", 1));

                let finalRecords = Object.values(dailyRecordMap);
                finalRecords.sort((a, b) => b.date.localeCompare(a.date) || a.sortName.localeCompare(b.sortName));

                if (finalRecords.length === 0) tbody.innerHTML = "<tr><td colspan='3'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                finalRecords.forEach(r => tbody.innerHTML += `<tr><td>${r.name}</td><td>${r.date}</td><td>${r.activity}</td></tr>`);
            } catch (e) { console.error(e); }
            showLoading(false);
        };

        window.loadAds = async () => { /* ê¸°ì¡´ ì½”ë“œ ìœ ì§€ */ };
        window.saveAds = async () => { /* ê¸°ì¡´ ì½”ë“œ ìœ ì§€ */ };
        window.downloadTableAsExcel = (id, name) => { const wb = XLSX.utils.table_to_book(document.getElementById(id)); XLSX.writeFile(wb, name + ".xlsx"); };

        window.generateSettlementPDF = () => {
            const zone = document.getElementById('hidden-print-zone');
            const start = document.getElementById('settleStart').value;
            const end = document.getElementById('settleEnd').value;
            const store = document.getElementById('settleStore').options[document.getElementById('settleStore').selectedIndex].text;

            const count = document.getElementById('sumCount').innerText;
            const price = document.getElementById('sumPrice').innerText;
            const unpaid = document.getElementById('sumUnpaid').innerText;

            const originalTable = document.getElementById('settleTable').cloneNode(true);
            originalTable.className = "report-table";
            const rows = originalTable.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                if (cells.length > 0) cells[cells.length - 1].remove(); 
            });

            zone.innerHTML = `
                <div class="report-header">
                    <h1 class="report-title">ê¸‰ì‹ ì •ì‚° ë‚´ì—­ì„œ</h1>
                    <div style="margin-top:10px;">ê¸°ê°„: ${start} ~ ${end} | ì—…ì²´: ${store}</div>
                </div>
                <div class="report-summary-box">
                    <div>ì´ ê±´ìˆ˜: ${count}</div>
                    <div>ì´ ë§¤ì¶œ: ${price}</div>
                    <div style="color:#c62828">ë¯¸ì •ì‚° ì”ì•¡: ${unpaid}</div>
                </div>
            `;
            zone.appendChild(originalTable);
            downloadPDFFromElement(zone, `ì •ì‚°ë‚´ì—­ì„œ_${start}`);
        };

        window.generateRecordPDF = () => {
            const zone = document.getElementById('hidden-print-zone');
            const start = document.getElementById('recStart').value;
            const originalTable = document.getElementById('recordTable').cloneNode(true);
            originalTable.className = "report-table";
            zone.innerHTML = `<div class="report-header"><h1 class="report-title">ì²­ì†Œë…„ í†µí•© í™œë™ ê¸°ë¡ë¶€</h1><div style="margin-top:10px;">ê¸°ê°„: ${start} ~ ...</div></div>`;
            zone.appendChild(originalTable);
            downloadPDFFromElement(zone, `í™œë™ê¸°ë¡ë¶€_${start}`);
        };

        function downloadPDFFromElement(element, fileName) {
            setTimeout(() => {
                html2canvas(element, { scale: 2, useCORS: true, logging: false, allowTaint: true }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                    const imgWidth = 210; const pageHeight = 297;
                    const imgHeight = (canvas.height * imgWidth / canvas.width) || 20;
                    let heightLeft = imgHeight; let position = 0;

                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    while (heightLeft > 0) { position = heightLeft - imgHeight; pdf.addPage(); pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight); heightLeft -= pageHeight; }
                    pdf.save(fileName + ".pdf"); element.innerHTML = "";
                }).catch(err => { console.error(err); alert("PDF ìƒì„± ì¤‘ ì˜¤ë¥˜"); element.innerHTML = ""; });
            }, 100);
        }
    </script>
</body>
</html>

