<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f5f7fa; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        h1 { color: #333; display: flex; justify-content: space-between; align-items: center; }
        .refresh-btn { background: #333; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; }

        /* íƒ­ ë©”ë‰´ */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 15px; }
        .tab-btn { padding: 12px 25px; border: none; background: #eee; border-radius: 20px; cursor: pointer; font-weight: bold; color: #666; font-size: 15px; transition: 0.2s; }
        .tab-btn.active { background: #333; color: white; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        /* í…Œì´ë¸” ë°•ìŠ¤ */
        .table-box { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th, td { padding: 10px; text-align: center; border-bottom: 1px solid #eee; vertical-align: middle; }
        th { background-color: #f1f3f5; color: #333; font-weight: bold; }
        tr:hover { background-color: #f9f9f9; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-small { padding: 6px 12px; border-radius: 6px; border: 1px solid #ddd; cursor: pointer; background: white; font-size: 13px; font-weight: bold; margin: 0 2px; }
        .btn-blue { background: #2196F3; color: white; border: none; }
        .btn-red { background: #ffebee; color: #d32f2f; border: 1px solid #ffcdd2; }
        .btn-green { background: #e8f5e9; color: #2e7d32; border: 1px solid #a5d6a7; }
        .btn-excel { background: #217346; color: white; border: none; }
        .btn-pdf { background: #b71c1c; color: white; border: none; }
        
        /* ì‹ë‹¹ í† ê¸€ ë²„íŠ¼ */
        .store-toggles { display: flex; gap: 4px; justify-content: center; }
        .toggle-btn { padding: 6px 8px; border: 1px solid #ddd; background: #f9f9f9; color: #ccc; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .toggle-btn.active-dalin { background: #fff8e1; color: #ff6f00; border-color: #ffca28; }
        .toggle-btn.active-mystery { background: #f3e5f5; color: #7b1fa2; border-color: #ce93d8; }
        .toggle-btn.active-yeon { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }

        /* í•„í„° ë°” */
        .filter-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; flex-wrap: wrap; background: #fafafa; padding: 15px; border-radius: 8px; }
        input[type="date"], select, input[type="text"] { padding: 8px; border-radius: 6px; border: 1px solid #ddd; }
        
        /* í™”ë©´ í‘œì‹œìš© ì •ì‚° ìš”ì•½ */
        .summary-box { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-around; font-weight: bold; color: #0D47A1; }

        /* ========================================= */
        /* PDF ì¶œë ¥ìš© ìŠ¤íƒ€ì¼ (í™”ë©´ì—” ì•ˆ ë³´ì„) */
        /* ========================================= */
        #hidden-print-zone {
            position: absolute; top: -9999px; left: -9999px;
            width: 210mm; /* A4 ë„ˆë¹„ */
            background: white; padding: 20mm; box-sizing: border-box;
        }
        .report-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
        .report-title { font-size: 24px; font-weight: bold; color: #000; margin: 0 0 10px 0; }
        .report-info { font-size: 14px; color: #555; margin-bottom: 20px; }
        .report-summary { 
            border: 2px solid #333; background: #f8f9fa; padding: 15px; margin-bottom: 20px; 
            display: flex; justify-content: space-between; font-weight: bold; font-size: 16px; 
        }
        .report-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .report-table th, .report-table td { border: 1px solid #999; padding: 8px; text-align: center; }
        .report-table th { background: #eee; }
    </style>
</head>
<body>

<div class="container">
    <h1>
        <span>ğŸ“‹ ê¿ˆë“œë¦¼ í†µí•© ê´€ì œíƒ‘</span>
        <button class="refresh-btn" onclick="location.reload()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    </h1>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('users')">1. ì „ì²´ ì²­ì†Œë…„ & ê¸‰ì‹ê´€ë¦¬</button>
        <button class="tab-btn" onclick="switchTab('settlement')">2. ì •ì‚° ê´€ë¦¬</button>
        <button class="tab-btn" onclick="switchTab('records')">3. í†µí•© ê¸°ë¡ (ì¶œì„ë¶€)</button>
    </div>

    <div id="tab-users" class="table-box">
        <div style="margin-bottom: 10px; color:#555; font-size:14px;">
            ğŸ“¢ <strong>ì˜¤ëŠ˜({today})</strong> ê¸°ì¤€ ì „ì²´ í•™ìƒ ë¦¬ìŠ¤íŠ¸ (ì´ë¦„ìˆœ ì •ë ¬)
        </div>
        <table>
            <thead>
                <tr>
                    <th width="15%">ì´ë¦„ (ìƒë…„ì›”ì¼)</th>
                    <th width="10%">ì˜¤ëŠ˜ ìƒíƒœ</th>
                    <th width="35%">ê¸‰ì‹ ìŠ¹ì¸ / ë³€ê²½</th>
                    <th width="25%">ê³„ì • ê´€ë¦¬</th>
                    <th width="10%">ì‚­ì œ</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <tr><td colspan="5">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="tab-settlement" class="table-box" style="display:none;">
        <div class="filter-bar">
            <label>ê¸°ê°„:</label>
            <input type="date" id="settleStart"> ~ <input type="date" id="settleEnd">
            <label>ì—…ì²´:</label>
            <select id="settleStore">
                <option value="all">ì „ì²´ ì—…ì²´</option>
                <option value="ë‹¬ì¸ë³´ìŒˆ">ë‹¬ì¸ë³´ìŒˆ</option>
                <option value="ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹">ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹</option>
                <option value="ì—°ê¹€ë°¥">ì—°ê¹€ë°¥</option>
            </select>
            <button class="btn-small btn-blue" onclick="loadSettlementData()">ì¡°íšŒ</button>
            <button class="btn-small btn-excel" onclick="downloadTableAsExcel('settleTable', 'ì •ì‚°ë‚´ì—­')">ì—‘ì…€</button>
            <button class="btn-small btn-pdf" onclick="generateSettlementPDF()">ğŸ“„ ì •ì‚°ì„œ PDF ì¶œë ¥</button>
        </div>

        <div class="summary-box">
            <span>ì´ ê±´ìˆ˜: <span id="sumCount">0</span>ê±´</span>
            <span>ì´ ê¸ˆì•¡: <span id="sumPrice">0</span>ì›</span>
            <span style="color:#d32f2f">ë¯¸ì •ì‚°: <span id="sumUnpaid">0</span>ì›</span>
        </div>

        <table id="settleTable">
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>ì´ë¦„ (ìƒë…„ì›”ì¼)</th>
                    <th>ì—…ì²´ëª…</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ì •ì‚° ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody id="settleBody">
                <tr><td colspan="5">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
            </tbody>
        </table>
    </div>

    <div id="tab-records" class="table-box" style="display:none;">
        <div class="filter-bar">
            <label>ê¸°ê°„:</label>
            <input type="date" id="recStart"> ~ <input type="date" id="recEnd">
            <label>í™œë™ì„ íƒ:</label>
            <select id="recActivity" style="width: 150px;">
                <option value="">ì „ì²´ ë³´ê¸°</option>
                <option value="ê¸°ì´ˆì†Œì–‘êµìœ¡">ê¸°ì´ˆì†Œì–‘êµìœ¡</option>
                <option value="í”„ë¡œê·¸ë¨">í”„ë¡œê·¸ë¨</option>
                <option value="ìŠ¤í„°ë””ì¹´í˜">ìŠ¤í„°ë””ì¹´í˜</option>
            </select>
            
            <button class="btn-small btn-blue" onclick="loadRecords()">ì¡°íšŒ</button>
            <button class="btn-small btn-excel" onclick="downloadTableAsExcel('recordTable', 'í†µí•©í™œë™ê¸°ë¡')">ì—‘ì…€</button>
            <button class="btn-small btn-pdf" onclick="generateRecordPDF()">ğŸ“„ ê¸°ë¡ë¶€ PDF ì¶œë ¥</button>
        </div>

        <div style="font-size:13px; color:#666; margin-bottom:10px;">
            â„¹ï¸ <strong>1ì¼ 1ì¸ 1í–‰ ì›ì¹™:</strong> ì¶œì„ > ê¸‰ì‹ > ë¶€ì‹ ìˆœì„œë¡œ ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ í™œë™ í•˜ë‚˜ë§Œ í‘œì‹œë©ë‹ˆë‹¤.
        </div>

        <table id="recordTable">
            <thead>
                <tr>
                    <th>ì´ë¦„ (ìƒë…„ì›”ì¼)</th>
                    <th>ì¶œì„ ì¼ì</th>
                    <th>ëŒ€í‘œ í™œë™ ë‚´ìš©</th>
                </tr>
            </thead>
            <tbody id="recBody">
                <tr><td colspan="3">ì¡°íšŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</td></tr>
            </tbody>
        </table>
    </div>

</div>

<div id="hidden-print-zone"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, orderBy, updateDoc, deleteDoc, doc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAalHhoEK-ko55Jep-7k8ULHeaWWU99oh8",
      authDomain: "dream-meal-support.firebaseapp.com",
      projectId: "dream-meal-support",
      storageBucket: "dream-meal-support.firebasestorage.app",
      messagingSenderId: "230720243044",
      appId: "1:230720243044:web:eb38ecc28353a1c70aa671"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ADMIN_PW = "1388"; 

    // --- ì´ˆê¸°í™” ---
    window.onload = async () => {
        const inputPw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
        if(inputPw !== ADMIN_PW) { 
            document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px; color:red;'>â›” ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</h2>"; 
            return; 
        }

        const today = new Date();
        const monthAgo = new Date();
        monthAgo.setMonth(today.getMonth() - 1);
        const todayStr = today.toISOString().split('T')[0];
        const monthAgoStr = monthAgo.toISOString().split('T')[0];

        document.body.innerHTML = document.body.innerHTML.replace("{today}", todayStr);
        document.getElementById('settleStart').value = monthAgoStr;
        document.getElementById('settleEnd').value = todayStr;
        document.getElementById('recStart').value = monthAgoStr;
        document.getElementById('recEnd').value = todayStr;

        loadAllUsersAndApps(); 
    };

    // [TAB 1 ë¡œì§ ìƒëµ - ê¸°ì¡´ê³¼ ë™ì¼] 
    // ... (ì§€ë©´ ê´€ê³„ìƒ ì¤‘ë³µë˜ëŠ” loadAllUsersAndApps ë“±ì€ ê·¸ëŒ€ë¡œ ë‘ì—ˆë‹¤ê³  ê°€ì •í•˜ê³ , í•µì‹¬ì¸ PDF ë¶€ë¶„ë§Œ ë³€ê²½í•©ë‹ˆë‹¤) ...
    // ì‹¤ì œ ì‚¬ìš© ì‹œì—” ì´ì „ì— ì§  ì½”ë“œì˜ TAB 1 ë¡œì§ì„ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤.
    // í¸ì˜ë¥¼ ìœ„í•´ ë‹¤ì‹œ ì ì–´ë“œë¦½ë‹ˆë‹¤.

    window.loadAllUsersAndApps = async () => {
        const today = new Date().toISOString().split('T')[0];
        const tbody = document.getElementById('userTableBody');
        tbody.innerHTML = "<tr><td colspan='5'>ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>";

        try {
            const userSnap = await getDocs(query(collection(db, "users"), orderBy("name")));
            const appSnap = await getDocs(query(collection(db, "meal_applications"), where("date", "==", today)));
            
            let appsMap = {};
            appSnap.forEach(doc => { const d = doc.data(); appsMap[d.student_id] = { docId: doc.id, ...d }; });

            tbody.innerHTML = "";
            if(userSnap.empty) { tbody.innerHTML = "<tr><td colspan='5'>ê°€ì…ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; return; }

            userSnap.forEach(userDoc => {
                const u = userDoc.data();
                const userId = userDoc.id;
                const app = appsMap[userId];
                
                const store = app ? app.store_name : null;
                const statusText = store ? `<span style="color:#2196F3; font-weight:bold">${store}</span>` : `<span style="color:#aaa">ë¯¸ì‹ ì²­</span>`;
                const cD = store === 'ë‹¬ì¸ë³´ìŒˆ' ? 'active-dalin' : '';
                const cM = store === 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹' ? 'active-mystery' : '';
                const cY = store === 'ì—°ê¹€ë°¥' ? 'active-yeon' : '';
                const btnAttr = app ? '' : 'disabled style="opacity:0.3; cursor:not-allowed;"';
                const appId = app ? app.docId : '';

                tbody.innerHTML += `
                    <tr>
                        <td><div style="font-weight:bold;">${u.name}</div><div style="font-size:12px; color:#888;">${u.birth}</div></td>
                        <td>${statusText}</td>
                        <td><div class="store-toggles">
                            <button class="toggle-btn ${cD}" ${btnAttr} onclick="changeStore('${appId}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button>
                            <button class="toggle-btn ${cM}" ${btnAttr} onclick="changeStore('${appId}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
                            <button class="toggle-btn ${cY}" ${btnAttr} onclick="changeStore('${appId}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
                        </div></td>
                        <td><button class="btn-small" onclick="viewPw('${u.password}')">ë¹„ë²ˆí™•ì¸</button>
                            <button class="btn-small btn-blue" onclick="changePw('${userId}', '${u.name}')">ë³€ê²½</button></td>
                        <td><button class="btn-small btn-red" onclick="deleteUser('${userId}', '${u.name}')">ì‚­ì œ</button></td>
                    </tr>`;
            });
        } catch(e) { console.error(e); }
    };
    window.changeStore = async (docId, newStore) => { if(!docId || !confirm("ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return; await updateDoc(doc(db, "meal_applications", docId), { store_name: newStore, status: "approved" }); loadAllUsersAndApps(); };
    window.viewPw = (pw) => alert(`ë¹„ë°€ë²ˆí˜¸: ${pw}`);
    window.changePw = async (userId, name) => { const np = prompt("ìƒˆ ë¹„ë°€ë²ˆí˜¸:"); if(np) { await updateDoc(doc(db, "users", userId), { password: np }); alert("ë³€ê²½ì™„ë£Œ"); } };
    window.deleteUser = async (userId, name) => { if(prompt("ê´€ë¦¬ì ì•”í˜¸(1388):") === ADMIN_PW && confirm("ì‚­ì œí•©ë‹ˆê¹Œ?")) { await deleteDoc(doc(db, "users", userId)); alert("ì‚­ì œì™„ë£Œ"); loadAllUsersAndApps(); }};


    // --- TAB 2: ì •ì‚° ê´€ë¦¬ ë¡œì§ ---
    window.loadSettlementData = async () => {
        const start = document.getElementById('settleStart').value;
        const end = document.getElementById('settleEnd').value;
        const targetStore = document.getElementById('settleStore').value;
        const tbody = document.getElementById('settleBody');
        tbody.innerHTML = "<tr><td colspan='5'>ì¡°íšŒ ì¤‘...</td></tr>";

        let userMap = {};
        const uSnap = await getDocs(collection(db, "users"));
        uSnap.forEach(d => userMap[d.id] = d.data());

        const snap = await getDocs(query(collection(db, "meal_applications"), orderBy("date", "desc")));
        let list = [];
        let totalCnt = 0, totalPrice = 0, totalUnpaid = 0;

        snap.forEach(doc => {
            const d = doc.data();
            if(d.date < start || d.date > end) return;
            if(targetStore !== 'all' && d.store_name !== targetStore) return;
            const price = d.amount ? Number(d.amount) : 0;
            if(price === 0) return; 

            const u = userMap[d.student_id] || {name: d.student_name, birth: ''};
            const isSettled = d.is_settled === true;
            totalCnt++; totalPrice += price; if(!isSettled) totalUnpaid += price;

            list.push({ id: doc.id, ...d, price, isSettled, uName: u.name, uBirth: u.birth });
        });

        document.getElementById('sumCount').innerText = totalCnt;
        document.getElementById('sumPrice').innerText = totalPrice.toLocaleString();
        document.getElementById('sumUnpaid').innerText = totalUnpaid.toLocaleString();

        tbody.innerHTML = "";
        if(list.length === 0) { tbody.innerHTML = "<tr><td colspan='5'>ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; return; }

        list.forEach(item => {
            const statusHtml = item.isSettled ? `<span class="btn-green btn-small" onclick="toggleSettle('${item.id}', false)">âœ… ì™„ë£Œ</span>` : `<span class="btn-red btn-small" onclick="toggleSettle('${item.id}', true)">âŒ ë¯¸ì •ì‚°</span>`;
            tbody.innerHTML += `<tr><td>${item.date}</td><td>${item.uName} (${item.uBirth})</td><td>${item.store_name}</td><td>${item.price.toLocaleString()}ì›</td><td>${statusHtml}</td></tr>`;
        });
    };
    window.toggleSettle = async (id, state) => { if(confirm(state ? "ì •ì‚° ì™„ë£Œ?" : "ë¯¸ì •ì‚° ë³€ê²½?")) { await updateDoc(doc(db, "meal_applications", id), { is_settled: state }); loadSettlementData(); }};


    // --- TAB 3: í†µí•© ê¸°ë¡ ë¡œì§ ---
    window.loadRecords = async () => {
        const start = document.getElementById('recStart').value;
        const end = document.getElementById('recEnd').value;
        const selectedActivity = document.getElementById('recActivity').value;
        const tbody = document.getElementById('recBody');
        tbody.innerHTML = "<tr><td colspan='3'>ì²˜ë¦¬ ì¤‘...</td></tr>";

        let userMap = {};
        const uSnap = await getDocs(collection(db, "users"));
        uSnap.forEach(d => userMap[d.id] = d.data());

        let dailyRecordMap = {}; 
        const process = (doc, type, priority) => {
            const d = doc.data();
            if(d.date < start || d.date > end) return;
            const u = userMap[d.student_id] || {name: d.student_name, birth: ''};
            let act = d.activity || (type === 'meal' ? d.store_name+"(ì‹ì‚¬)" : "ê°„ì‹");
            if(selectedActivity && act !== selectedActivity) return;
            const key = `${d.date}_${d.student_id}`;
            if (!dailyRecordMap[key] || dailyRecordMap[key].priority < priority) {
                dailyRecordMap[key] = { priority: priority, date: d.date, name: `${u.name} (${u.birth})`, activity: act, sortName: u.name };
            }
        };

        const attSnap = await getDocs(query(collection(db, "attendance"), orderBy("date", "desc")));
        attSnap.forEach(doc => process(doc, "attendance", 3));
        const mealSnap = await getDocs(query(collection(db, "meal_applications"), orderBy("date", "desc")));
        mealSnap.forEach(doc => process(doc, "meal", 2));
        const snackSnap = await getDocs(query(collection(db, "snacks"), orderBy("date", "desc")));
        snackSnap.forEach(doc => process(doc, "snack", 1));

        let finalRecords = Object.values(dailyRecordMap);
        finalRecords.sort((a, b) => b.date.localeCompare(a.date) || a.sortName.localeCompare(b.sortName));

        tbody.innerHTML = "";
        if(finalRecords.length === 0) { tbody.innerHTML = "<tr><td colspan='3'>ê¸°ë¡ ì—†ìŒ</td></tr>"; return; }
        finalRecords.forEach(r => tbody.innerHTML += `<tr><td>${r.name}</td><td>${r.date}</td><td>${r.activity}</td></tr>`);
    };


    // ============================================================
    // âœ¨ í•µì‹¬: PDF ìƒì„± ê¸°ëŠ¥ (ì •ì‚°ì„œ & ê¸°ë¡ë¶€)
    // ============================================================
    
    // 1. ì •ì‚° ë‚´ì—­ì„œ PDF
    window.generateSettlementPDF = () => {
        const zone = document.getElementById('hidden-print-zone');
        const start = document.getElementById('settleStart').value;
        const end = document.getElementById('settleEnd').value;
        const store = document.getElementById('settleStore').options[document.getElementById('settleStore').selectedIndex].text;
        
        // ìš”ì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const count = document.getElementById('sumCount').innerText;
        const price = document.getElementById('sumPrice').innerText;
        const unpaid = document.getElementById('sumUnpaid').innerText;

        // ì›ë³¸ í…Œì´ë¸” ê°€ì ¸ì˜¤ê¸°
        const originalTable = document.getElementById('settleTable').cloneNode(true);
        // í…Œì´ë¸” ìŠ¤íƒ€ì¼ ê°•ì œ ì ìš© (PDFìš©)
        originalTable.className = "report-table";

        // HTML êµ¬ì„±
        zone.innerHTML = `
            <div class="report-header">
                <h1 class="report-title">ê¸‰ì‹ ì •ì‚° ë‚´ì—­ì„œ</h1>
                <div class="report-info">
                    ì¡°íšŒ ê¸°ê°„: ${start} ~ ${end} <br>
                    ëŒ€ìƒ ì—…ì²´: ${store}
                </div>
            </div>
            <div class="report-summary">
                <div>ì´ ì‹ ì²­: ${count}ê±´</div>
                <div>ì´ í•©ê³„: ${price}ì›</div>
                <div style="color:red">ë¯¸ì •ì‚° ì”ì•¡: ${unpaid}ì›</div>
            </div>
        `;
        zone.appendChild(originalTable);

        // PDF ë³€í™˜ ì‹¤í–‰
        downloadPDFFromElement(zone, `ì •ì‚°ë‚´ì—­ì„œ_${start}_${store}`);
    };

    // 2. í†µí•© í™œë™ ê¸°ë¡ë¶€ PDF
    window.generateRecordPDF = () => {
        const zone = document.getElementById('hidden-print-zone');
        const start = document.getElementById('recStart').value;
        const end = document.getElementById('recEnd').value;
        const act = document.getElementById('recActivity').value || "ì „ì²´ í™œë™";

        const originalTable = document.getElementById('recordTable').cloneNode(true);
        originalTable.className = "report-table";

        zone.innerHTML = `
            <div class="report-header">
                <h1 class="report-title">ì²­ì†Œë…„ í†µí•© í™œë™ ê¸°ë¡ë¶€</h1>
                <div class="report-info">
                    ì¡°íšŒ ê¸°ê°„: ${start} ~ ${end} <br>
                    ì„ íƒ í™œë™: ${act}
                </div>
            </div>
        `;
        zone.appendChild(originalTable);

        downloadPDFFromElement(zone, `í™œë™ê¸°ë¡ë¶€_${start}`);
    };

    // ê³µí†µ PDF ë‹¤ìš´ë¡œë“œ ë¡œì§
    function downloadPDFFromElement(element, fileName) {
        html2canvas(element, { scale: 2 }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
            const imgWidth = 210; // A4 ë„ˆë¹„
            const pageHeight = 297; 
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            
            pdf.save(fileName + ".pdf");
            // ë‚´ìš© ë¹„ìš°ê¸° (ë©”ëª¨ë¦¬ ì ˆì•½)
            element.innerHTML = "";
        });
    }

    window.switchTab = (tabName) => {
        document.querySelectorAll('.table-box').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById(`tab-${tabName}`).style.display = 'block';
        event.target.classList.add('active');
        if(tabName === 'users') loadAllUsersAndApps();
    };

    window.downloadTableAsExcel = (id, name) => {
        const wb = XLSX.utils.table_to_book(document.getElementById(id));
        XLSX.writeFile(wb, name + ".xlsx");
    };
</script>

</body>
</html>