<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ì´ˆì†Œì–‘êµìœ¡ - ê¿ˆë“œë¦¼</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Education Page Specific Styles */
        .header { text-align: center; margin-bottom: 30px; margin-top: 10px; }
        .header h1 { color: #2d3436; margin: 0; font-size: 28px; font-weight: 800; }
        .header p { color: #636e72; margin: 5px 0 0; }

        .container-wide {
            max-width: 1000px; margin: 0 auto; padding: 20px;
        }

        /* Video Grid */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .video-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s;
            cursor: pointer;
            border: 1px solid #eee;
        }
        .video-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        .thumbnail {
            width: 100%; aspect-ratio: 16/9;
            background-size: cover; background-position: center;
            position: relative;
        }
        .play-icon {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 40px; color: rgba(255,255,255,0.9); text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        .card-body { padding: 15px; }
        .badge-cat { 
            background: #e3f2fd; color: #2196f3; padding: 3px 8px; 
            border-radius: 5px; font-size: 11px; font-weight: bold; display: inline-block; margin-bottom: 5px;
        }
        .video-title { font-size: 15px; font-weight: bold; color: #333; margin: 0; line-height: 1.4; }

        /* Pagination */
        .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .page-btn {
            background: white; border: 1px solid #ddd; padding: 8px 15px;
            border-radius: 8px; cursor: pointer; font-weight: bold; color: #555;
        }
        .page-btn:hover { background: #f8f9fa; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Modal Inner Styles */
        .modal-video-wrap {
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; 
            border-radius: 12px; margin-bottom: 20px; background: #000;
        }
        .modal-video-wrap iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        
        .quiz-section { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: left; }
        .quiz-q { font-weight: bold; margin-bottom: 10px; color: #2d3436; }
        .quiz-options label { display: block; margin-bottom: 5px; cursor: pointer; }
        
        .auth-section { border-top: 1px solid #eee; padding-top: 20px; }
        .auth-section input { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        .btn-submit { width: 100%; background: #6C5CE7; color: white; padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-submit:hover { background: #5a4ad1; }

        .back-home { position: absolute; top: 20px; left: 20px; text-decoration: none; font-weight: bold; color: #666; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <a href="index.html" class="back-home">â† í™ˆìœ¼ë¡œ</a>

    <div class="glass-container container-wide">
        <div class="header">
            <h1>ğŸ“š ê¸°ì´ˆì†Œì–‘êµìœ¡</h1>
            <p>ì˜ìƒì„ ì‹œì²­í•˜ê³  í€´ì¦ˆë¥¼ ë§íˆë©´ ìˆ˜ë£Œê°€ ì¸ì •ë©ë‹ˆë‹¤.</p>
        </div>

        <div class="video-grid" id="videoGrid">
            </div>

        <div class="pagination">
            <button class="page-btn" id="prevBtn" onclick="changePage(-1)">ì´ì „</button>
            <span id="pageInfo" style="display:flex; align-items:center; font-weight:bold; color:#555;">1 / 1</span>
            <button class="page-btn" id="nextBtn" onclick="changePage(1)">ë‹¤ìŒ</button>
        </div>
    </div>

    <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:9999; justify-content:center; align-items:center;">
        <div class="spinner" style="border: 4px solid #f3f3f3; border-top: 4px solid #6C5CE7; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    </div>

    <script type="module">
        import { db, collection, addDoc, query, where, getDocs, Timestamp } from "./js/firebase-config.js";

        // ==========================================
        // 1. ê°•ì˜ ë°ì´í„° (ë‚˜ì¤‘ì— ì´ ë¶€ë¶„ë§Œ ìˆ˜ì •í•˜ë©´ ë¨)
        // ==========================================
        const videoData = [
            { id: 1, cat: "ê¶Œë¦¬êµìœ¡", title: "ì²­ì†Œë…„ ë…¸ë™ì¸ê¶Œ, ì´ê²ƒë§Œì€ ì•Œì!", url: "https://www.youtube.com/embed/example1", question: "ì²­ì†Œë…„ë„ ê·¼ë¡œê³„ì•½ì„œë¥¼ ì¨ì•¼ í• ê¹Œìš”?", options: ["ì¨ì•¼ í•œë‹¤", "ì•ˆ ì¨ë„ ëœë‹¤"], answer: 0 },
            { id: 2, cat: "ë””ì§€í„¸", title: "ìŠ¤ë§ˆíŠ¸í° ê³¼ì˜ì¡´ ì˜ˆë°© êµìœ¡", url: "https://www.youtube.com/embed/example2", question: "ìŠ¤ë§ˆíŠ¸í°ì„ ì ì‹œ ë‚´ë ¤ë†“ëŠ” ì‹œê°„ì€?", options: ["ë””ì§€í„¸ ë””í†¡ìŠ¤", "ë””ì§€í„¸ ì¤‘ë…"], answer: 0 },
            { id: 3, cat: "ì„±êµìœ¡", title: "ì˜¬ë°”ë¥¸ ì„±ì§€ì‹ê³¼ ì—í‹°ì¼“", url: "https://www.youtube.com/embed/example3", question: "ìƒëŒ€ë°©ì˜ ë™ì˜ ì—†ëŠ” ì ‘ì´‰ì€?", options: ["ì‚¬ë‘ì´ë‹¤", "í­ë ¥ì´ë‹¤"], answer: 1 },
            { id: 4, cat: "ì•ˆì „", title: "ì§€ì§„ ë°œìƒ ì‹œ ëŒ€í”¼ìš”ë ¹", url: "https://www.youtube.com/embed/example4", question: "ì§€ì§„ì´ ë‚˜ë©´ ì–´ë””ë¡œ ìˆ¨ì„ê¹Œìš”?", options: ["ì±…ìƒ ì•„ë˜", "ì°½ë¬¸ ì˜†"], answer: 0 },
            { id: 5, cat: "í™˜ê²½", title: "ë¶„ë¦¬ìˆ˜ê±°ì˜ ë‹¬ì¸ ë˜ê¸°", url: "https://www.youtube.com/embed/example5", question: "í”Œë¼ìŠ¤í‹±ì€ ì”»ì–´ì„œ ë²„ë ¤ì•¼ í• ê¹Œìš”?", options: ["ê·¸ëƒ¥ ë²„ë¦°ë‹¤", "ì”»ì–´ì„œ ë²„ë¦°ë‹¤"], answer: 1 },
            { id: 6, cat: "ì§„ë¡œ", title: "ë¯¸ë˜ ì§ì—… íƒìƒ‰ ê°€ì´ë“œ", url: "https://www.youtube.com/embed/example6", question: "ì¢‹ì•„í•˜ëŠ” ì¼ì„ ì°¾ëŠ” ê³¼ì •ì€?", options: ["ì§„ë¡œ íƒìƒ‰", "ì‹œê°„ ë‚­ë¹„"], answer: 0 },
            { id: 7, cat: "ê²½ì œ", title: "ì²­ì†Œë…„ ê¸ˆìœµ ìƒì‹ ê¸°ì´ˆ", url: "https://www.youtube.com/embed/example7", question: "ëˆì„ ê³„íšì ìœ¼ë¡œ ì“°ëŠ” ê²ƒì€?", options: ["ìš©ëˆ ê¸°ì…ì¥", "ì¶©ë™ êµ¬ë§¤"], answer: 0 },
            { id: 8, cat: "í­ë ¥ì˜ˆë°©", title: "í•™êµí­ë ¥, ë°©ê´€ìê°€ ë˜ì§€ ë§ì", url: "https://www.youtube.com/embed/example8", question: "í•™êµí­ë ¥ì„ ëª©ê²©í•˜ë©´?", options: ["ì‹ ê³ í•œë‹¤", "ëª¨ë¥¸ì²™í•œë‹¤"], answer: 0 },
            { id: 9, cat: "ê±´ê°•", title: "ì˜¬ë°”ë¥¸ ì‹ìŠµê´€ê³¼ ì˜ì–‘", url: "https://www.youtube.com/embed/example9", question: "ì•„ì¹¨ ì‹ì‚¬ëŠ”?", options: ["ë¨¹ëŠ” ê²Œ ì¢‹ë‹¤", "êµ¶ëŠ” ê²Œ ì¢‹ë‹¤"], answer: 0 },
            { id: 10, cat: "ì—­ì‚¬", title: "ìš°ë¦¬ë‚˜ë¼ ë…ë¦½ìš´ë™ì˜ ì—­ì‚¬", url: "https://www.youtube.com/embed/example10", question: "3.1 ìš´ë™ì´ ì¼ì–´ë‚œ í•´ëŠ”?", options: ["1919ë…„", "1945ë…„"], answer: 0 },
        ];

        // ==========================================
        // 2. í˜ì´ì§€ë„¤ì´ì…˜ ë¡œì§
        // ==========================================
        let currentPage = 1;
        const itemsPerPage = 8;

        window.changePage = (direction) => {
            const totalPages = Math.ceil(videoData.length / itemsPerPage);
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderVideos();
            }
        };

        const renderVideos = () => {
            const grid = document.getElementById('videoGrid');
            grid.innerHTML = "";
            
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageData = videoData.slice(start, end);

            pageData.forEach((vid, index) => {
                // ì¸ë„¤ì¼ì€ ìœ íŠœë¸Œ IDë¡œ ìë™ ìƒì„± (ì˜ˆì‹œ URLì´ë©´ í”Œë ˆì´ìŠ¤í™€ë”)
                let thumbUrl = "https://via.placeholder.com/320x180?text=No+Thumbnail";
                const ytMatch = vid.url.match(/embed\/([^?]+)/);
                if(ytMatch) thumbUrl = `https://img.youtube.com/vi/${ytMatch[1]}/mqdefault.jpg`;

                grid.innerHTML += `
                    <div class="video-card" onclick="openVideoModal(${start + index})">
                        <div class="thumbnail" style="background-image: url('${thumbUrl}')">
                            <div class="play-icon">â–¶</div>
                        </div>
                        <div class="card-body">
                            <span class="badge-cat">${vid.cat}</span>
                            <h3 class="video-title">${vid.title}</h3>
                        </div>
                    </div>
                `;
            });

            // í˜ì´ì§€ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const totalPages = Math.ceil(videoData.length / itemsPerPage);
            document.getElementById('pageInfo').innerText = `${currentPage} / ${totalPages}`;
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;
        };

        // ì´ˆê¸° ë Œë”ë§
        renderVideos();

        // ==========================================
        // 3. ëª¨ë‹¬ ë° ì¸ì¦ ë¡œì§
        // ==========================================
        window.openVideoModal = (index) => {
            // ì „ì²´ ë°ì´í„°ì—ì„œ ì¸ë±ìŠ¤ë¡œ ê°€ì ¸ì˜¤ê¸° (í˜ì´ì§€ë„¤ì´ì…˜ ê³ ë ¤ X, ì›ë³¸ ë°°ì—´ ì¸ë±ìŠ¤ ì°¾ê¸° í•„ìš”)
            // ìœ„ì—ì„œ render ì‹œ start+indexë¥¼ ë„˜ê²¼ìœ¼ë¯€ë¡œ videoDataì˜ ì •í™•í•œ ì¸ë±ìŠ¤ì„
            const vid = videoData[index];

            // í€´ì¦ˆ ì˜µì…˜ HTML ìƒì„±
            let optionsHtml = vid.options.map((opt, i) => 
                `<label><input type="radio" name="quizAnswer" value="${i}"> ${opt}</label>`
            ).join('');

            Swal.fire({
                title: vid.title,
                html: `
                    <div class="modal-video-wrap">
                        <iframe src="${vid.url}" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>
                    
                    <div class="quiz-section">
                        <div class="quiz-q">Q. ${vid.question}</div>
                        <div class="quiz-options">${optionsHtml}</div>
                    </div>

                    <div class="auth-section">
                        <div style="font-size:12px; color:#666; margin-bottom:5px; text-align:left;">ìˆ˜ë£Œì¦ ë°œê¸‰ì„ ìœ„í•´ ë¡œê·¸ì¸í•˜ì„¸ìš”</div>
                        <input id="eduId" placeholder="ì•„ì´ë”” (ì´ë¦„+ìƒë…„ì›”ì¼)">
                        <input id="eduPw" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
                    </div>
                `,
                width: 600,
                showConfirmButton: true,
                confirmButtonText: 'ì œì¶œ ë° ìˆ˜ë£Œ í™•ì¸',
                confirmButtonColor: '#6C5CE7',
                showCloseButton: true,
                preConfirm: async () => {
                    const id = document.getElementById('eduId').value;
                    const pw = document.getElementById('eduPw').value;
                    const selected = document.querySelector('input[name="quizAnswer"]:checked');

                    if (!selected) return Swal.showValidationMessage("í€´ì¦ˆ ì •ë‹µì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
                    if (parseInt(selected.value) !== vid.answer) return Swal.showValidationMessage("ì˜¤ë‹µì…ë‹ˆë‹¤. ë‹¤ì‹œ ì˜ìƒì„ ë³´ê³  ë§ì¶°ë³´ì„¸ìš”!");
                    if (!id || !pw) return Swal.showValidationMessage("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

                    return { id, pw, vid };
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    processSubmission(result.value);
                }
            });
        };

        const processSubmission = async (data) => {
            const rawId = data.id.replace(/\s/g, '');
            const idMatch = rawId.match(/^([ê°€-í£a-zA-Z]+)(\d{6})$/);
            
            if(!idMatch) return Swal.fire('ì˜¤ë¥˜', 'ì•„ì´ë”” í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            const name = idMatch[1];
            const birth = idMatch[2];

            document.getElementById('loadingOverlay').style.display = 'flex';

            try {
                // 1. ìœ ì € ì¸ì¦
                const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth), where("password", "==", data.pw));
                const snapshot = await getDocs(q);

                if(snapshot.empty) {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    return Swal.fire('ì¸ì¦ ì‹¤íŒ¨', 'íšŒì› ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.', 'error');
                }

                const userDoc = snapshot.docs[0];
                const userId = userDoc.id;
                const userData = userDoc.data();

                // 2. ìˆ˜ê°• ê¸°ë¡ ì €ì¥ (education_records ì»¬ë ‰ì…˜)
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

                await addDoc(collection(db, "education_records"), {
                    student_id: userId,
                    student_name: userData.name,
                    student_birth: birth,
                    video_title: data.vid.title,
                    category: data.vid.cat,
                    date: todayStr,
                    timestamp: Timestamp.now()
                });

                document.getElementById('loadingOverlay').style.display = 'none';
                Swal.fire({
                    icon: 'success',
                    title: 'ìˆ˜ë£Œ ì™„ë£Œ! ğŸ‰',
                    text: `${userData.name}ë‹˜, [${data.vid.title}] êµìœ¡ ìˆ˜ë£Œê°€ í™•ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`
                });

            } catch(e) {
                console.error(e);
                document.getElementById('loadingOverlay').style.display = 'none';
                Swal.fire('ì˜¤ë¥˜', 'ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        };
    </script>
</body>
</html>
