<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가게 사장님 장부</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        h1 { text-align: center; color: #333; margin-bottom: 10px; }
        .store-badge { display:block; width:fit-content; margin:0 auto 30px; background:#e3f2fd; color:#1565c0; padding:5px 15px; border-radius:20px; font-weight:bold; font-size:14px; }
        
        .summary-card {
            background: #e3f2fd; color: #1565c0; padding: 20px; border-radius: 15px;
            margin-bottom: 20px; text-align: center; font-weight: bold; font-size: 18px;
            display: flex; justify-content: space-around;
        }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; justify-content: flex-end; }
        input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }
        button { padding: 8px 16px; background: #212529; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:hover { background: #495057; }

        table { width: 100%; border-collapse: collapse; font-size: 15px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f1f3f5; color: #495057; }
        
        .empty-msg { text-align: center; color: #868e96; padding: 30px; }
        .row-item:hover { background-color: #f8f9fa; }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="pageTitle">가게 장부</h1>
        <div id="storeNameBadge" class="store-badge">가게 확인 중...</div>

        <div class="summary-card">
            <div>총 <span id="totalCount">0</span>건</div>
            <div>합계 <span id="totalAmount">0</span>원</div>
        </div>

        <div class="filter-bar">
            <input type="date" id="startDate">
            <span style="align-self: center;">~</span>
            <input type="date" id="endDate">
            <button onclick="loadData()">조회</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>날짜</th>
                    <th>학생 이름</th>
                    <th>금액</th>
                    <th>상태</th>
                </tr>
            </thead>
            <tbody id="listBody">
                <tr><td colspan="4" class="empty-msg">데이터를 불러오는 중...</td></tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        import { db, collection, getDocs, query, where } from "./js/firebase-config.js";

        // [핵심] 1. URL 파라미터에서 가게 이름 가져오기 (?store=달인보쌈)
        const urlParams = new URLSearchParams(window.location.search);
        let myStore = urlParams.get('store'); 

        // 만약 URL에 없으면 로컬스토리지 확인, 그래도 없으면 팝업
        if (!myStore) myStore = localStorage.getItem('my_store_name');

        window.onload = async () => {
            // 가게 정보가 아예 없으면 선택 팝업 띄우기
            if (!myStore) {
                const { value: store } = await Swal.fire({
                    title: '가게를 선택해주세요',
                    input: 'select',
                    inputOptions: {
                        '달인보쌈': '달인보쌈',
                        '미스테리분식': '미스테리분식',
                        '연김밥': '연김밥'
                    },
                    inputPlaceholder: '가게 선택',
                    showCancelButton: false,
                    allowOutsideClick: false
                });
                if (store) {
                    myStore = store;
                    localStorage.setItem('my_store_name', store);
                }
            }
            
            document.getElementById('storeNameBadge').innerText = myStore;
            
            // 날짜 초기화 (이번 달 1일 ~ 오늘)
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            
            document.getElementById('startDate').value = firstDay;
            document.getElementById('endDate').value = today;

            loadData();
        };

        window.loadData = async () => {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const tbody = document.getElementById('listBody');
            
            tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">로딩 중...</td></tr>';

            try {
                // [수정된 로직] orderBy를 제거하여 색인 오류 방지 -> JS에서 정렬
                const q = query(collection(db, "meal_applications"), 
                    where("store_name", "==", myStore),
                    where("status", "==", "completed") // 결제 완료된 것만
                );

                const snapshot = await getDocs(q);
                let list = [];
                let sum = 0;

                snapshot.forEach(doc => {
                    const d = doc.data();
                    // 날짜 필터 (클라이언트 사이드)
                    if (d.date >= start && d.date <= end) {
                        // 정렬을 위한 timestamp 값 (없으면 날짜 문자열로 대체)
                        const ts = d.timestamp ? d.timestamp.toMillis() : new Date(d.date).getTime();
                        list.push({ ...d, ts: ts });
                        sum += (d.amount || 0);
                    }
                });

                // [핵심] 여기서 최신순(내림차순) 정렬 수행
                list.sort((a, b) => b.ts - a.ts);

                document.getElementById('totalCount').innerText = list.length + "건";
                document.getElementById('totalAmount').innerText = sum.toLocaleString();

                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">조회된 내역이 없습니다.</td></tr>';
                    return;
                }

                tbody.innerHTML = "";
                list.forEach(item => {
                    tbody.innerHTML += `
                        <tr class="row-item">
                            <td>${item.date}</td>
                            <td>${item.student_name}</td>
                            <td style="font-weight:bold; color:#212529;">${item.amount.toLocaleString()}원</td>
                            <td><span style="color:#2f9e44; font-weight:bold;">결제완료</span></td>
                        </tr>
                    `;
                });

            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="4" class="empty-msg" style="color:red;">데이터 불러오기 실패<br><small>' + e.message + '</small></td></tr>';
            }
        };
    </script>
</body>
</html>
