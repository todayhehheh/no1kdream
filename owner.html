<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê²Œ ì‚¬ì¥ë‹˜ ì¥ë¶€</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #f8f9fa; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        
        h1 { text-align: center; color: #333; margin-bottom: 10px; }
        .store-badge { display:block; width:fit-content; margin:0 auto 30px; background:#e3f2fd; color:#1565c0; padding:5px 15px; border-radius:20px; font-weight:bold; font-size:14px; }
        
        /* ìš”ì•½ ì¹´ë“œ ìŠ¤íƒ€ì¼ ë³€ê²½ (ë¯¸ì •ì‚° ê°•ì¡°) */
        .summary-card {
            background: #fff5f5; border: 2px solid #ffc9c9; color: #c92a2a; 
            padding: 25px; border-radius: 15px;
            margin-bottom: 20px; text-align: center; 
            box-shadow: 0 4px 10px rgba(255, 0, 0, 0.05);
        }
        .summary-label { font-size: 16px; font-weight: bold; margin-bottom: 5px; opacity: 0.8; }
        .summary-amount { font-size: 32px; font-weight: 900; }

        .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; justify-content: flex-end; }
        input[type="date"] { padding: 8px; border: 1px solid #ddd; border-radius: 8px; font-family: inherit; }
        button { padding: 8px 16px; background: #212529; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:hover { background: #495057; }

        table { width: 100%; border-collapse: collapse; font-size: 15px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; }
        th { background: #f1f3f5; color: #495057; }
        
        .empty-msg { text-align: center; color: #868e96; padding: 30px; }
        .row-item:hover { background-color: #f8f9fa; }

        /* ìƒíƒœ ë±ƒì§€ */
        .badge-unpaid { background: #ffe3e3; color: #fa5252; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 13px; }
        .badge-paid { background: #d3f9d8; color: #2b8a3e; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 13px; }
    </style>
</head>
<body>

    <div class="container">
        <h1 id="pageTitle">ê°€ê²Œ ì¥ë¶€</h1>
        <div id="storeNameBadge" class="store-badge">ê°€ê²Œ í™•ì¸ ì¤‘...</div>

        <div class="summary-card">
            <div class="summary-label">ğŸ“¢ ì„¼í„°ì—ì„œ ë°›ìœ¼ì‹¤ ê¸ˆì•¡ (ë¯¸ì •ì‚°)</div>
            <div class="summary-amount"><span id="unpaidAmount">0</span>ì›</div>
            <div style="font-size:13px; margin-top:5px; color:#666;">(ì¡°íšŒ ê¸°ê°„ ë‚´ <span id="unpaidCount">0</span>ê±´)</div>
        </div>

        <div class="filter-bar">
            <input type="date" id="startDate">
            <span style="align-self: center;">~</span>
            <input type="date" id="endDate">
            <button onclick="loadData()">ì¡°íšŒ</button>
        </div>

        <table>
            <thead>
                <tr>
                    <th>ë‚ ì§œ</th>
                    <th>í•™ìƒ ì´ë¦„</th>
                    <th>ê¸ˆì•¡</th>
                    <th>ì •ì‚° ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody id="listBody">
                <tr><td colspan="4" class="empty-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
        </table>
    </div>

    <script type="module">
        import { db, collection, getDocs, query, where } from "./js/firebase-config.js";

        // URL íŒŒë¼ë¯¸í„° ì²´í¬
        const urlParams = new URLSearchParams(window.location.search);
        let myStore = urlParams.get('store'); 
        if (!myStore) myStore = localStorage.getItem('my_store_name');

        window.onload = async () => {
            if (!myStore) {
                const { value: store } = await Swal.fire({
                    title: 'ê°€ê²Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”',
                    input: 'select',
                    inputOptions: { 'ë‹¬ì¸ë³´ìŒˆ': 'ë‹¬ì¸ë³´ìŒˆ', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹': 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹', 'ì—°ê¹€ë°¥': 'ì—°ê¹€ë°¥' },
                    inputPlaceholder: 'ê°€ê²Œ ì„ íƒ',
                    showCancelButton: false, allowOutsideClick: false
                });
                if (store) {
                    myStore = store;
                    localStorage.setItem('my_store_name', store);
                }
            }
            document.getElementById('storeNameBadge').innerText = myStore;
            
            // ë‚ ì§œ ì´ˆê¸°í™” (ì´ë²ˆ ë‹¬ 1ì¼ ~ ì˜¤ëŠ˜)
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
            
            document.getElementById('startDate').value = firstDay;
            document.getElementById('endDate').value = today;

            loadData();
        };

        window.loadData = async () => {
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            const tbody = document.getElementById('listBody');
            
            tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">ë¡œë”© ì¤‘...</td></tr>';

            try {
                const q = query(collection(db, "meal_applications"), 
                    where("store_name", "==", myStore),
                    where("status", "==", "completed") // í•™ìƒì´ ì‹ì‚¬ ì™„ë£Œí•œ ê²ƒë§Œ
                );

                const snapshot = await getDocs(q);
                let list = [];
                let unpaidSum = 0; // ë¯¸ì •ì‚° í•©ê³„
                let unpaidCnt = 0; // ë¯¸ì •ì‚° ê±´ìˆ˜

                snapshot.forEach(doc => {
                    const d = doc.data();
                    if (d.date >= start && d.date <= end) {
                        const ts = d.timestamp ? d.timestamp.toMillis() : new Date(d.date).getTime();
                        const isUnpaid = (d.is_settled !== true); // trueê°€ ì•„ë‹ˆë©´ ë¯¸ì •ì‚°
                        
                        list.push({ ...d, ts: ts, isUnpaid: isUnpaid });

                        // ë¯¸ì •ì‚° ê¸ˆì•¡ë§Œ í•©ì‚°
                        if (isUnpaid) {
                            unpaidSum += (d.amount || 0);
                            unpaidCnt++;
                        }
                    }
                });

                // ìµœì‹ ìˆœ ì •ë ¬
                list.sort((a, b) => b.ts - a.ts);

                // ìƒë‹¨ ìš”ì•½ ì—…ë°ì´íŠ¸ (ë¯¸ì •ì‚° ê¸ˆì•¡ë§Œ)
                document.getElementById('unpaidAmount').innerText = unpaidSum.toLocaleString();
                document.getElementById('unpaidCount').innerText = unpaidCnt;

                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="empty-msg">ì¡°íšŒëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                    return;
                }

                tbody.innerHTML = "";
                list.forEach(item => {
                    // ìƒíƒœì— ë”°ë¥¸ ë±ƒì§€ í‘œì‹œ
                    const statusBadge = item.isUnpaid ? 
                        `<span class="badge-unpaid">ë¯¸ì •ì‚°</span>` : 
                        `<span class="badge-paid">ì •ì‚°ì™„ë£Œ</span>`;

                    // ì •ì‚°ì™„ë£Œëœ ê±´ì€ ê¸ˆì•¡ì„ íë¦¬ê²Œ í‘œì‹œ (ì„ íƒì‚¬í•­)
                    const amountStyle = item.isUnpaid ? "font-weight:bold; color:#c92a2a;" : "color:#adb5bd; text-decoration:line-through;";

                    tbody.innerHTML += `
                        <tr class="row-item">
                            <td>${item.date}</td>
                            <td>${item.student_name}</td>
                            <td style="${amountStyle}">${item.amount.toLocaleString()}ì›</td>
                            <td>${statusBadge}</td>
                        </tr>
                    `;
                });

            } catch (e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="4" class="empty-msg" style="color:red;">ì˜¤ë¥˜ ë°œìƒ</td></tr>';
            }
        };
    </script>
</body>
</html>
