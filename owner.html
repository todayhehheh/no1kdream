<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§¤ì¶œ ë° ì •ì‚° í™•ì¸</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        body { 
            font-family: 'Pretendard', sans-serif; 
            background-color: #F5F7FA; 
            margin: 0; padding: 20px; 
            color: #333;
            max-width: 600px; margin: 0 auto;
        }

        /* ìƒë‹¨ í—¤ë” */
        .header { margin-bottom: 25px; padding-left: 5px; }
        .header h1 { margin: 0; font-size: 26px; color: #2C3E50; }
        .header p { margin: 5px 0 0 0; color: #7F8C8D; font-size: 15px; }

        /* ê¸ˆì•¡ ì¹´ë“œ */
        .total-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }
        /* íŒŒë€ìƒ‰ ë°ì½”ë ˆì´ì…˜ ë°” */
        .total-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: linear-gradient(90deg, #2196F3, #21CBF3);
        }
        
        .total-label { font-size: 15px; color: #7F8C8D; font-weight: 500; margin-bottom: 8px; }
        .total-amount { font-size: 42px; font-weight: 800; color: #2C3E50; letter-spacing: -1px; }
        .total-amount span { font-size: 20px; font-weight: 600; color: #95A5A6; margin-left: 2px; }

        /* ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */
        .list-header { 
            display: flex; justify-content: space-between; align-items: flex-end;
            margin-bottom: 15px; padding: 0 5px;
        }
        .list-header h3 { margin: 0; font-size: 18px; color: #34495E; }
        .count-badge { background: #E3F2FD; color: #2196F3; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }

        .list-container {
            display: flex; flex-direction: column; gap: 12px;
        }

        /* ê°œë³„ ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ */
        .log-item {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.2s;
            border: 1px solid #eee;
        }
        .log-item:active { transform: scale(0.98); }

        .log-left { display: flex; flex-direction: column; gap: 4px; }
        .log-date { font-size: 13px; color: #95A5A6; }
        .log-name { font-size: 17px; font-weight: 700; color: #2C3E50; }
        
        .log-amount { font-size: 18px; font-weight: 700; color: #2196F3; } 

        /* ë°ì´í„° ì—†ìŒ ìƒíƒœ */
        .empty-state { text-align: center; padding: 50px 20px; color: #BDC3C7; }
        .empty-state span { font-size: 40px; display: block; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="header">
    <h1 id="storeName">ê°€ê²Œ ì´ë¦„ ë¡œë”© ì¤‘...</h1>
    <p>ì‚¬ì¥ë‹˜, ì˜¤ëŠ˜ë„ ì •ë§ ê³ ìƒ ë§ìœ¼ì…¨ìŠµë‹ˆë‹¤! ğŸ‘¨â€ğŸ³</p>
</div>

<div class="total-card">
    <div class="total-label">ê²°ì œ ì˜ˆì • ê¸ˆì•¡</div>
    <div class="total-amount" id="totalAmount">0<span>ì›</span></div>
</div>

<div class="list-header">
    <h3>ğŸ“‹ ì‹ì‚¬ ì œê³µ ë‚´ì—­</h3>
    <span class="count-badge" id="totalCount">0ê±´</span>
</div>

<div class="list-container" id="listBox">
    <div class="empty-state">ë‚´ì—­ì„ ë¶ˆëŸ¬ì˜¤ê³  ìˆìŠµë‹ˆë‹¤...</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, getDocs, query, where, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAalHhoEK-ko55Jep-7k8ULHeaWWU99oh8",
      authDomain: "dream-meal-support.firebaseapp.com",
      projectId: "dream-meal-support",
      storageBucket: "dream-meal-support.firebasestorage.app",
      messagingSenderId: "230720243044",
      appId: "1:230720243044:web:eb38ecc28353a1c70aa671"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const urlParams = new URLSearchParams(window.location.search);
    const myStore = urlParams.get('store');

    window.onload = async () => {
        if(!myStore) {
            document.body.innerHTML = "<h3 style='text-align:center; margin-top:50px;'>QRì½”ë“œë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ì£¼ì„¸ìš”.</h3>";
            return;
        }
        document.getElementById('storeName').innerText = myStore;

        const q = query(collection(db, "meal_applications"), where("store_name", "==", myStore), where("status", "==", "completed"));
        const snap = await getDocs(q);

        let total = 0;
        let count = 0;
        let list = [];

        snap.forEach(doc => {
            const d = doc.data();
            // ë¯¸ì •ì‚°(is_settled !== true) ê±´ë§Œ í‘œì‹œ
            if(d.is_settled !== true) {
                list.push(d);
                total += Number(d.amount);
                count++;
            }
        });

        // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
        list.sort((a,b) => {
            if(a.date !== b.date) return b.date.localeCompare(a.date);
            return b.timestamp - a.timestamp;
        });

        const listBox = document.getElementById('listBox');
        listBox.innerHTML = "";

        if(list.length === 0) {
            listBox.innerHTML = `
                <div class="empty-state">
                    <span>ğŸ‰</span>
                    ëª¨ë“  ê¸ˆì•¡ì´ ì •ì‚°ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
                    (í˜„ì¬ ë¯¸ì •ì‚° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤)
                </div>`;
            document.getElementById('totalAmount').innerHTML = "0<span>ì›</span>";
            document.getElementById('totalCount').innerText = "0ê±´";
            return;
        }

        list.forEach(item => {
            // ì´ë¦„ ë§ˆìŠ¤í‚¹ (ê¹€ì‹œì–¸ -> ê¹€*ì–¸)
            const maskedName = item.student_name.length > 2 
                ? item.student_name[0] + "*" + item.student_name.substring(2)
                : item.student_name[0] + "*";
            
            // ë‚ ì§œ í¬ë§· (12.21)
            const shortDate = item.date.substring(5).replace('-', '.');

            // [ìˆ˜ì •] ì´ë¦„ ë’¤ì— 'í•™ìƒ' ì œê±°
            listBox.innerHTML += `
                <div class="log-item">
                    <div class="log-left">
                        <span class="log-date">${shortDate}</span>
                        <span class="log-name">${maskedName}</span>
                    </div>
                    <div class="log-amount">${Number(item.amount).toLocaleString()}ì›</div>
                </div>
            `;
        });

        document.getElementById('totalAmount').innerHTML = `${total.toLocaleString()}<span>ì›</span>`;
        document.getElementById('totalCount').innerText = `${count}ê±´`;
    };
</script>
</body>
</html>
