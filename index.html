<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ì›êµ¬ ê¿ˆë“œë¦¼ - ì„¼í„° í‚¤ì˜¤ìŠ¤í¬</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        :root {
            --primary-color: #6C5CE7;
            --primary-light: #A29BFE;
            --accent-color: #00B894;
            --bg-color: #F0F2F5;
            --card-shadow: 0 10px 20px rgba(0,0,0,0.08);
            --modal-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }

        body { 
            font-family: 'Pretendard', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); 
            margin: 0; 
            padding: 20px; 
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container { 
            width: 100%;
            max-width: 550px; 
            background: rgba(255, 255, 255, 0.95); 
            padding: 35px; 
            border-radius: 30px; 
            box-shadow: var(--card-shadow); 
            backdrop-filter: blur(10px);
            position: relative;
        }
        
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #2d3436; margin: 0 0 8px 0; font-size: 28px; letter-spacing: -0.5px; }
        .header p { color: #636e72; margin: 0; font-size: 15px; }

        /* íƒ‘ ë§í¬ */
        .top-link { position: absolute; top: 20px; right: 25px; }
        .top-link a { 
            text-decoration: none; color: #636e72; font-size: 13px; font-weight: 600; 
            background: #dfe6e9; padding: 6px 12px; border-radius: 20px; transition: 0.2s;
        }
        .top-link a:hover { background: #b2bec3; color: #2d3436; }

        /* ë©”ì¸ ê·¸ë¦¬ë“œ */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        
        .btn { 
            border: none; border-radius: 20px; cursor: pointer; 
            transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            font-weight: 700; color: white; position: relative; overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.96); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 7px 14px rgba(0,0,0,0.15); }

        .btn-big { 
            height: 150px; font-size: 22px; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; gap: 10px;
        }
        .btn-attendance { background: linear-gradient(135deg, #6C5CE7, #8e44ad); }
        .btn-snack { background: linear-gradient(135deg, #FF7675, #fab1a0); }

        /* ê¸‰ì‹ ê·¸ë¦¬ë“œ */
        h3 { color: #2d3436; margin: 0 0 15px 5px; font-size: 18px; display: flex; align-items: center; gap: 8px; }
        .meal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .btn-meal { 
            height: 90px; font-size: 17px; background-color: #fff; color: #2d3436; 
            border: 2px solid #f1f2f6; 
        }
        .btn-meal:hover { border-color: var(--primary-color); color: var(--primary-color); background: #fdfdfd; }
        .btn-disabled { background-color: #dfe6e9; color: #b2bec3; cursor: not-allowed; border: none; box-shadow: none; }
        .btn-disabled:hover { transform: none; }

        /* ê´‘ê³  ê·¸ë¦¬ë“œ */
        .ad-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-ad { 
            height: 120px; background-size: cover; background-position: center; 
            border-radius: 20px; position: relative; border: 1px solid rgba(0,0,0,0.05);
        }
        .btn-ad span { 
            position: absolute; bottom: 10px; right: 10px;
            background: rgba(0,0,0,0.5); color: white; padding: 4px 8px; 
            border-radius: 12px; font-size: 11px; backdrop-filter: blur(4px);
        }

        /* === ëª¨ë‹¬ ë””ìì¸ (Pretty Popups) === */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(45, 52, 54, 0.4); backdrop-filter: blur(5px);
            justify-content: center; align-items: center; z-index: 1000;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal.show { opacity: 1; } /* JSë¡œ ì œì–´ */

        .modal-content { 
            background: white; padding: 40px 30px; border-radius: 30px; width: 85%; max-width: 400px; 
            text-align: left; box-shadow: var(--modal-shadow);
            transform: translateY(20px); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }
        .modal.show .modal-content { transform: translateY(0); }

        .close-btn { 
            position: absolute; top: 20px; right: 25px; 
            cursor: pointer; font-size: 28px; color: #b2bec3; transition: 0.2s; 
        }
        .close-btn:hover { color: #2d3436; transform: rotate(90deg); }

        .modal h2 { margin: 0 0 25px 0; text-align: center; color: #2d3436; font-size: 24px; }

        /* í™œë™ ì„ íƒ ë¼ë””ì˜¤ (ì¹´ë“œí˜•) */
        .section-label { text-align: center; font-size: 14px; color: #636e72; margin-bottom: 10px; font-weight: 600; }
        .radio-group { display: flex; gap: 10px; margin-bottom: 30px; }
        .radio-item { flex: 1; }
        .radio-item input { display: none; }
        .radio-item label { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 80px; background: #f1f2f6; border-radius: 16px; 
            font-size: 14px; font-weight: 700; color: #636e72; cursor: pointer; 
            border: 2px solid transparent; transition: 0.2s; 
        }
        .radio-item label span { font-size: 24px; margin-bottom: 5px; } /* ì´ëª¨ì§€ í¬ê¸° */
        .radio-item input:checked + label { 
            background: #ede9fe; border-color: var(--primary-color); color: var(--primary-color); 
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.2);
        }

        /* ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .input-group { margin-bottom: 15px; }
        .input-group input { 
            width: 100%; padding: 16px; border: 2px solid #f1f2f6; border-radius: 16px; 
            font-size: 16px; outline: none; background: #fdfdfd; transition: 0.2s; box-sizing: border-box;
            font-family: 'Pretendard', sans-serif;
        }
        .input-group input:focus { border-color: var(--primary-color); background: white; }
        .input-group input::placeholder { color: #b2bec3; }

        /* í™•ì¸ ë²„íŠ¼ */
        .btn-confirm { 
            width: 100%; background: #2d3436; color: white; padding: 18px; 
            border: none; border-radius: 16px; font-size: 17px; font-weight: 700; 
            cursor: pointer; margin-top: 10px; transition: 0.2s;
        }
        .btn-confirm:hover { background: #000; transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }

    </style>
</head>
<body>

<div class="container">
    <div class="top-link"><a href="#" onclick="openRegisterModal()">ğŸ†• ì‹ ê·œê°€ì…</a></div>
    
    <div class="header">
        <h1>ğŸŒ± ë…¸ì›êµ¬ ê¿ˆë“œë¦¼</h1>
        <p>ì˜¤ëŠ˜ë„ í˜ë‚´ì„œ ê¿ˆì„ í–¥í•´!</p>
    </div>

    <div class="main-grid">
        <button class="btn btn-big btn-attendance" onclick="openCombinedModal('attendance')">
            <span style="font-size: 40px;">ğŸ“…</span>
            <span>ì¶œì„í•˜ê¸°</span>
        </button>
        <button class="btn btn-big btn-snack" onclick="openCombinedModal('snack')">
            <span style="font-size: 40px;">ğŸ¥ª</span>
            <span>ë¶€ì‹ ì‹ ì²­</span>
        </button>
    </div>

    <h3>ğŸš ì˜¤ëŠ˜ ë­ ë¨¹ì§€? (ì‹ì‚¬ ì‹ ì²­)</h3>
    <div class="meal-grid">
        <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸ë³´ìŒˆ</button>
        <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
        <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
        <button class="btn btn-meal btn-disabled">ì¤€ë¹„ì¤‘</button>
    </div>

    <div class="ad-grid">
        <a id="ad1Link" href="#" target="_blank"><div id="ad1" class="btn btn-ad"><span>AD</span></div></a>
        <a id="ad2Link" href="#" target="_blank"><div id="ad2" class="btn btn-ad"><span>AD</span></div></a>
    </div>
</div>

<div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
        <h2 id="modalTitle">ì¸ì¦ ë° ì‹ ì²­</h2>
        
        <div id="activitySection">
            <div class="section-label">âœ¨ ì˜¤ëŠ˜ì˜ í™œë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
            <div class="radio-group">
                <div class="radio-item">
                    <input type="radio" id="act1" name="activity" value="ê¸°ì´ˆì†Œì–‘êµìœ¡" checked>
                    <label for="act1"><span>ğŸ“š</span>ê¸°ì´ˆì†Œì–‘</label>
                </div>
                <div class="radio-item">
                    <input type="radio" id="act2" name="activity" value="í”„ë¡œê·¸ë¨">
                    <label for="act2"><span>ğŸ¨</span>í”„ë¡œê·¸ë¨</label>
                </div>
                <div class="radio-item">
                    <input type="radio" id="act3" name="activity" value="ìŠ¤í„°ë””ì¹´í˜">
                    <label for="act3"><span>âœï¸</span>ìŠ¤í„°ë””</label>
                </div>
            </div>
        </div>

        <div class="input-group">
            <input type="text" id="loginId" placeholder="ì•„ì´ë”” (ì´ë¦„+ìƒë…„ì›”ì¼ 6ìë¦¬)">
        </div>
        <div class="input-group">
            <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        </div>
        <button class="btn-confirm" onclick="processAllInOne()">ì‹ ì²­ ì™„ë£Œí•˜ê¸°</button>
    </div>
</div>

<div id="registerModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('registerModal')">&times;</span>
        <h2>íšŒì›ê°€ì…</h2>
        <div class="input-group"><input type="text" id="regName" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)"></div>
        <div class="input-group"><input type="tel" id="regBirth" maxlength="6" placeholder="ìƒë…„ì›”ì¼ (ì˜ˆ: 080101)"></div>
        <div class="input-group"><input type="password" id="regPw" placeholder="ë¹„ë°€ë²ˆí˜¸ ì„¤ì •"></div>
        <div class="input-group"><input type="password" id="regPwConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"></div>
        <button class="btn-confirm" onclick="registerUser()">ê°€ì…í•˜ê¸°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, Timestamp, getDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const DEFAULT_ADS = {
        ad1: { image: "https://via.placeholder.com/300x150/333/fff?text=Loading...", link: "#" },
        ad2: { image: "https://via.placeholder.com/300x150/333/fff?text=Loading...", link: "#" }
    };

    const firebaseConfig = {
      apiKey: "AIzaSyAalHhoEK-ko55Jep-7k8ULHeaWWU99oh8",
      authDomain: "dream-meal-support.firebaseapp.com",
      projectId: "dream-meal-support",
      storageBucket: "dream-meal-support.firebasestorage.app",
      messagingSenderId: "230720243044",
      appId: "1:230720243044:web:eb38ecc28353a1c70aa671"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ê´‘ê³  ë¡œë“œ
    const loadAds = async () => {
        try {
            const docRef = doc(db, "settings", "ads");
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if(data.ad1_img) document.getElementById('ad1').style.backgroundImage = `url('${data.ad1_img}')`;
                if(data.ad1_link) document.getElementById('ad1Link').href = data.ad1_link;
                if(data.ad2_img) document.getElementById('ad2').style.backgroundImage = `url('${data.ad2_img}')`;
                if(data.ad2_link) document.getElementById('ad2Link').href = data.ad2_link;
            } else applyDefaultAds();
        } catch(e) { applyDefaultAds(); }
    };
    const applyDefaultAds = () => {
        document.getElementById('ad1').style.backgroundImage = `url('${DEFAULT_ADS.ad1.image}')`;
        document.getElementById('ad2').style.backgroundImage = `url('${DEFAULT_ADS.ad2.image}')`;
    };
    loadAds();

    let currentType = ""; 
    let currentTargetName = "";

    const getTodayStr = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    };

    // ëª¨ë‹¬ ì—´ê¸° (ì• ë‹ˆë©”ì´ì…˜ ì ìš©)
    window.openCombinedModal = (type, targetName = "") => {
        currentType = type;
        currentTargetName = targetName;
        document.getElementById('loginId').value = '';
        document.getElementById('loginPw').value = '';
        
        const title = document.getElementById('modalTitle');
        if(type === 'attendance') title.innerText = "ì¶œì„ ì²´í¬";
        else if(type === 'meal') title.innerText = `[${targetName}] ì‹ì‚¬ ì‹ ì²­`;
        else if(type === 'snack') title.innerText = "ë¶€ì‹ ì‹ ì²­";
        
        const modal = document.getElementById('loginModal');
        modal.style.display = 'flex';
        // ì•½ê°„ì˜ ë”œë ˆì´ í›„ show í´ë˜ìŠ¤ ì¶”ê°€ (fade in íš¨ê³¼)
        setTimeout(() => modal.classList.add('show'), 10);
    };

    window.closeModal = (id) => {
        const modal = document.getElementById(id);
        modal.classList.remove('show');
        // ì• ë‹ˆë©”ì´ì…˜ ëë‚œ í›„ display none
        setTimeout(() => modal.style.display = 'none', 300);
    };

    window.openRegisterModal = () => {
        const modal = document.getElementById('registerModal');
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
    };

    window.processAllInOne = async () => {
        const rawId = document.getElementById('loginId').value.replace(/\s/g, ''); 
        const pw = document.getElementById('loginPw').value;
        const selectedAct = document.querySelector('input[name="activity"]:checked').value;
        const idMatch = rawId.match(/^([ê°€-í£a-zA-Z]+)(\d{6})$/);

        if(!idMatch) return alert("ì•„ì´ë”” í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.");
        const name = idMatch[1];
        const birth = idMatch[2];

        try {
            const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth), where("password", "==", pw));
            const snapshot = await getDocs(q);
            if(snapshot.empty) return alert("ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.");

            const userDoc = snapshot.docs[0];
            const userId = userDoc.id;
            const userData = userDoc.data();
            const today = getTodayStr();

            let collectionName = "";
            let dataPayload = { student_id: userId, student_name: userData.name, activity: selectedAct, date: today, timestamp: Timestamp.now() };
            let msg = "";

            if(currentType === 'attendance') {
                collectionName = "attendance";
                msg = `${userData.name}ë‹˜, [${selectedAct}] ì¶œì„ ì™„ë£Œ!`;
            } else if(currentType === 'meal') {
                const checkQ = query(collection(db, "meal_applications"), where("student_id", "==", userId), where("date", "==", today));
                const checkSnap = await getDocs(checkQ);
                
                let isBlocked = false;
                checkSnap.forEach(doc => {
                    const d = doc.data();
                    if (d.status === 'applied' || d.status === 'approved') isBlocked = true;
                });

                if(isBlocked) return alert("í˜„ì¬ ì§„í–‰ ì¤‘ì¸ ì‹ì‚¬ ì‹ ì²­ì´ ìˆìŠµë‹ˆë‹¤.");

                collectionName = "meal_applications";
                dataPayload.store_name = currentTargetName;
                dataPayload.status = "applied"; 
                msg = `${userData.name}ë‹˜, [${currentTargetName}] ì‹ ì²­ ì™„ë£Œ!\nì‹ë‹¹ì— ê°€ì„œ QRì½”ë“œë¥¼ ì°ì–´ì£¼ì„¸ìš”.`;

            } else if(currentType === 'snack') {
                collectionName = "snacks";
                dataPayload.item = "ê°„ì‹ ì„¸íŠ¸";
                msg = "ë¶€ì‹ ì‹ ì²­ ì™„ë£Œ!";
            }

            await addDoc(collection(db, collectionName), dataPayload);
            alert(msg);
            closeModal('loginModal');

        } catch(e) { console.error(e); alert("ì˜¤ë¥˜ ë°œìƒ"); }
    };

    window.registerUser = async () => {
        const name = document.getElementById('regName').value;
        const birth = document.getElementById('regBirth').value;
        const pw = document.getElementById('regPw').value;
        const pwConfirm = document.getElementById('regPwConfirm').value;
        if(!name || birth.length !== 6 || !pw) return alert("ì •ë³´ í™•ì¸");
        if(pw !== pwConfirm) return alert("ë¹„ë²ˆ ë¶ˆì¼ì¹˜");
        try {
            const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth));
            const snap = await getDocs(q);
            if(!snap.empty) return alert("ì´ë¯¸ ê°€ì…ë¨");
            await addDoc(collection(db, "users"), { name, birth, password: pw, role: 'student', createdAt: Timestamp.now() });
            alert("ê°€ì… ì™„ë£Œ"); closeModal('registerModal');
        } catch(e) { alert("ì˜¤ë¥˜"); }
    };
</script>
</body>
</html>
