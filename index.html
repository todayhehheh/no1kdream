<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ì›êµ¬ ê¿ˆë“œë¦¼ - ì„¼í„° í‚¤ì˜¤ìŠ¤í¬</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        body { font-family: 'Pretendard', sans-serif; background: #f0f2f5; }

        /* --- [ìˆ˜ì •] ë°˜ì‘í˜• ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ --- */
        .glass-container { 
            max-width: 600px; /* ê¸°ë³¸ ëª¨ë°”ì¼ í­ */
            width: 95%; margin: 30px auto; padding: 25px; 
            transition: max-width 0.3s ease;
        }

        /* PC í™”ë©´ (í­ 1000px ì´ìƒ) */
        @media (min-width: 1000px) {
            .glass-container { max-width: 1100px; } /* í­ì„ ë„“í˜ */
            
            /* 2ë‹¨ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
            .dashboard-layout {
                display: grid;
                grid-template-columns: 1fr 1fr; /* 1:1 ë¹„ìœ¨ */
                gap: 30px;
                align-items: start;
            }
            
            /* PCì—ì„œëŠ” ë°°ë„ˆê°€ 2ê°œ ë‚˜ë€íˆ */
            .ad-grid { grid-template-columns: 1fr 1fr !important; }
        }

        /* Header */
        .header { margin-bottom: 20px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; color: #2d3436; margin: 0; }
        
        /* Top Links */
        .top-link-area { display: flex; gap: 10px; }
        .top-btn {
            text-decoration: none; font-size: 13px; font-weight: 700;
            padding: 8px 16px; border-radius: 20px; 
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
            background: white; border: 1px solid #dfe6e9;
            color: #636e72;
        }
        .top-btn:hover { transform: translateY(-2px); border-color: var(--primary-color); color: var(--primary-color); }
        .top-btn.point { background: #ff7675; color: white; border: none; }
        .top-btn.point:hover { background: #d63031; }

        /* Left Section: Big Actions */
        .big-action-group { display: flex; flex-direction: column; gap: 15px; }
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-big { 
            height: 140px; font-size: 20px; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; gap: 10px;
            color: white; border-radius: 20px; border: none; cursor: pointer;
            transition: transform 0.2s;
        }
        .btn-attendance { 
            background: linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%);
            box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
        }
        .btn-snack { 
            background: linear-gradient(135deg, #FF7675 0%, #fab1a0 100%);
            box-shadow: 0 10px 20px rgba(255, 118, 117, 0.3);
        }
        .btn-big:hover { transform: translateY(-5px); filter: brightness(1.05); }

        /* Right Section: Meals & Ads */
        .right-section-group { display: flex; flex-direction: column; gap: 25px; }
        
        .section-title { 
            font-size: 18px; color: #2d3436; margin: 0 0 15px 0; 
            display: flex; align-items: center; gap: 8px; font-weight: 800;
        }
        .meal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .btn-meal { 
            height: 70px; font-size: 16px; background: white; 
            color: #2d3436; border: 2px solid #edeff2;
            border-radius: 16px; font-weight: 700; cursor: pointer; transition: 0.2s;
        }
        .btn-meal:hover { 
            border-color: var(--primary-color); color: var(--primary-color); 
            background: #f8f9fa; transform: translateY(-2px);
        }
        .btn-disabled { 
            background-color: #f1f2f6; color: #b2bec3; 
            cursor: not-allowed; border: none; 
        }
        
        /* Ads */
        .ad-grid { display: grid; grid-template-columns: 1fr; gap: 15px; } /* ëª¨ë°”ì¼ 1ì—´ */
        .ad-card { 
            width: 100%; height: 120px; 
            background-size: cover; background-position: center; 
            border-radius: 16px; 
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            transition: transform 0.3s; cursor: pointer;
        }
        .ad-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }

        /* SweetAlert Custom Styles */
        .swal-radio-group { display: flex; gap: 10px; margin: 15px 0 25px; }
        .swal-radio-item { flex: 1; }
        .swal-radio-item input { display: none; }
        .swal-radio-item label { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 80px; background: #f8f9fa; border-radius: 12px; 
            font-size: 13px; font-weight: 700; color: #636e72; cursor: pointer; 
            border: 2px solid transparent; transition: 0.2s; 
        }
        .swal-radio-item label span { font-size: 24px; margin-bottom: 5px; }
        .swal-radio-item input:checked + label { 
            background: #ede9fe; border-color: var(--primary-color); color: var(--primary-color); 
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.2);
        }

        /* ì°¨ë‹¨ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #blockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f2f5; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: #333;
        }
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 10000;
            display: none; justify-content: center; align-items: center; flex-direction: column;
        }
    </style>
</head>
<body>

    <div id="blockScreen">
        <h1 style="font-size: 60px; margin-bottom: 10px;">ğŸ”’</h1>
        <h2>ì ‘ê·¼ì´ ì œí•œëœ ê¸°ê¸°ì…ë‹ˆë‹¤.</h2>
        <p style="color:#666;">ì„¼í„° ê´€ë¦¬ìì—ê²Œ ê¸°ê¸° ë“±ë¡ì„ ìš”ì²­í•˜ì„¸ìš”.</p>
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:bold; color:#555;">ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div class="glass-container" id="mainContent" style="display:none;">
        
        <div class="header">
            <h1>ë…¸ì›êµ¬ ê¿ˆë“œë¦¼</h1>
            <div class="top-link-area">
                <a href="#" onclick="openTutorialModal()" class="top-btn point">â–¶ ê¸‰ì‹ íŠœí† ë¦¬ì–¼</a>
                <a href="#" onclick="openRegisterModal()" class="top-btn">ğŸ†• íšŒì›ê°€ì…</a>
            </div>
        </div>

        <div class="dashboard-layout">
            
            <section class="big-action-group">
                <div class="main-grid">
                    <button class="btn-big btn-attendance" onclick="openCombinedModal('attendance')">
                        <span style="font-size: 40px;">ğŸ“…</span>
                        <span>ì¶œì„í•˜ê¸°</span>
                    </button>
                    <button class="btn-big btn-snack" onclick="openCombinedModal('snack')">
                        <span style="font-size: 40px;">ğŸ¥ª</span>
                        <span>ë¶€ì‹ ì‹ ì²­</span>
                    </button>
                </div>
                <a id="ad1Link" href="#" target="_blank"><div id="ad1" class="ad-card"></div></a>
            </section>

            <section class="right-section-group">
                <div>
                    <h3 class="section-title">ğŸš ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</h3>
                    <div class="meal-grid">
                        <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸ë³´ìŒˆ</button>
                        <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
                        <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
                        <button class="btn btn-meal btn-disabled">ì¤€ë¹„ì¤‘</button>
                    </div>
                </div>
                <a id="ad2Link" href="#" target="_blank"><div id="ad2" class="ad-card"></div></a>
            </section>

        </div>
    </div>

    <script type="module">
        import { db, collection, addDoc, query, where, getDocs, getDoc, doc, Timestamp } from "./js/firebase-config.js";

        // ============================================
        // 1. ìœ í‹¸ë¦¬í‹° ë° ê´‘ê³  ë¡œì§
        // ============================================
        const getTodayStr = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const showLoading = (show) => {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        };

        const DEFAULT_ADS = {
            ad1: { image: "https://via.placeholder.com/400x120/eee/aaa?text=Ad+1", link: "#" },
            ad2: { image: "https://via.placeholder.com/400x120/ddd/999?text=Ad+2", link: "#" }
        };

        const applyDefaultAds = () => {
            document.getElementById('ad1').style.backgroundImage = `url('${DEFAULT_ADS.ad1.image}')`;
            document.getElementById('ad2').style.backgroundImage = `url('${DEFAULT_ADS.ad2.image}')`;
        };

        const loadAds = async () => {
            try {
                const docRef = doc(db, "settings", "ads");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.ad1_img) document.getElementById('ad1').style.backgroundImage = `url('${data.ad1_img}')`;
                    if(data.ad1_link) document.getElementById('ad1Link').href = data.ad1_link;
                    if(data.ad2_img) document.getElementById('ad2').style.backgroundImage = `url('${data.ad2_img}')`;
                    if(data.ad2_link) document.getElementById('ad2Link').href = data.ad2_link;
                } else applyDefaultAds();
            } catch(e) { applyDefaultAds(); }
        };

        // ============================================
        // 2. ê¸°ê¸° ì¸ì¦ ì²´í¬
        // ============================================
        const checkDeviceAuth = () => {
            const isAuthorized = localStorage.getItem('kiosk_auth_token') === 'dream_center_pc';
            if (isAuthorized) {
                document.getElementById('blockScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                loadAds();
            } else {
                console.log("ë¯¸ì¸ì¦ ê¸°ê¸° ì ‘ì† ì°¨ë‹¨ë¨");
            }
        };

        // ============================================
        // 3. ë²„íŠ¼ ê¸°ëŠ¥ë“¤ (ìë™ì™„ì„± ë°©ì§€ ì ìš©ë¨)
        // ============================================
        window.openTutorialModal = () => {
            Swal.fire({
                title: '<strong>ê¸‰ì‹ íŠœí† ë¦¬ì–¼</strong>',
                html: `
                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius:15px;">
                        <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                        src="https://www.youtube.com/embed/IWwxdhD54uU?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>
                `,
                showCloseButton: true,
                showConfirmButton: false,
                width: 600,
                padding: '20px'
            });
        };

        // [ìˆ˜ì •] íšŒì›ê°€ì… ëª¨ë‹¬ - ìë™ì™„ì„± ë°©ì§€ ì ìš©
        window.openRegisterModal = async () => {
            const { value: formValues } = await Swal.fire({
                title: 'íšŒì›ê°€ì…',
                html:
                    '<input id="swal-name" class="swal2-input" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)" autocomplete="off">' +
                    '<input id="swal-birth" class="swal2-input" type="tel" maxlength="6" placeholder="ìƒë…„ì›”ì¼ (ì˜ˆ: 080101)" autocomplete="off">' +
                    '' +
                    '<input style="display:none" type="password" name="fakepasswordremembered">' +
                    '<input id="swal-pw" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì„¤ì •" autocomplete="new-password">' +
                    '<input id="swal-pw2" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" autocomplete="new-password">',
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'ê°€ì…í•˜ê¸°',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-name').value,
                        document.getElementById('swal-birth').value,
                        document.getElementById('swal-pw').value,
                        document.getElementById('swal-pw2').value
                    ]
                }
            });

            if (formValues) {
                const [name, birth, pw, pw2] = formValues;
                if(!name || birth.length !== 6 || !pw) return Swal.fire('ì˜¤ë¥˜', 'ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                if(pw !== pw2) return Swal.fire('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');

                showLoading(true);
                try {
                    const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth));
                    const snap = await getDocs(q);
                    if(!snap.empty) {
                         showLoading(false);
                         return Swal.fire('ì˜¤ë¥˜', 'ì´ë¯¸ ê°€ì…ëœ íšŒì›ì…ë‹ˆë‹¤.', 'warning');
                    }
                    
                    await addDoc(collection(db, "users"), { 
                        name, birth, password: pw, role: 'student', createdAt: Timestamp.now() 
                    });
                    
                    showLoading(false);
                    Swal.fire('ì„±ê³µ', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } catch(e) {
                    console.error(e);
                    showLoading(false);
                    Swal.fire('ì˜¤ë¥˜', 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        };

        // [ìˆ˜ì •] í†µí•© ì‹ ì²­ ëª¨ë‹¬ - ìë™ì™„ì„± ë°©ì§€ ì ìš©
        window.openCombinedModal = async (type, targetName = "") => {
            let titleText = "";
            if(type === 'attendance') titleText = "ì¶œì„ ì²´í¬";
            else if(type === 'meal') titleText = `[${targetName}] ì‹ì‚¬ ì‹ ì²­`;
            else if(type === 'snack') titleText = "ë¶€ì‹ ì‹ ì²­";

            const activityHtml = `
                <div style="text-align:center; font-size:13px; margin-bottom:8px; color:#666; font-weight:bold;">âœ¨ ì˜¤ëŠ˜ì˜ í™œë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                <div class="swal-radio-group">
                    <div class="swal-radio-item">
                        <input type="radio" id="act1" name="activity" value="ê¸°ì´ˆì†Œì–‘êµìœ¡" checked>
                        <label for="act1"><span>ğŸ“š</span>ê¸°ì´ˆì†Œì–‘</label>
                    </div>
                    <div class="swal-radio-item">
                        <input type="radio" id="act2" name="activity" value="í”„ë¡œê·¸ë¨">
                        <label for="act2"><span>ğŸ¨</span>í”„ë¡œê·¸ë¨</label>
                    </div>
                    <div class="swal-radio-item">
                        <input type="radio" id="act3" name="activity" value="ìŠ¤í„°ë””ì¹´í˜">
                        <label for="act3"><span>âœï¸</span>ìŠ¤í„°ë””</label>
                    </div>
                </div>
            `;

            const { value: result } = await Swal.fire({
                title: titleText,
                html: activityHtml +
                      '' +
                      '<input id="loginId" class="swal2-input" placeholder="ì•„ì´ë”” (ì´ë¦„+ìƒë…„ì›”ì¼)" autocomplete="off" name="no-autofill-id">' +
                      '' +
                      '<input id="loginPw" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸" autocomplete="new-password">',
                showCancelButton: true,
                confirmButtonText: 'ì‹ ì²­ ì™„ë£Œ',
                didOpen: () => {
                    // ë¼ë””ì˜¤ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì„ íƒì )
                    const radios = document.querySelectorAll('input[name="activity"]');
                    radios.forEach(r => {
                        r.addEventListener('change', (e) => {});
                    });
                },
                preConfirm: () => {
                    const actInput = document.querySelector('input[name="activity"]:checked');
                    return {
                        activity: actInput ? actInput.value : "ê¸°ì´ˆì†Œì–‘êµìœ¡",
                        id: document.getElementById('loginId').value,
                        pw: document.getElementById('loginPw').value
                    }
                }
            });

            if (result) {
                processApplication(type, targetName, result.activity, result.id, result.pw);
            }
        };

        const processApplication = async (type, targetName, activity, rawId, pw) => {
            const cleanId = rawId.replace(/\s/g, '');
            const idMatch = cleanId.match(/^([ê°€-í£a-zA-Z]+)(\d{6})$/);
            
            if(!idMatch) return Swal.fire('ì˜¤ë¥˜', 'ì•„ì´ë””ëŠ” ì´ë¦„+ìƒë…„ì›”ì¼6ìë¦¬ ì…ë‹ˆë‹¤.<br>(ì˜ˆ: í™ê¸¸ë™080101)', 'warning');
            
            const name = idMatch[1];
            const birth = idMatch[2];

            showLoading(true);

            try {
                const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth), where("password", "==", pw));
                const snapshot = await getDocs(q);
                
                if(snapshot.empty) {
                    showLoading(false);
                    return Swal.fire('ì¸ì¦ ì‹¤íŒ¨', 'íšŒì›ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                }

                const userDoc = snapshot.docs[0];
                const userId = userDoc.id;
                const userData = userDoc.data();
                const today = getTodayStr();

                let collectionName = "";
                let dataPayload = { 
                    student_id: userId, 
                    student_name: userData.name, 
                    activity: activity, 
                    date: today, 
                    timestamp: Timestamp.now() 
                };
                let successTitle = "";
                let successMsg = "";

                if(type === 'attendance') {
                    collectionName = "attendance";
                    successTitle = "ì¶œì„ ì™„ë£Œ";
                    successMsg = `${userData.name}ë‹˜, [${activity}] ì¶œì„ë˜ì…¨ìŠµë‹ˆë‹¤!`;
                } 
                else if(type === 'meal') {
                    const checkQ = query(collection(db, "meal_applications"), where("student_id", "==", userId), where("date", "==", today));
                    const checkSnap = await getDocs(checkQ);
                    let isBlocked = false;
                    
                    checkSnap.forEach(doc => {
                        const d = doc.data();
                        if (d.status === 'applied' || d.status === 'approved') isBlocked = true;
                    });

                    if(isBlocked) {
                        showLoading(false);
                        return Swal.fire('ì‹ ì²­ ë¶ˆê°€', 'ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì‹ì‚¬ ì‹ ì²­ì´ ìˆìŠµë‹ˆë‹¤.', 'warning');
                    }

                    collectionName = "meal_applications";
                    dataPayload.store_name = targetName;
                    dataPayload.status = "applied"; 
                    successTitle = "ì‹ ì²­ ì™„ë£Œ";
                    successMsg = `${userData.name}ë‹˜, [${targetName}] ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì‹ë‹¹ì—ì„œ QRì½”ë“œë¥¼ ì°ì–´ì£¼ì„¸ìš”.`;
                } 
                else if(type === 'snack') {
                    collectionName = "snacks";
                    dataPayload.item = "ê°„ì‹ ì„¸íŠ¸";
                    successTitle = "ë¶€ì‹ ì‹ ì²­ ì™„ë£Œ";
                    successMsg = "ë§›ìˆê²Œ ë“œì„¸ìš”!";
                }

                await addDoc(collection(db, collectionName), dataPayload);
                showLoading(false);
                Swal.fire(successTitle, successMsg, 'success');

            } catch(e) {
                console.error(e);
                showLoading(false);
                Swal.fire('ì‹œìŠ¤í…œ ì˜¤ë¥˜', 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        };

        checkDeviceAuth();

    </script>
</body>
</html>
