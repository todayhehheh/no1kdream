<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ì›êµ¬ ê¿ˆë“œë¦¼ - ì„¼í„° í‚¤ì˜¤ìŠ¤í¬</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #6C5CE7;
            --bg-color: #F0F2F5;
            --text-dark: #2D3436;
            --shadow: 0 8px 30px rgba(0,0,0,0.08);
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        .kiosk-container {
            width: 95%; height: 95vh;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(20px);
            border-radius: 30px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(255,255,255,0.8);
            padding: 25px 40px;
            display: flex; flex-direction: column;
        }

        /* 1. í—¤ë” */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; margin-bottom: 20px; position: relative;
        }
        .header-title {
            position: absolute; left: 50%; transform: translateX(-50%);
            font-size: 32px; font-weight: 900; color: var(--text-dark); margin: 0;
        }
        .header-btn {
            padding: 10px 20px; border-radius: 50px; font-size: 15px; font-weight: 700;
            border: none; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-tutorial { background: #FF7675; color: white; }
        .btn-tutorial:hover { background: #d63031; transform: scale(1.05); }
        .btn-register { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-register:hover { background: var(--primary); color: white; transform: scale(1.05); }

        /* 2. ë©”ì¸ ë ˆì´ì•„ì›ƒ (ìƒí•˜ ë¶„ë¦¬) */
        .main-layout {
            display: flex; flex-direction: column;
            height: 100%; gap: 20px;
        }

        /* [ìƒë‹¨] ê¸°ëŠ¥ ì˜ì—­ (40~45%) */
        .top-section {
            flex: 4; display: flex; gap: 20px;
        }

        .big-btn {
            flex: 1; border-radius: 25px; border: none;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 22px; font-weight: 800; color: white;
            cursor: pointer; transition: 0.3s; box-shadow: var(--shadow); gap: 10px;
        }
        .big-btn:hover { transform: translateY(-5px); filter: brightness(1.1); }
        .card-attendance { background: linear-gradient(135deg, #6C5CE7, #a29bfe); }
        .card-snack { background: linear-gradient(135deg, #FF7675, #fab1a0); }
        .emoji-icon { font-size: 50px; }

        /* ê¸‰ì‹ ë©”ë‰´íŒ */
        .meal-section {
            flex: 1.5; /* ë²„íŠ¼ë³´ë‹¤ ì¢€ ë” ë„“ê²Œ */
            background: white; border-radius: 25px; padding: 20px;
            box-shadow: var(--shadow); display: flex; flex-direction: column;
        }
        .section-header { font-size: 18px; font-weight: 800; color: var(--text-dark); margin-bottom: 15px; }
        .meal-grid {
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr;
            gap: 12px; height: 100%;
        }
        .meal-btn {
            border: 2px solid #F0F2F5; background: white; border-radius: 15px;
            font-size: 18px; font-weight: 700; color: var(--text-dark);
            cursor: pointer; transition: 0.2s;
        }
        .meal-btn:hover { border-color: var(--primary); color: var(--primary); background: #F8F9FA; }
        .meal-btn:disabled { background: #F8F9FA; color: #B2BEC3; cursor: not-allowed; border: none; }

        /* [í•˜ë‹¨] ê´‘ê³  ì˜ì—­ (55~60%) */
        .bottom-section {
            flex: 5.5; 
            display: flex; justify-content: center; gap: 20px;
            overflow: hidden; /* ë„˜ì¹˜ëŠ” ê²ƒ ë°©ì§€ */
        }

        .ad-container {
            height: 100%; /* ë¶€ëª¨ ë†’ì´ì— ë§ì¶¤ */
            aspect-ratio: 4 / 5; /* [í•µì‹¬] ì¸ìŠ¤íƒ€ 4:5 ë¹„ìœ¨ ê°•ì œ ê³ ì • */
            border-radius: 25px;
            overflow: hidden;
            box-shadow: var(--shadow);
            position: relative;
            background: #eee;
            transition: transform 0.3s;
        }
        .ad-container:hover { transform: translateY(-5px); }
        
        .ad-img {
            width: 100%; height: 100%;
            background-size: cover; background-position: center;
        }
        .ad-link { display: block; width: 100%; height: 100%; text-decoration: none; }

        /* ìœ í‹¸ë¦¬í‹° */
        #blockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f2f5; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: #333;
        }
        #loadingOverlay {
            display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 10000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* SweetAlert ìŠ¤íƒ€ì¼ */
        .swal-radio-group { display: flex; gap: 10px; margin: 15px 0 25px; }
        .swal-radio-item { flex: 1; }
        .swal-radio-item input { display: none; }
        .swal-radio-item label { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 90px; background: #f8f9fa; border-radius: 15px; 
            font-size: 14px; font-weight: 700; color: #636e72; cursor: pointer; 
            border: 2px solid transparent; transition: 0.2s; 
        }
        .swal-radio-item label span { font-size: 28px; margin-bottom: 5px; }
        .swal-radio-item input:checked + label { 
            background: #ede9fe; border-color: var(--primary); color: var(--primary); 
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.2);
        }
    </style>
</head>
<body>

    <div id="blockScreen">
        <h1 style="font-size: 80px; margin-bottom: 20px;">ğŸ”’</h1>
        <h2>ì ‘ê·¼ì´ ì œí•œëœ ê¸°ê¸°ì…ë‹ˆë‹¤.</h2>
        <p style="color:#666; font-size:18px;">ì„¼í„° ê´€ë¦¬ìì—ê²Œ ê¸°ê¸° ë“±ë¡ì„ ìš”ì²­í•˜ì„¸ìš”.</p>
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:bold; color:#555;">ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div class="kiosk-container" id="mainContent" style="display:none;">
        
        <header class="header">
            <button onclick="openTutorialModal()" class="header-btn btn-tutorial">â–¶ ê¸‰ì‹ íŠœí† ë¦¬ì–¼</button>
            <h1 class="header-title">ë…¸ì›êµ¬ ê¿ˆë“œë¦¼</h1>
            <button onclick="openRegisterModal()" class="header-btn btn-register">ğŸ†• íšŒì›ê°€ì…</button>
        </header>

        <div class="main-layout">
            
            <div class="top-section">
                <button class="big-btn card-attendance" onclick="openCombinedModal('attendance')">
                    <span class="emoji-icon">ğŸ“…</span>
                    <span>ì¶œì„í•˜ê¸°</span>
                </button>
                
                <button class="big-btn card-snack" onclick="openCombinedModal('snack')">
                    <span class="emoji-icon">ğŸ¥ª</span>
                    <span>ë¶€ì‹ ì‹ ì²­</span>
                </button>

                <div class="meal-section">
                    <div class="section-header">ğŸš ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</div>
                    <div class="meal-grid">
                        <button class="meal-btn" onclick="openCombinedModal('meal', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸ë³´ìŒˆ</button>
                        <button class="meal-btn" onclick="openCombinedModal('meal', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
                        <button class="meal-btn" onclick="openCombinedModal('meal', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
                        <button class="meal-btn" disabled>ì¤€ë¹„ì¤‘</button>
                    </div>
                </div>
            </div>

            <div class="bottom-section">
                <div class="ad-container">
                    <a id="ad1Link" href="#" target="_blank" class="ad-link">
                        <div id="ad1" class="ad-img"></div>
                    </a>
                </div>
                <div class="ad-container">
                    <a id="ad2Link" href="#" target="_blank" class="ad-link">
                        <div id="ad2" class="ad-img"></div>
                    </a>
                </div>
                <div class="ad-container">
                    <a id="ad3Link" href="#" target="_blank" class="ad-link">
                        <div id="ad3" class="ad-img"></div>
                    </a>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { db, collection, addDoc, query, where, getDocs, getDoc, doc, Timestamp } from "./js/firebase-config.js";

        const getTodayStr = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const showLoading = (show) => {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        };

        // --- ê´‘ê³  ë¡œë“œ ë¡œì§ (3ê°œë¡œ í™•ì¥) ---
        const DEFAULT_ADS = {
            ad1: { image: "https://via.placeholder.com/400x500/eee/aaa?text=AD+1", link: "#" },
            ad2: { image: "https://via.placeholder.com/400x500/ddd/999?text=AD+2", link: "#" },
            ad3: { image: "https://via.placeholder.com/400x500/ccc/888?text=AD+3", link: "#" }
        };

        const applyDefaultAds = () => {
            document.getElementById('ad1').style.backgroundImage = `url('${DEFAULT_ADS.ad1.image}')`;
            document.getElementById('ad2').style.backgroundImage = `url('${DEFAULT_ADS.ad2.image}')`;
            document.getElementById('ad3').style.backgroundImage = `url('${DEFAULT_ADS.ad3.image}')`;
        };

        const loadAds = async () => {
            try {
                const docRef = doc(db, "settings", "ads");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // ê´‘ê³  1
                    if(data.ad1_img) document.getElementById('ad1').style.backgroundImage = `url('${data.ad1_img}')`;
                    else document.getElementById('ad1').style.backgroundImage = `url('${DEFAULT_ADS.ad1.image}')`;
                    if(data.ad1_link) document.getElementById('ad1Link').href = data.ad1_link;

                    // ê´‘ê³  2
                    if(data.ad2_img) document.getElementById('ad2').style.backgroundImage = `url('${data.ad2_img}')`;
                    else document.getElementById('ad2').style.backgroundImage = `url('${DEFAULT_ADS.ad2.image}')`;
                    if(data.ad2_link) document.getElementById('ad2Link').href = data.ad2_link;

                    // ê´‘ê³  3 (ì‹ ê·œ)
                    if(data.ad3_img) document.getElementById('ad3').style.backgroundImage = `url('${data.ad3_img}')`;
                    else document.getElementById('ad3').style.backgroundImage = `url('${DEFAULT_ADS.ad3.image}')`;
                    if(data.ad3_link) document.getElementById('ad3Link').href = data.ad3_link;

                } else applyDefaultAds();
            } catch(e) { applyDefaultAds(); }
        };

        // --- ê¸°ê¸° ì¸ì¦ ---
        const checkDeviceAuth = () => {
            const isAuthorized = localStorage.getItem('kiosk_auth_token') === 'dream_center_pc';
            if (isAuthorized) {
                document.getElementById('blockScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'flex';
                loadAds();
            } else {
                console.log("ë¯¸ì¸ì¦ ê¸°ê¸°");
            }
        };

        // --- ë²„íŠ¼ ê¸°ëŠ¥ ---
        window.openTutorialModal = () => {
            Swal.fire({
                title: '<strong>ê¸‰ì‹ íŠœí† ë¦¬ì–¼</strong>',
                html: `<div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius:15px;">
                        <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                        src="https://www.youtube.com/embed/IWwxdhD54uU?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>`,
                showCloseButton: true, showConfirmButton: false, width: 700, padding: '20px'
            });
        };

        window.openRegisterModal = async () => {
            const { value: formValues } = await Swal.fire({
                title: 'íšŒì›ê°€ì…',
                html: '<input id="swal-name" class="swal2-input" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">' +
                      '<input id="swal-birth" class="swal2-input" type="tel" maxlength="6" placeholder="ìƒë…„ì›”ì¼ (ì˜ˆ: 080101)">' +
                      '<input id="swal-pw" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì„¤ì •">' +
                      '<input id="swal-pw2" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">',
                focusConfirm: false, showCancelButton: true, confirmButtonText: 'ê°€ì…í•˜ê¸°',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-name').value,
                        document.getElementById('swal-birth').value,
                        document.getElementById('swal-pw').value,
                        document.getElementById('swal-pw2').value
                    ]
                }
            });

            if (formValues) {
                const [name, birth, pw, pw2] = formValues;
                if(!name || birth.length !== 6 || !pw) return Swal.fire('ì˜¤ë¥˜', 'ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                if(pw !== pw2) return Swal.fire('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');

                showLoading(true);
                try {
                    const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth));
                    const snap = await getDocs(q);
                    if(!snap.empty) { showLoading(false); return Swal.fire('ì˜¤ë¥˜', 'ì´ë¯¸ ê°€ì…ëœ íšŒì›ì…ë‹ˆë‹¤.', 'warning'); }
                    
                    await addDoc(collection(db, "users"), { name, birth, password: pw, role: 'student', createdAt: Timestamp.now() });
                    showLoading(false); Swal.fire('ì„±ê³µ', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } catch(e) { showLoading(false); Swal.fire('ì˜¤ë¥˜', 'ì‹œìŠ¤í…œ ì˜¤ë¥˜', 'error'); }
            }
        };

        window.openCombinedModal = async (type, targetName = "") => {
            let titleText = type === 'attendance' ? "ì¶œì„ ì²´í¬" : (type === 'meal' ? `[${targetName}] ì‹ì‚¬ ì‹ ì²­` : "ë¶€ì‹ ì‹ ì²­");
            const activityHtml = `
                <div style="text-align:center; font-size:15px; margin-bottom:10px; color:#666; font-weight:bold;">âœ¨ ì˜¤ëŠ˜ì˜ í™œë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                <div class="swal-radio-group">
                    <div class="swal-radio-item"><input type="radio" id="act1" name="activity" value="ê¸°ì´ˆì†Œì–‘êµìœ¡" checked><label for="act1"><span>ğŸ“š</span>ê¸°ì´ˆì†Œì–‘</label></div>
                    <div class="swal-radio-item"><input type="radio" id="act2" name="activity" value="í”„ë¡œê·¸ë¨"><label for="act2"><span>ğŸ¨</span>í”„ë¡œê·¸ë¨</label></div>
                    <div class="swal-radio-item"><input type="radio" id="act3" name="activity" value="ìŠ¤í„°ë””ì¹´í˜"><label for="act3"><span>âœï¸</span>ìŠ¤í„°ë””</label></div>
                </div>`;

            const { value: result } = await Swal.fire({
                title: titleText,
                html: activityHtml +
                      '<input id="loginId" class="swal2-input" placeholder="ì•„ì´ë”” (ì´ë¦„+ìƒë…„ì›”ì¼)">' +
                      '<input id="loginPw" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">',
                showCancelButton: true, confirmButtonText: 'ì‹ ì²­ ì™„ë£Œ', width: 600,
                preConfirm: () => {
                    const actInput = document.querySelector('input[name="activity"]:checked');
                    return { activity: actInput ? actInput.value : "ê¸°ì´ˆì†Œì–‘êµìœ¡", id: document.getElementById('loginId').value, pw: document.getElementById('loginPw').value }
                }
            });

            if (result) processApplication(type, targetName, result.activity, result.id, result.pw);
        };

        const processApplication = async (type, targetName, activity, rawId, pw) => {
            const cleanId = rawId.replace(/\s/g, '');
            const idMatch = cleanId.match(/^([ê°€-í£a-zA-Z]+)(\d{6})$/);
            if(!idMatch) return Swal.fire('ì˜¤ë¥˜', 'ì•„ì´ë””ëŠ” ì´ë¦„+ìƒë…„ì›”ì¼6ìë¦¬ ì…ë‹ˆë‹¤.', 'warning');
            
            const name = idMatch[1]; const birth = idMatch[2];
            showLoading(true);

            try {
                const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth), where("password", "==", pw));
                const snapshot = await getDocs(q);
                if(snapshot.empty) { showLoading(false); return Swal.fire('ì¸ì¦ ì‹¤íŒ¨', 'íšŒì›ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error'); }

                const userDoc = snapshot.docs[0]; const userId = userDoc.id; const userData = userDoc.data(); const today = getTodayStr();
                let collectionName = "", dataPayload = { student_id: userId, student_name: userData.name, activity: activity, date: today, timestamp: Timestamp.now() }, successMsg = "";

                if(type === 'attendance') {
                    collectionName = "attendance"; successMsg = `${userData.name}ë‹˜, [${activity}] ì¶œì„ë˜ì…¨ìŠµë‹ˆë‹¤!`;
                } else if(type === 'meal') {
                    const checkQ = query(collection(db, "meal_applications"), where("student_id", "==", userId), where("date", "==", today));
                    const checkSnap = await getDocs(checkQ);
                    let isBlocked = false; checkSnap.forEach(doc => { if (doc.data().status === 'applied' || doc.data().status === 'approved') isBlocked = true; });
                    if(isBlocked) { showLoading(false); return Swal.fire('ì‹ ì²­ ë¶ˆê°€', 'ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì‹ì‚¬ ì‹ ì²­ì´ ìˆìŠµë‹ˆë‹¤.', 'warning'); }
                    collectionName = "meal_applications"; dataPayload.store_name = targetName; dataPayload.status = "applied"; successMsg = `${userData.name}ë‹˜, [${targetName}] ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                } else if(type === 'snack') {
                    collectionName = "snacks"; dataPayload.item = "ê°„ì‹ ì„¸íŠ¸"; successMsg = "ë§›ìˆê²Œ ë“œì„¸ìš”!";
                }

                await addDoc(collection(db, collectionName), dataPayload);
                showLoading(false); Swal.fire('ì„±ê³µ', successMsg, 'success');
            } catch(e) { showLoading(false); Swal.fire('ì‹œìŠ¤í…œ ì˜¤ë¥˜', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); }
        };

        checkDeviceAuth();
    </script>
</body>
</html>
