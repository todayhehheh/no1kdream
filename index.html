<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ì›êµ¬ ê¿ˆë“œë¦¼ - ì„¼í„° í‚¤ì˜¤ìŠ¤í¬</title>
    <!-- Shared Style -->
    <link rel="stylesheet" href="css/style.css">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Page Specific Styles for Kiosk */
        
        .header { margin-bottom: 25px; margin-top: 10px; }
        
        /* Top Links */
        .top-link-area {
            display: flex; justify-content: space-between; margin-bottom: 10px;
        }
        .top-btn {
            text-decoration: none; font-size: 12px; font-weight: 700;
            padding: 8px 16px; border-radius: 20px; 
            transition: 0.2s; display: flex; align-items: center; gap: 5px;
            background: rgba(255,255,255,0.8);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            color: var(--text-gray);
        }
        .top-btn:hover { transform: translateY(-2px); background: white; color: var(--primary-color); }
        .top-btn.point { background: #ff7675; color: white; }
        .top-btn.point:hover { background: #d63031; color: white; }

        /* Big Action Buttons */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 25px; }
        .btn-big { 
            height: 120px; font-size: 20px; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; gap: 8px;
            color: white; border-radius: 20px;
        }
        .btn-attendance { 
            background: linear-gradient(135deg, #6C5CE7 0%, #a29bfe 100%);
            box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3);
        }
        .btn-snack { 
            background: linear-gradient(135deg, #FF7675 0%, #fab1a0 100%);
            box-shadow: 0 10px 20px rgba(255, 118, 117, 0.3);
        }
        .btn-big:hover { transform: translateY(-5px); filter: brightness(1.05); }

        /* Meal Selection */
        .section-title { 
            font-size: 17px; color: var(--text-dark); margin: 0 0 15px 5px; 
            display: flex; align-items: center; gap: 6px;
        }
        .meal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px; }
        .btn-meal { 
            height: 60px; font-size: 15px; background: white; 
            color: var(--text-dark); border: 2px solid #edeff2;
            border-radius: 16px; font-weight: 700;
        }
        .btn-meal:hover { 
            border-color: var(--primary-color); color: var(--primary-color); 
            background: #f8f9fa; transform: translateY(-2px);
        }
        .btn-disabled { 
            background-color: #f1f2f6; color: #b2bec3; 
            cursor: not-allowed; border: none; 
        }
        .btn-disabled:hover { transform: none; border: none; color: #b2bec3; }

        /* Ads */
        .ad-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .ad-card { 
            width: 100%; aspect-ratio: 4/5; 
            background-size: cover; background-position: center; 
            border-radius: 18px; 
            border: 4px solid rgba(255,255,255,0.5);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: transform 0.3s;
            cursor: pointer;
        }
        .ad-card:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 15px 30px rgba(0,0,0,0.15); }

        /* Modal Customization for SweetAlert2 is handled by JS, 
           but we keep the custom login form style for injecting into Swal */
        .swal-radio-group { display: flex; gap: 10px; margin: 15px 0 25px; }
        .swal-radio-item { flex: 1; }
        .swal-radio-item input { display: none; }
        .swal-radio-item label { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 80px; background: #f8f9fa; border-radius: 12px; 
            font-size: 13px; font-weight: 700; color: #636e72; cursor: pointer; 
            border: 2px solid transparent; transition: 0.2s; 
        }
        .swal-radio-item label span { font-size: 24px; margin-bottom: 5px; }
        .swal-radio-item input:checked + label { 
            background: #ede9fe; border-color: var(--primary-color); color: var(--primary-color); 
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.2);
        }
        
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:bold; color:#555;">ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <!-- Main Glass Container -->
    <div class="glass-container">
        
        <!-- Top Links -->
        <div class="top-link-area">
            <a href="#" onclick="openTutorialModal()" class="top-btn point">â–¶ ê¸‰ì‹ íŠœí† ë¦¬ì–¼</a>
            <a href="#" onclick="openRegisterModal()" class="top-btn">ğŸ†• íšŒì›ê°€ì…</a>
        </div>

        <!-- Header -->
        <div class="header">
            <h1>ë…¸ì›êµ¬ ê¿ˆë“œë¦¼</h1>
        </div>

        <!-- Main Buttons -->
        <div class="main-grid">
            <button class="btn btn-big btn-attendance" onclick="openCombinedModal('attendance')">
                <span style="font-size: 36px;">ğŸ“…</span>
                <span>ì¶œì„í•˜ê¸°</span>
            </button>
            <button class="btn btn-big btn-snack" onclick="openCombinedModal('snack')">
                <span style="font-size: 36px;">ğŸ¥ª</span>
                <span>ë¶€ì‹ ì‹ ì²­</span>
            </button>
        </div>

        <!-- Meal Selection -->
        <h3 class="section-title">ğŸš ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</h3>
        <div class="meal-grid">
            <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸ë³´ìŒˆ</button>
            <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
            <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
            <button class="btn btn-meal btn-disabled">ì¤€ë¹„ì¤‘</button>
        </div>

        <!-- Ads Grid -->
        <div class="ad-grid">
            <a id="ad1Link" href="#" target="_blank"><div id="ad1" class="ad-card"></div></a>
            <a id="ad2Link" href="#" target="_blank"><div id="ad2" class="ad-card"></div></a>
        </div>
    </div>

    <script type="module">
        import { db, collection, addDoc, query, where, getDocs, getDoc, doc, Timestamp } from "./js/firebase-config.js";

        // ============================================
        // 1. Dynamic Ad Loading Logic (Preserved)
        // ============================================
        const DEFAULT_ADS = {
            ad1: { image: "https://via.placeholder.com/400x500/eee/aaa?text=Ad+1", link: "#" },
            ad2: { image: "https://via.placeholder.com/400x500/ddd/999?text=Ad+2", link: "#" }
        };

        const loadAds = async () => {
            try {
                const docRef = doc(db, "settings", "ads");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if(data.ad1_img) document.getElementById('ad1').style.backgroundImage = `url('${data.ad1_img}')`;
                    if(data.ad1_link) document.getElementById('ad1Link').href = data.ad1_link;
                    if(data.ad2_img) document.getElementById('ad2').style.backgroundImage = `url('${data.ad2_img}')`;
                    if(data.ad2_link) document.getElementById('ad2Link').href = data.ad2_link;
                } else applyDefaultAds();
            } catch(e) { applyDefaultAds(); }
        };

        const applyDefaultAds = () => {
            document.getElementById('ad1').style.backgroundImage = `url('${DEFAULT_ADS.ad1.image}')`;
            document.getElementById('ad2').style.backgroundImage = `url('${DEFAULT_ADS.ad2.image}')`;
        };
        
        // Initialize Ads
        loadAds();


        // ============================================
        // 2. Shared Logic & SweetAlert2 Integration
        // ============================================

        const getTodayStr = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        const showLoading = (show) => {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        };

        // ----------------------------------
        // Feature: Tutorial Modal (YouTube)
        // ----------------------------------
        window.openTutorialModal = () => {
            Swal.fire({
                title: '<strong>ê¸‰ì‹ íŠœí† ë¦¬ì–¼</strong>',
                html: `
                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius:15px;">
                        <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                        src="https://www.youtube.com/embed/IWwxdhD54uU?autoplay=1" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
                    </div>
                `,
                showCloseButton: true,
                showConfirmButton: false,
                width: 600,
                background: '#fff',
                padding: '20px'
            });
        };

        // ----------------------------------
        // Feature: Register Modal
        // ----------------------------------
        window.openRegisterModal = async () => {
            const { value: formValues } = await Swal.fire({
                title: 'íšŒì›ê°€ì…',
                html:
                    '<input id="swal-name" class="swal2-input" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">' +
                    '<input id="swal-birth" class="swal2-input" type="tel" maxlength="6" placeholder="ìƒë…„ì›”ì¼ (ì˜ˆ: 080101)">' +
                    '<input id="swal-pw" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì„¤ì •">' +
                    '<input id="swal-pw2" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">',
                focusConfirm: false,
                showCancelButton: true,
                confirmButtonText: 'ê°€ì…í•˜ê¸°',
                preConfirm: () => {
                    return [
                        document.getElementById('swal-name').value,
                        document.getElementById('swal-birth').value,
                        document.getElementById('swal-pw').value,
                        document.getElementById('swal-pw2').value
                    ]
                }
            });

            if (formValues) {
                const [name, birth, pw, pw2] = formValues;
                if(!name || birth.length !== 6 || !pw) return Swal.fire('ì˜¤ë¥˜', 'ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                if(pw !== pw2) return Swal.fire('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');

                showLoading(true);
                try {
                    const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth));
                    const snap = await getDocs(q);
                    if(!snap.empty) {
                         showLoading(false);
                         return Swal.fire('ì˜¤ë¥˜', 'ì´ë¯¸ ê°€ì…ëœ íšŒì›ì…ë‹ˆë‹¤.', 'warning');
                    }
                    
                    await addDoc(collection(db, "users"), { 
                        name, birth, password: pw, role: 'student', createdAt: Timestamp.now() 
                    });
                    
                    showLoading(false);
                    Swal.fire('ì„±ê³µ', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } catch(e) {
                    console.error(e);
                    showLoading(false);
                    Swal.fire('ì˜¤ë¥˜', 'ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }
        };

        // ----------------------------------
        // Feature: Combined Application Modal
        // ----------------------------------
        window.openCombinedModal = async (type, targetName = "") => {
            let titleText = "";
            if(type === 'attendance') titleText = "ì¶œì„ ì²´í¬";
            else if(type === 'meal') titleText = `[${targetName}] ì‹ì‚¬ ì‹ ì²­`;
            else if(type === 'snack') titleText = "ë¶€ì‹ ì‹ ì²­";

            // HTML for custom radio selection
            const activityHtml = `
                <div style="text-align:center; font-size:13px; margin-bottom:8px; color:#666; font-weight:bold;">âœ¨ ì˜¤ëŠ˜ì˜ í™œë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                <div class="swal-radio-group">
                    <div class="swal-radio-item">
                        <input type="radio" id="act1" name="activity" value="ê¸°ì´ˆì†Œì–‘êµìœ¡" checked>
                        <label for="act1"><span>ğŸ“š</span>ê¸°ì´ˆì†Œì–‘</label>
                    </div>
                    <div class="swal-radio-item">
                        <input type="radio" id="act2" name="activity" value="í”„ë¡œê·¸ë¨">
                        <label for="act2"><span>ğŸ¨</span>í”„ë¡œê·¸ë¨</label>
                    </div>
                    <div class="swal-radio-item">
                        <input type="radio" id="act3" name="activity" value="ìŠ¤í„°ë””ì¹´í˜">
                        <label for="act3"><span>âœï¸</span>ìŠ¤í„°ë””</label>
                    </div>
                </div>
            `;

            const { value: result } = await Swal.fire({
                title: titleText,
                html: activityHtml +
                      '<input id="loginId" class="swal2-input" placeholder="ì•„ì´ë”” (ì´ë¦„+ìƒë…„ì›”ì¼)">' +
                      '<input id="loginPw" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">',
                showCancelButton: true,
                confirmButtonText: 'ì‹ ì²­ ì™„ë£Œ',
                didOpen: () => {
                    // Make custom radio buttons work properly
                    const radios = document.querySelectorAll('input[name="activity"]');
                    radios.forEach(r => {
                        r.addEventListener('change', (e) => {
                           // Visual toggle logic is handled by CSS, but we ensure it's checked
                        });
                    });
                },
                preConfirm: () => {
                    const actInput = document.querySelector('input[name="activity"]:checked');
                    return {
                        activity: actInput ? actInput.value : "ê¸°ì´ˆì†Œì–‘êµìœ¡",
                        id: document.getElementById('loginId').value,
                        pw: document.getElementById('loginPw').value
                    }
                }
            });

            if (result) {
                processApplication(type, targetName, result.activity, result.id, result.pw);
            }
        };

        const processApplication = async (type, targetName, activity, rawId, pw) => {
            const cleanId = rawId.replace(/\s/g, '');
            const idMatch = cleanId.match(/^([ê°€-í£a-zA-Z]+)(\d{6})$/);
            
            if(!idMatch) return Swal.fire('ì˜¤ë¥˜', 'ì•„ì´ë””ëŠ” ì´ë¦„+ìƒë…„ì›”ì¼6ìë¦¬ ì…ë‹ˆë‹¤.<br>(ì˜ˆ: í™ê¸¸ë™080101)', 'warning');
            
            const name = idMatch[1];
            const birth = idMatch[2];

            showLoading(true);

            try {
                // 1. Authenticate
                const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth), where("password", "==", pw));
                const snapshot = await getDocs(q);
                
                if(snapshot.empty) {
                    showLoading(false);
                    return Swal.fire('ì¸ì¦ ì‹¤íŒ¨', 'íšŒì›ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                }

                const userDoc = snapshot.docs[0];
                const userId = userDoc.id;
                const userData = userDoc.data();
                const today = getTodayStr();

                let collectionName = "";
                let dataPayload = { 
                    student_id: userId, 
                    student_name: userData.name, 
                    activity: activity, 
                    date: today, 
                    timestamp: Timestamp.now() 
                };
                let successTitle = "";
                let successMsg = "";

                // 2. Process based on Type
                if(type === 'attendance') {
                    // Check duplicate? (Optional, skipping for now to allow multiple check-ins if needed, or simple check)
                    collectionName = "attendance";
                    successTitle = "ì¶œì„ ì™„ë£Œ";
                    successMsg = `${userData.name}ë‹˜, [${activity}] ì¶œì„ë˜ì…¨ìŠµë‹ˆë‹¤!`;
                } 
                else if(type === 'meal') {
                    // Check Duplicate Meal
                    const checkQ = query(collection(db, "meal_applications"), where("student_id", "==", userId), where("date", "==", today));
                    const checkSnap = await getDocs(checkQ);
                    let isBlocked = false;
                    
                    checkSnap.forEach(doc => {
                        const d = doc.data();
                        if (d.status === 'applied' || d.status === 'approved') isBlocked = true;
                    });

                    if(isBlocked) {
                        showLoading(false);
                        return Swal.fire('ì‹ ì²­ ë¶ˆê°€', 'ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì‹ì‚¬ ì‹ ì²­ì´ ìˆìŠµë‹ˆë‹¤.', 'warning');
                    }

                    collectionName = "meal_applications";
                    dataPayload.store_name = targetName;
                    dataPayload.status = "applied"; 
                    successTitle = "ì‹ ì²­ ì™„ë£Œ";
                    successMsg = `${userData.name}ë‹˜, [${targetName}] ì‹ ì²­ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ì‹ë‹¹ì—ì„œ QRì½”ë“œë¥¼ ì°ì–´ì£¼ì„¸ìš”.`;
                } 
                else if(type === 'snack') {
                    collectionName = "snacks";
                    dataPayload.item = "ê°„ì‹ ì„¸íŠ¸";
                    successTitle = "ë¶€ì‹ ì‹ ì²­ ì™„ë£Œ";
                    successMsg = "ë§›ìˆê²Œ ë“œì„¸ìš”!";
                }

                await addDoc(collection(db, collectionName), dataPayload);
                showLoading(false);
                Swal.fire(successTitle, successMsg, 'success');

            } catch(e) {
                console.error(e);
                showLoading(false);
                Swal.fire('ì‹œìŠ¤í…œ ì˜¤ë¥˜', 'ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        };

    </script>
</body>
</html>
