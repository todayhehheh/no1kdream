<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ì›êµ¬ ê¿ˆë“œë¦¼ - ì„¼í„° í‚¤ì˜¤ìŠ¤í¬</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 30px; border-radius: 24px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        h1 { color: #111; margin-bottom: 5px; font-size: 28px; }
        p.subtitle { color: #666; margin-bottom: 30px; font-size: 16px; }

        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .btn { border: none; border-radius: 16px; cursor: pointer; transition: transform 0.1s; font-weight: bold; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .btn:active { transform: scale(0.96); }

        .btn-big { height: 140px; font-size: 24px; }
        .btn-attendance { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-snack { background: linear-gradient(135deg, #ff9966 0%, #ff5e62 100%); }

        .meal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .btn-meal { height: 80px; font-size: 18px; background-color: #fff; color: #333; border: 2px solid #eee; }
        .btn-meal:hover { border-color: #333; background-color: #fafafa; }
        .btn-disabled { background-color: #e0e0e0; color: #999; cursor: not-allowed; border: none; }

        .ad-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .btn-ad { height: 120px; background-size: cover; background-position: center; border-radius: 16px; border: 1px solid #ddd; }
        .btn-ad span { background: rgba(0,0,0,0.6); color: white; padding: 5px 10px; border-radius: 20px; font-size: 12px; margin-top: auto; margin-bottom: 10px; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 25px; border-radius: 20px; width: 85%; max-width: 380px; text-align: left; animation: slideUp 0.3s; position: relative; }
        @keyframes slideUp { from {transform: translateY(20px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }
        
        .modal h2 { margin-top: 0; text-align: center; color: #333; margin-bottom: 15px; }
        .radio-group { display: flex; gap: 8px; margin-bottom: 25px; }
        .radio-item { flex: 1; }
        .radio-item input { display: none; }
        .radio-item label { display: flex; align-items: center; justify-content: center; height: 55px; background: #f8f9fa; border-radius: 12px; font-size: 14px; font-weight: bold; color: #555; cursor: pointer; border: 2px solid #eee; transition: 0.2s; white-space: nowrap; }
        .radio-item input:checked + label { background: #e3f2fd; border-color: #2196F3; color: #1976D2; }

        .input-group { margin-bottom: 12px; }
        .input-group input { width: 90%; padding: 14px; border: 1px solid #ddd; border-radius: 12px; font-size: 16px; outline: none; background: #f9f9f9; }
        .btn-confirm { width: 100%; background: #333; color: white; padding: 16px; border: none; border-radius: 12px; font-size: 17px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .close-btn { position: absolute; top: 15px; right: 20px; cursor: pointer; font-size: 24px; color: #999; }
        
        .top-link { text-align: right; margin-bottom: 15px; }
        .top-link a { text-decoration: none; color: #888; font-size: 13px; border: 1px solid #ddd; padding: 5px 10px; border-radius: 15px; }
    </style>
</head>
<body>

<div class="container">
    <div class="top-link"><a href="#" onclick="openRegisterModal()">ğŸ†• ì‹ ê·œ íšŒì›ê°€ì…</a></div>
    <h1>ğŸŒ± ë…¸ì›êµ¬ ê¿ˆë“œë¦¼</h1>
    <p class="subtitle">ì˜¤ëŠ˜ë„ í˜ë‚´ì„œ ê¿ˆì„ í–¥í•´!</p>

    <div class="main-grid">
        <button class="btn btn-big btn-attendance" onclick="openCombinedModal('attendance')">
            <span style="font-size: 40px; margin-bottom: 10px;">ğŸ“…</span> ì¶œì„í•˜ê¸°
        </button>
        <button class="btn btn-big btn-snack" onclick="openCombinedModal('snack')">
            <span style="font-size: 40px; margin-bottom: 10px;">ğŸ¥ª</span> ë¶€ì‹ ì‹ ì²­
        </button>
    </div>

    <h3 style="text-align: left; margin-left: 5px;">ğŸš ì˜¤ëŠ˜ ë­ ë¨¹ì§€? (ì‹ì‚¬ ì‹ ì²­)</h3>
    <div class="meal-grid">
        <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸ë³´ìŒˆ</button>
        <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹</button>
        <button class="btn btn-meal" onclick="openCombinedModal('meal', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
        <button class="btn btn-meal btn-disabled">ì¤€ë¹„ì¤‘</button>
    </div>

    <div class="ad-grid">
        <a id="ad1Link" href="#" target="_blank"><div id="ad1" class="btn btn-ad"><span>AD</span></div></a>
        <a id="ad2Link" href="#" target="_blank"><div id="ad2" class="btn btn-ad"><span>AD</span></div></a>
    </div>
</div>

<div id="loginModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('loginModal')">&times;</span>
        <h2 id="modalTitle">ì¸ì¦ ë° ì‹ ì²­</h2>
        <div id="activitySection">
            <div style="text-align:center; font-size:14px; margin-bottom:10px; color:#666;">âœ¨ ì˜¤ëŠ˜ì˜ í™œë™ ì„ íƒ (í•„ìˆ˜)</div>
            <div class="radio-group">
                <div class="radio-item"><input type="radio" id="act1" name="activity" value="ê¸°ì´ˆì†Œì–‘êµìœ¡" checked><label for="act1">ğŸ“š ê¸°ì´ˆì†Œì–‘</label></div>
                <div class="radio-item"><input type="radio" id="act2" name="activity" value="í”„ë¡œê·¸ë¨"><label for="act2">ğŸ¨ í”„ë¡œê·¸ë¨</label></div>
                <div class="radio-item"><input type="radio" id="act3" name="activity" value="ìŠ¤í„°ë””ì¹´í˜"><label for="act3">âœï¸ ìŠ¤í„°ë””</label></div>
            </div>
        </div>
        <div class="input-group"><input type="text" id="loginId" placeholder="ì•„ì´ë”” (ì´ë¦„+ìƒë…„ì›”ì¼)"></div>
        <div class="input-group"><input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸"></div>
        <button class="btn-confirm" onclick="processAllInOne()">ì‹ ì²­ ì™„ë£Œí•˜ê¸°</button>
    </div>
</div>

<div id="registerModal" class="modal">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('registerModal')">&times;</span>
        <h2>íšŒì›ê°€ì…</h2>
        <div class="input-group"><input type="text" id="regName" placeholder="ì´ë¦„"></div>
        <div class="input-group"><input type="tel" id="regBirth" maxlength="6" placeholder="ìƒë…„ì›”ì¼ 6ìë¦¬"></div>
        <div class="input-group"><input type="password" id="regPw" placeholder="ë¹„ë°€ë²ˆí˜¸"></div>
        <div class="input-group"><input type="password" id="regPwConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"></div>
        <button class="btn-confirm" onclick="registerUser()">ê°€ì…í•˜ê¸°</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // ê´‘ê³  ì„¤ì •
    const AD_CONFIG = {
        ad1: { image: "https://via.placeholder.com/300x150/333/fff?text=Notice", link: "https://www.google.com" },
        ad2: { image: "https://via.placeholder.com/300x150/FF9800/fff?text=Event", link: "https://www.naver.com" }
    };
    document.getElementById('ad1').style.backgroundImage = `url('${AD_CONFIG.ad1.image}')`;
    document.getElementById('ad1Link').href = AD_CONFIG.ad1.link;
    document.getElementById('ad2').style.backgroundImage = `url('${AD_CONFIG.ad2.image}')`;
    document.getElementById('ad2Link').href = AD_CONFIG.ad2.link;

    const firebaseConfig = {
      apiKey: "AIzaSyAalHhoEK-ko55Jep-7k8ULHeaWWU99oh8",
      authDomain: "dream-meal-support.firebaseapp.com",
      projectId: "dream-meal-support",
      storageBucket: "dream-meal-support.firebasestorage.app",
      messagingSenderId: "230720243044",
      appId: "1:230720243044:web:eb38ecc28353a1c70aa671"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentType = ""; 
    let currentTargetName = "";

    window.openCombinedModal = (type, targetName = "") => {
        currentType = type;
        currentTargetName = targetName;
        document.getElementById('loginId').value = '';
        document.getElementById('loginPw').value = '';
        
        const title = document.getElementById('modalTitle');
        if(type === 'attendance') title.innerText = "ì¶œì„ ì²´í¬";
        else if(type === 'meal') title.innerText = `[${targetName}] ì‹ì‚¬ ì‹ ì²­`;
        else if(type === 'snack') title.innerText = "ë¶€ì‹ ì‹ ì²­";
        document.getElementById('loginModal').style.display = 'flex';
    };

    window.processAllInOne = async () => {
        const rawId = document.getElementById('loginId').value.replace(/\s/g, ''); 
        const pw = document.getElementById('loginPw').value;
        const selectedAct = document.querySelector('input[name="activity"]:checked').value;
        const idMatch = rawId.match(/^([ê°€-í£a-zA-Z]+)(\d{6})$/);

        if(!idMatch) return alert("ì•„ì´ë”” í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.");
        const name = idMatch[1];
        const birth = idMatch[2];

        try {
            const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth), where("password", "==", pw));
            const snapshot = await getDocs(q);
            if(snapshot.empty) return alert("ì •ë³´ê°€ í‹€ë¦½ë‹ˆë‹¤.");

            const userDoc = snapshot.docs[0];
            const userId = userDoc.id;
            const userData = userDoc.data();
            const today = new Date().toISOString().split('T')[0];

            let collectionName = "";
            let dataPayload = { student_id: userId, student_name: userData.name, activity: selectedAct, date: today, timestamp: Timestamp.now() };
            let msg = "";

            if(currentType === 'attendance') {
                collectionName = "attendance";
                msg = `${userData.name}ë‹˜, [${selectedAct}] ì¶œì„ ì™„ë£Œ!`;
            } else if(currentType === 'meal') {
                // ì´ë¯¸ ì‹ ì²­í–ˆëŠ”ì§€ í™•ì¸
                const checkQ = query(collection(db, "meal_applications"), where("student_id", "==", userId), where("date", "==", today));
                const checkSnap = await getDocs(checkQ);
                if(!checkSnap.empty) return alert("ì´ë¯¸ ì˜¤ëŠ˜ ê¸‰ì‹ì„ ì‹ ì²­í•˜ì…¨ìŠµë‹ˆë‹¤.");

                collectionName = "meal_applications";
                dataPayload.store_name = currentTargetName;
                dataPayload.status = "applied"; // ì‹ ì²­ ì™„ë£Œ ìƒíƒœ
                msg = `${userData.name}ë‹˜, [${currentTargetName}] ì‹ ì²­ ì™„ë£Œ!\nì‹ë‹¹ì— ê°€ì„œ QRì½”ë“œë¥¼ ì°ì–´ì£¼ì„¸ìš”.`;
            } else if(currentType === 'snack') {
                collectionName = "snacks";
                dataPayload.item = "ê°„ì‹ ì„¸íŠ¸";
                msg = "ë¶€ì‹ ì‹ ì²­ ì™„ë£Œ!";
            }

            await addDoc(collection(db, collectionName), dataPayload);
            alert(msg);
            closeModal('loginModal');

        } catch(e) { console.error(e); alert("ì˜¤ë¥˜ ë°œìƒ"); }
    };

    window.closeModal = (id) => document.getElementById(id).style.display = 'none';
    window.openRegisterModal = () => document.getElementById('registerModal').style.display = 'flex';
    window.registerUser = async () => { /* (íšŒì›ê°€ì… ë¡œì§ ê¸°ì¡´ê³¼ ë™ì¼) */ };
</script>
</body>
</html>