<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ì›êµ¬ ê¿ˆë“œë¦¼ - ì„¼í„° í‚¤ì˜¤ìŠ¤í¬</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/inko@1.1.1/inko.min.js"></script>

    <style>
        :root {
            --primary: #6C5CE7;
            --bg-body: #F4F7F6;
            --text-main: #2D3436;
            --shadow-card: 0 10px 20px rgba(0,0,0,0.06);
            --radius-card: 28px;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-body);
            height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        /* ì „ì²´ ì»¨í…Œì´ë„ˆ */
        .kiosk-wrapper {
            width: 96%; height: 94vh;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(30px);
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.6);
            padding: 30px 50px;
            display: flex; flex-direction: column; gap: 20px;
        }

        /* 1. í—¤ë” ì˜ì—­ */
        .header {
            flex: 0 0 60px;
            display: flex; justify-content: space-between; align-items: center;
            position: relative;
        }
        .header-title {
            position: absolute; left: 50%; transform: translateX(-50%);
            font-size: 34px; font-weight: 900; color: var(--text-main); margin: 0; letter-spacing: -1px;
        }
        .header-btn {
            padding: 10px 24px; border-radius: 50px; font-size: 16px; font-weight: 700;
            border: none; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-tutorial { background: #FF7675; color: white; }
        .btn-tutorial:hover { transform: scale(1.05); background: #ff5252; }
        .btn-register { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-register:hover { transform: scale(1.05); background: var(--primary); color: white; }

        /* 2. ë©”ì¸ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ (ì¢Œìš° ë¶„í• ) */
        .main-grid {
            flex: 1;
            display: flex;
            gap: 30px;
            height: 100%;
            overflow: hidden;
        }

        /* [ì™¼ìª½ ì»¬ëŸ¼] ë²„íŠ¼(ìƒ) + ê´‘ê³ (í•˜) */
        .left-column {
            flex: 1.8; /* í™”ë©´ì˜ ì•½ 65% ì°¨ì§€ */
            display: flex; flex-direction: column; gap: 20px;
        }

        /* ì™¼ìª½ ìƒë‹¨: ê¸°ëŠ¥ ë²„íŠ¼ 2ê°œ (ë†’ì´ 28%ë¡œ ì¶•ì†Œ) */
        .left-top {
            flex: 0 0 28%; 
            display: flex; gap: 25px;
        }
        .func-card {
            flex: 1; border-radius: var(--radius-card); border: none; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            font-size: 24px; font-weight: 800; color: white;
            box-shadow: var(--shadow-card); transition: transform 0.2s; gap: 10px;
        }
        .func-card .emoji { font-size: 48px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); }
        .func-card:hover { transform: translateY(-5px); filter: brightness(1.05); }
        .card-attendance { background: linear-gradient(135deg, #6C5CE7, #8e7bf5); }
        .card-snack { background: linear-gradient(135deg, #FF7675, #fab1a0); }

        /* ì™¼ìª½ í•˜ë‹¨: ê´‘ê³  3ê°œ */
        .left-bottom {
            flex: 1; 
            display: flex; 
            gap: 20px;
            justify-content: center; 
            min-height: 0; 
        }
        
        .ad-wrapper {
            height: 100%; width: auto; 
            aspect-ratio: 4 / 5;
            border-radius: var(--radius-card);
            overflow: hidden;
            box-shadow: var(--shadow-card);
            background: #eee;
            position: relative;
            transition: transform 0.3s;
            display: block; 
        }
        .ad-wrapper:hover { transform: translateY(-5px); z-index: 10; }
        
        .ad-img-tag {
            width: 100%; height: 100%;
            object-fit: cover; 
            display: block;
        }


        /* [ì˜¤ë¥¸ìª½ ì»¬ëŸ¼] ê¸‰ì‹ ë©”ë‰´íŒ (5ë‹¨ ë³€ê²½) */
        .right-column {
            flex: 1; /* í™”ë©´ì˜ ì•½ 35% ì°¨ì§€ */
            background: white;
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-card);
            padding: 30px;
            display: flex; flex-direction: column;
        }
        .meal-title-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 15px; /* ì—¬ë°± ì•½ê°„ ì¤„ì„ */
        }
        .meal-icon-bg {
            background: #FF7675; color: white; width: 40px; height: 40px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .meal-title { font-size: 22px; font-weight: 800; color: var(--text-main); margin: 0; }

        .meal-list {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr; 
            grid-template-rows: repeat(5, 1fr); 
            gap: 12px; 
        }
        
        .meal-card-btn {
            background: white; border: 2px solid #F1F3F5;
            border-radius: 20px; cursor: pointer;
            display: flex; align-items: center; 
            padding: 0; overflow: hidden;
            transition: 0.2s;
            text-align: left;
        }
        .meal-card-btn:hover:not(:disabled) {
            border-color: var(--primary); box-shadow: 0 4px 15px rgba(108, 92, 231, 0.15); transform: translateX(5px);
        }
        .meal-card-btn:disabled { opacity: 0.6; cursor: not-allowed; background: #F8F9FA; }
        
        .meal-img-box {
            width: 100px; 
            height: 100%;
            background-color: #eee;
            background-size: cover; background-position: center;
            flex-shrink: 0; 
        }
        .meal-info {
            padding: 0 15px; 
            flex: 1;
        }
        .meal-name { font-size: 18px; font-weight: 800; color: #495057; display: block; margin-bottom: 2px; }
        .meal-desc { font-size: 12px; color: #868E96; font-weight: 500; }
        

        /* ìœ í‹¸ë¦¬í‹° */
        #loadingOverlay {
            display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.85); z-index: 10000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #blockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f2f5; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: #333;
        }

        /* SweetAlert Custom */
        .swal-radio-group { display: flex; gap: 10px; margin: 15px 0 25px; }
        .swal-radio-item { flex: 1; }
        .swal-radio-item input { display: none; }
        .swal-radio-item label { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 90px; background: #f8f9fa; border-radius: 15px; 
            font-size: 14px; font-weight: 700; color: #636e72; cursor: pointer; 
            border: 2px solid transparent; transition: 0.2s; 
        }
        .swal-radio-item label span { font-size: 28px; margin-bottom: 5px; }
        .swal-radio-item input:checked + label { 
            background: #ede9fe; border-color: var(--primary); color: var(--primary); 
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.2);
        }
    </style>
</head>
<body>

    <div id="blockScreen">
        <h1 style="font-size: 80px; margin-bottom: 20px;">ğŸ”’</h1>
        <h2>ì ‘ê·¼ì´ ì œí•œëœ ê¸°ê¸°ì…ë‹ˆë‹¤.</h2>
        <p style="color:#666; font-size:18px;">ì„¼í„° ê´€ë¦¬ìì—ê²Œ ê¸°ê¸° ë“±ë¡ì„ ìš”ì²­í•˜ì„¸ìš”.</p>
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:bold; color:#555;">ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div class="kiosk-wrapper" id="mainContent" style="display:none;">
        
        <header class="header">
            <button onclick="openTutorialModal()" class="header-btn btn-tutorial">â–¶ ê¸‰ì‹ íŠœí† ë¦¬ì–¼</button>
            <h1 class="header-title">ë…¸ì›êµ¬ ê¿ˆë“œë¦¼</h1>
            <button onclick="openRegisterModal()" class="header-btn btn-register">ğŸ†• íšŒì›ê°€ì…</button>
        </header>

        <div class="main-grid">
            
            <div class="left-column">
                
                <div class="left-top">
                    <button class="func-card card-attendance" onclick="openCombinedModal('attendance')">
                        <span class="emoji">ğŸ“…</span>
                        <span>ì¶œì„í•˜ê¸°</span>
                    </button>
                    <button class="func-card card-snack" onclick="openCombinedModal('snack')">
                        <span class="emoji">ğŸ¥ª</span>
                        <span>ë¶€ì‹ ì‹ ì²­</span>
                    </button>
                </div>

                <div class="left-bottom">
                    <a id="ad1Link" href="#" target="_blank" class="ad-wrapper">
                        <img id="ad1Img" class="ad-img-tag" alt="ê´‘ê³ 1" onerror="this.src='https://placehold.co/400x500?text=No+Image';">
                    </a>
                    <a id="ad2Link" href="#" target="_blank" class="ad-wrapper">
                        <img id="ad2Img" class="ad-img-tag" alt="ê´‘ê³ 2" onerror="this.src='https://placehold.co/400x500?text=No+Image';">
                    </a>
                    <a id="ad3Link" href="#" target="_blank" class="ad-wrapper">
                        <img id="ad3Img" class="ad-img-tag" alt="ê´‘ê³ 3" onerror="this.src='https://placehold.co/400x500?text=No+Image';">
                    </a>
                </div>
            </div>

            <div class="right-column">
                <div class="meal-title-row">
                    <div class="meal-icon-bg">ğŸš</div>
                    <h2 class="meal-title">ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</h2>
                </div>
                
                <div class="meal-list">
                    <button class="meal-card-btn" onclick="openCombinedModal('meal', 'ë‹¬ì¸ë³´ìŒˆ')">
                        <div class="meal-img-box" style="background-image: url('https://lh6.googleusercontent.com/proxy/fg-7Jv4MQ5BhHB_TKyR5FMtR7ml9_IArZWnH7NYgJgG2JfmPIUjUOHkERnJ9hMvscTsPLoOMauUHll4ZndknzFoREYeY9ipZwjCDkDo9-sZfX8V_jnk6PIqX9KG_8GFgUZxsuoh7TA');"></div>
                        <div class="meal-info">
                            <span class="meal-name">ë‹¬ì¸ë³´ìŒˆ</span>
                            <span class="meal-desc">ë“ ë“ í•œ ë³´ìŒˆ ì •ì‹ 11:30~18:(ì›”íœ´ë¬´, ë¸Œë ˆì´í¬íƒ€ì„)</span>
                        </div>
                    </button>

                    <button class="meal-card-btn" onclick="openCombinedModal('meal', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">
                        <div class="meal-img-box" style="background-image: url('https://cdn.e2news.com/news/photo/201511/85026_37781_5340.jpg');"></div>
                        <div class="meal-info">
                            <span class="meal-name">ë¯¸ìŠ¤í…Œë¦¬</span>
                            <span class="meal-desc">ë–¡ë³¶ì´ì™€ íŠ€ê¹€ 10:30~18:00</span>
                        </div>
                    </button>

                    <button class="meal-card-btn" onclick="openCombinedModal('meal', 'ì—°ê¹€ë°¥')">
                        <div class="meal-img-box" style="background-image: url('https://newsimg.sedaily.com/2025/01/14/2GNOXAIO35_1.jpg');"></div>
                        <div class="meal-info">
                            <span class="meal-name">ì—°ê¹€ë°¥</span>
                            <span class="meal-desc">ì‹ ì„ í•œ ì¬ë£Œ ê¹€ë°¥ 9:00~18:00(í¬ì¥, ì›”íœ´ë¬´)</span>
                        </div>
                    </button>

                    <button class="meal-card-btn" onclick="openCombinedModal('meal', 'ë™ì¼ë¡œì¦‰ì„ë–¡ë³¶ì´')">
                        <div class="meal-img-box" style="background-image: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQQI7NcXwWn8lSL6L0_OH1i0gCv-wLewsEHSg&s');"></div>
                        <div class="meal-info">
                            <span class="meal-name">ë™ì¼ë¡œë–¡ë³¶ì´</span>
                            <span class="meal-desc">ì¦‰ì„ ë–¡ë³¶ì´ ë§›ì§‘ 11:00~18:00</span>
                        </div>
                    </button>

                    <button class="meal-card-btn" onclick="openCombinedModal('meal', 'ìš°ë¦¬ë™ë„¤ ì²«ë¼')">
                        <div class="meal-img-box" style="background-image: url('https://image.8dogam.com/resized/product/asset/v1/upload/1df07dda12d14bc6bbbb2fdf80cd8803.jpeg?type=big&res=3x&ext=jpg');"></div>
                        <div class="meal-info">
                            <span class="meal-name">ìš°ë¦¬ë™ë„¤ ì²«ë¼</span>
                            <span class="meal-desc">ìƒŒë“œìœ„ì¹˜ì™€ ìƒëŸ¬ë“œ 9:00~14:00(í¬ì¥)</span>
                        </div>
                    </button>
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        import { db, collection, addDoc, query, where, getDocs, getDoc, doc, Timestamp } from "./js/firebase-config.js";

        const inko = new Inko();

        const getTodayStr = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        };

        const showLoading = (show) => {
            document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none';
        };

        const convertToDirectLink = (url) => {
            if (!url) return "";
            const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)\//);
            if (match && match[1]) {
                return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w1000`;
            }
            return url;
        };

        // --- ê´‘ê³  ë¡œë“œ (ìºì‹± ì ìš©ë¨) ---
        const DEFAULT_ADS = {
            ad1: { image: "https://placehold.co/400x500?text=Dream+Center", link: "#" },
            ad2: { image: "https://placehold.co/400x500?text=Ad+Space+2", link: "#" },
            ad3: { image: "https://placehold.co/400x500?text=Ad+Space+3", link: "#" }
        };

        // ê´‘ê³ ë¥¼ í™”ë©´ì— ë¿Œë ¤ì£¼ëŠ” í•¨ìˆ˜
        const applyAdsToScreen = (data) => {
            const setAd = (imgId, linkId, imgKey, linkKey, def) => {
                const imgEl = document.getElementById(imgId);
                const linkEl = document.getElementById(linkId);
                
                let rawUrl = data[imgKey];
                if(rawUrl && rawUrl.trim() !== "") {
                    imgEl.src = convertToDirectLink(rawUrl);
                } else {
                    imgEl.src = def.image;
                }
                
                if(data[linkKey]) linkEl.href = data[linkKey];
            };
            setAd('ad1Img', 'ad1Link', 'ad1_img', 'ad1_link', DEFAULT_ADS.ad1);
            setAd('ad2Img', 'ad2Link', 'ad2_img', 'ad2_link', DEFAULT_ADS.ad2);
            setAd('ad3Img', 'ad3Link', 'ad3_img', 'ad3_link', DEFAULT_ADS.ad3);
        };

        // [í•µì‹¬] ìºì‹±ì´ ì ìš©ëœ loadAds í•¨ìˆ˜
        const loadAds = async () => {
            const CACHE_DURATION = 1000 * 60 * 60; // 1ì‹œê°„
            const now = Date.now();

            const savedAds = localStorage.getItem('ads_cache');
            const savedTime = localStorage.getItem('ads_timestamp');

            if (savedAds && savedTime && (now - Number(savedTime) < CACHE_DURATION)) {
                console.log("ê´‘ê³ : ìºì‹œ ì‚¬ìš© (ë¹„ìš© 0ì›)");
                applyAdsToScreen(JSON.parse(savedAds));
                return;
            }

            console.log("ê´‘ê³ : ì„œë²„ì—ì„œ ê°€ì ¸ì˜´ (ë¹„ìš© ë°œìƒ)");
            try {
                const docRef = doc(db, "settings", "ads");
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    localStorage.setItem('ads_cache', JSON.stringify(data));
                    localStorage.setItem('ads_timestamp', now.toString());
                    applyAdsToScreen(data);
                } else {
                    applyAdsToScreen({});
                }
            } catch(e) { 
                if (savedAds) applyAdsToScreen(JSON.parse(savedAds));
                else applyAdsToScreen({});
            }
        };

        // --- ê¸°ê¸° ì¸ì¦ ---
        const checkDeviceAuth = () => {
            const isAuthorized = localStorage.getItem('kiosk_auth_token') === 'dream_center_pc';
            if (isAuthorized) {
                document.getElementById('blockScreen').style.display = 'none';
                document.getElementById('mainContent').style.display = 'flex';
                loadAds();
            } else { console.log("ë¯¸ì¸ì¦ ê¸°ê¸°"); }
        };

        // --- íŠœí† ë¦¬ì–¼ (ì´ë¯¸ì§€) ---
        window.openTutorialModal = () => {
            Swal.fire({
                title: '<strong>ê¸‰ì‹ íŠœí† ë¦¬ì–¼</strong>',
                // ì£¼ì˜: ì•„ë˜ src ê²½ë¡œì— ìˆëŠ” íŒŒì¼ëª…(tutorial.png)ì´ í´ë”ì— ìˆëŠ” íŒŒì¼ëª…ê³¼ ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
                html: `<img src="./tutorial.png" style="width: 100%; height: auto; border-radius: 10px; display: block;" alt="ê¸‰ì‹ íŠœí† ë¦¬ì–¼ ì´ë¯¸ì§€">`,
                showCloseButton: true, 
                showConfirmButton: false, 
                width: 700, 
                padding: '20px'
            });
        };

        // --- [í•µì‹¬] í•œì˜ ìë™ì¡°ë¦½ í•¨ìˆ˜ (gkd -> ã…ã…—ã…‡ -> í™) ---
        const autoConvertHanEng = (text) => {
            // 1. í˜„ì¬ ì…ë ¥ëœ ê°’ ì „ì²´ë¥¼ ì˜ì–´ ìíŒ ê¸°ì¤€ìœ¼ë¡œ í•´ì²´ (ì˜ˆ: í™ -> ghd)
            const eng = inko.ko2en(text); 
            // 2. í•´ì²´ëœ ì˜ì–´ë¥¼ ë‹¤ì‹œ í•œê¸€ë¡œ ì¡°ë¦½ (ì˜ˆ: ghd -> í™)
            // ì´ë ‡ê²Œ í•´ì•¼ ìì†Œ(ã…,ã…—,ã…‡)ê°€ ë¶„ë¦¬ë˜ì§€ ì•Šê³  í•©ì³ì§‘ë‹ˆë‹¤.
            return inko.en2ko(eng);       
        };

        // --- [ìˆ˜ì •ë¨] íšŒì›ê°€ì… ëª¨ë‹¬ (ì´ë¦„: í•œê¸€ë§Œ) ---
        window.openRegisterModal = async () => {
            const { value: formValues } = await Swal.fire({
                title: 'íšŒì›ê°€ì…',
                html: '<input id="swal-name" class="swal2-input" placeholder="ì´ë¦„ (ì˜ˆ: í™ê¸¸ë™)">' +
                      '<input id="swal-birth" class="swal2-input" type="tel" maxlength="6" placeholder="ìƒë…„ì›”ì¼ (ì˜ˆ: 080101)">' +
                      '<input id="swal-pw" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì„¤ì •">' +
                      '<input id="swal-pw2" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">',
                focusConfirm: false, showCancelButton: true, confirmButtonText: 'ê°€ì…í•˜ê¸°',
                didOpen: () => {
                    // [ì¤‘ìš”] ì´ë¦„ ì…ë ¥ ì‹œ: í•œì˜ ìë™ì¡°ë¦½ + í•œê¸€ ì™¸ ì œê±°
                    const nameInput = document.getElementById('swal-name');
                    nameInput.addEventListener('input', function() {
                        const converted = autoConvertHanEng(this.value);
                        // ã„±-ã…ã…-ã…£ (ììŒëª¨ìŒ)ë„ í¬í•¨í•´ì•¼ ì…ë ¥ ì¤‘ê°„ì— ì•ˆ ì‚¬ë¼ì§
                        this.value = converted.replace(/[^ê°€-í£ã„±-ã…ã…-ã…£]/g, '');
                    });
                },
                preConfirm: () => [
                    document.getElementById('swal-name').value,
                    document.getElementById('swal-birth').value,
                    document.getElementById('swal-pw').value,
                    document.getElementById('swal-pw2').value
                ]
            });

            if (formValues) {
                const [name, birth, pw, pw2] = formValues;
                if(!name || birth.length !== 6 || !pw) return Swal.fire('ì˜¤ë¥˜', 'ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                if(pw !== pw2) return Swal.fire('ì˜¤ë¥˜', 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                showLoading(true);
                try {
                    const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth));
                    const snap = await getDocs(q);
                    if(!snap.empty) { showLoading(false); return Swal.fire('ì˜¤ë¥˜', 'ì´ë¯¸ ê°€ì…ëœ íšŒì›ì…ë‹ˆë‹¤.', 'warning'); }
                    await addDoc(collection(db, "users"), { name, birth, password: pw, role: 'student', createdAt: Timestamp.now() });
                    showLoading(false); Swal.fire('ì„±ê³µ', 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                } catch(e) { showLoading(false); Swal.fire('ì˜¤ë¥˜', 'ì‹œìŠ¤í…œ ì˜¤ë¥˜', 'error'); }
            }
        };

        // --- [ìˆ˜ì •ë¨] í†µí•© ì‹ ì²­ ëª¨ë‹¬ (ì•„ì´ë””: í•œê¸€+ìˆ«ì) ---
        window.openCombinedModal = async (type, targetName = "") => {
            let titleText = type === 'attendance' ? "ì¶œì„ ì²´í¬" : (type === 'meal' ? `[${targetName}] ì‹ì‚¬ ì‹ ì²­` : "ë¶€ì‹ ì‹ ì²­");
            const activityHtml = `
                <div style="text-align:center; font-size:15px; margin-bottom:10px; color:#666; font-weight:bold;">âœ¨ ì˜¤ëŠ˜ì˜ í™œë™ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
                <div class="swal-radio-group">
                    <div class="swal-radio-item"><input type="radio" id="act1" name="activity" value="ê¸°ì´ˆì†Œì–‘êµìœ¡" checked><label for="act1"><span>ğŸ“š</span>ê¸°ì´ˆì†Œì–‘</label></div>
                    <div class="swal-radio-item"><input type="radio" id="act2" name="activity" value="í”„ë¡œê·¸ë¨"><label for="act2"><span>ğŸ¨</span>í”„ë¡œê·¸ë¨</label></div>
                    <div class="swal-radio-item"><input type="radio" id="act3" name="activity" value="ìŠ¤í„°ë””ì¹´í˜"><label for="act3"><span>âœï¸</span>ìŠ¤í„°ë””</label></div>
                </div>`;

            const { value: result } = await Swal.fire({
                title: titleText,
                html: activityHtml +
                      '<input id="loginId" class="swal2-input" placeholder="ì•„ì´ë”” (ì´ë¦„+ìƒë…„ì›”ì¼)" style="ime-mode:active;">' +
                      '<input id="loginPw" class="swal2-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸">',
                showCancelButton: true, confirmButtonText: 'ì‹ ì²­ ì™„ë£Œ', width: 600,
                didOpen: () => {
                    // [ì¤‘ìš”] ì•„ì´ë”” ì…ë ¥ ì‹œ: í•œì˜ ìë™ì¡°ë¦½ + í•œê¸€/ìˆ«ìë§Œ í—ˆìš©
                    const idInput = document.getElementById('loginId');
                    idInput.addEventListener('input', function() {
                        const converted = autoConvertHanEng(this.value);
                        // ìˆ«ì(0-9)ë„ í—ˆìš©í•´ì•¼ ìƒë…„ì›”ì¼ ì…ë ¥ ê°€ëŠ¥
                        this.value = converted.replace(/[^ê°€-í£ã„±-ã…ã…-ã…£0-9]/g, '');
                    });
                },
                preConfirm: () => {
                    const actInput = document.querySelector('input[name="activity"]:checked');
                    return { activity: actInput ? actInput.value : "ê¸°ì´ˆì†Œì–‘êµìœ¡", id: document.getElementById('loginId').value, pw: document.getElementById('loginPw').value }
                }
            });

            if (result) processApplication(type, targetName, result.activity, result.id, result.pw);
        };

        const processApplication = async (type, targetName, activity, rawId, pw) => {
            const cleanId = rawId.replace(/\s/g, '');
            const idMatch = cleanId.match(/^([ê°€-í£a-zA-Z]+)(\d{6})$/);
            if(!idMatch) return Swal.fire('ì˜¤ë¥˜', 'ì•„ì´ë””ëŠ” ì´ë¦„+ìƒë…„ì›”ì¼6ìë¦¬ ì…ë‹ˆë‹¤.', 'warning');
            
            const name = idMatch[1]; const birth = idMatch[2];
            showLoading(true);

            try {
                const q = query(collection(db, "users"), where("name", "==", name), where("birth", "==", birth), where("password", "==", pw));
                const snapshot = await getDocs(q);
                if(snapshot.empty) { showLoading(false); return Swal.fire('ì¸ì¦ ì‹¤íŒ¨', 'íšŒì›ì •ë³´ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error'); }

                const userDoc = snapshot.docs[0]; const userId = userDoc.id; const userData = userDoc.data(); const today = getTodayStr();
                let collectionName = "", dataPayload = { student_id: userId, student_name: userData.name, activity: activity, date: today, timestamp: Timestamp.now() }, successMsg = "";

                if(type === 'attendance') {
                    collectionName = "attendance"; successMsg = `${userData.name}ë‹˜, [${activity}] ì¶œì„ë˜ì…¨ìŠµë‹ˆë‹¤!`;
                } else if(type === 'meal') {
                    const checkQ = query(collection(db, "meal_applications"), where("student_id", "==", userId), where("date", "==", today));
                    const checkSnap = await getDocs(checkQ);
                    let isBlocked = false; checkSnap.forEach(doc => { if (doc.data().status === 'applied' || doc.data().status === 'approved') isBlocked = true; });
                    if(isBlocked) { showLoading(false); return Swal.fire('ì‹ ì²­ ë¶ˆê°€', 'ì´ë¯¸ ì§„í–‰ ì¤‘ì¸ ì‹ì‚¬ ì‹ ì²­ì´ ìˆìŠµë‹ˆë‹¤.', 'warning'); }
                    
                    collectionName = "meal_applications"; 
                    dataPayload.store_name = targetName; 
                    dataPayload.status = "approved";
                    successMsg = `${userData.name}ë‹˜, [${targetName}] ì‹ ì²­ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                
                } else if(type === 'snack') {
                    collectionName = "snacks"; dataPayload.item = "ê°„ì‹ ì„¸íŠ¸"; successMsg = "ë§›ìˆê²Œ ë“œì„¸ìš”!";
                }

                await addDoc(collection(db, collectionName), dataPayload);
                showLoading(false); Swal.fire('ì„±ê³µ', successMsg, 'success');
            } catch(e) { showLoading(false); Swal.fire('ì‹œìŠ¤í…œ ì˜¤ë¥˜', 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error'); }
        };

        checkDeviceAuth();
    </script>
</body>
</html>
