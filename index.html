<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë…¸ì›êµ¬ ê¿ˆë“œë¦¼ - ì„¼í„° í‚¤ì˜¤ìŠ¤í¬</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root {
            --primary: #6C5CE7;
            --bg-body: #F4F7F6;
            --text-main: #2D3436;
            --shadow-card: 0 10px 20px rgba(0,0,0,0.06);
            --radius-card: 28px;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-body);
            height: 100vh;
            overflow: hidden;
            display: flex; justify-content: center; align-items: center;
        }

        .kiosk-wrapper {
            width: 96%; height: 94vh;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(30px);
            border-radius: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.08);
            border: 1px solid rgba(255,255,255,0.6);
            padding: 30px 50px;
            display: flex; flex-direction: column; gap: 20px;
        }

        /* 1. í—¤ë” */
        .header {
            flex: 0 0 60px;
            display: flex; justify-content: space-between; align-items: center;
            position: relative;
        }
        .header-title {
            position: absolute; left: 50%; transform: translateX(-50%);
            font-size: 34px; font-weight: 900; color: var(--text-main); margin: 0; letter-spacing: -1px;
        }
        .header-btn {
            padding: 10px 24px; border-radius: 50px; font-size: 16px; font-weight: 700;
            border: none; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-tutorial { background: #FF7675; color: white; }
        .btn-tutorial:hover { transform: scale(1.05); background: #ff5252; }
        .btn-register { background: white; color: var(--primary); border: 2px solid var(--primary); }
        .btn-register:hover { transform: scale(1.05); background: var(--primary); color: white; }

        /* 2. ë©”ì¸ ë ˆì´ì•„ì›ƒ (ì¢Œìš° ë¶„í• ) */
        .main-grid {
            flex: 1;
            display: flex;
            gap: 30px;
            height: 100%;
            overflow: hidden;
        }

        /* [ì™¼ìª½ ì˜ì—­] ë²„íŠ¼(ìƒ) + ê´‘ê³ (í•˜) */
        .left-column {
            flex: 1.8; /* í™”ë©´ì˜ ì•½ 65% */
            display: flex; flex-direction: column; gap: 20px;
        }

        /* [ìˆ˜ì •ë¨] ì™¼ìª½ ìƒë‹¨: ê¸°ëŠ¥ ë²„íŠ¼ (ë†’ì´ë¥¼ ì¤„ì„: ì•½ 28%) */
        .left-top {
            flex: 0 0 28%; /* ê³ ì • ë¹„ìœ¨ */
            display: flex; gap: 25px;
        }
        .func-card {
            flex: 1; border-radius: var(--radius-card); border: none; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; justify-content: center; /* ê°€ë¡œ ë°°ì¹˜ */
            font-size: 24px; font-weight: 800; color: white;
            box-shadow: var(--shadow-card); transition: transform 0.2s; gap: 10px;
        }
        /* ë²„íŠ¼ì´ ë‚©ì‘í•´ì¡Œìœ¼ë¯€ë¡œ ë‚´ë¶€ ìš”ì†Œ ë°°ì¹˜ ì¡°ì • */
        .func-card .emoji { font-size: 48px; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.2)); }
        
        .func-card:hover { transform: translateY(-5px); filter: brightness(1.05); }
        .card-attendance { background: linear-gradient(135deg, #6C5CE7, #8e7bf5); }
        .card-snack { background: linear-gradient(135deg, #FF7675, #fab1a0); }
        

        /* [ìˆ˜ì •ë¨] ì™¼ìª½ í•˜ë‹¨: ê´‘ê³  3ê°œ (ë†’ì´ë¥¼ í‚¤ì›€: ë‚˜ë¨¸ì§€ ì „ë¶€) */
        .left-bottom {
            flex: 1; /* ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
            display: flex; 
            gap: 20px;
            justify-content: center; 
            min-height: 0; /* flex overflow ë°©ì§€ */
        }
        
        .ad-wrapper {
            height: 100%; /* ë¶€ëª¨ ë†’ì´(ì»¤ì§„ ì˜ì—­)ì— ê½‰ ì±„ì›€ */
            width: auto; 
            aspect-ratio: 4 / 5; /* 4:5 ë¹„ìœ¨ ê°•ì œ ìœ ì§€ -> ë†’ì´ì— ë§ì¶° ë„ˆë¹„ ìë™ í™•ëŒ€ */
            
            border-radius: var(--radius-card);
            overflow: hidden;
            box-shadow: var(--shadow-card);
            background: #eee;
            position: relative;
            transition: transform 0.3s;
        }
        .ad-wrapper:hover { transform: translateY(-5px); z-index: 10; }
        .ad-img { width: 100%; height: 100%; background-size: cover; background-position: center; display: block; }


        /* [ì˜¤ë¥¸ìª½ ì˜ì—­] ê¸‰ì‹ ë©”ë‰´íŒ */
        .right-column {
            flex: 1; /* í™”ë©´ì˜ ì•½ 35% */
            background: white;
            border-radius: var(--radius-card);
            box-shadow: var(--shadow-card);
            padding: 30px;
            display: flex; flex-direction: column;
        }
        .meal-title-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px;
        }
        .meal-icon-bg {
            background: #FF7675; color: white; width: 40px; height: 40px;
            border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;
        }
        .meal-title { font-size: 22px; font-weight: 800; color: var(--text-main); margin: 0; }

        .meal-list {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr; 
            grid-template-rows: repeat(4, 1fr); 
            gap: 15px;
        }
        
        .meal-card-btn {
            background: white; border: 2px solid #F1F3F5;
            border-radius: 20px; cursor: pointer;
            display: flex; align-items: center; 
            padding: 0; overflow: hidden;
            transition: 0.2s;
            text-align: left;
        }
        .meal-card-btn:hover:not(:disabled) {
            border-color: var(--primary); box-shadow: 0 4px 15px rgba(108, 92, 231, 0.15); transform: translateX(5px);
        }
        .meal-card-btn:disabled { opacity: 0.6; cursor: not-allowed; background: #F8F9FA; }
        
        .meal-img-box {
            width: 110px; height: 100%;
            background-color: #eee;
            background-size: cover; background-position: center;
            flex-shrink: 0; 
        }
        .meal-info {
            padding: 0 20px;
            flex: 1;
        }
        .meal-name { font-size: 19px; font-weight: 800; color: #495057; display: block; margin-bottom: 4px; }
        .meal-desc { font-size: 13px; color: #868E96; font-weight: 500; }
        

        /* ìœ í‹¸ë¦¬í‹° */
        #loadingOverlay {
            display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.85); z-index: 10000;
            justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--primary);
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #blockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f2f5; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center; color: #333;
        }

        /* SweetAlert Custom */
        .swal-radio-group { display: flex; gap: 10px; margin: 15px 0 25px; }
        .swal-radio-item { flex: 1; }
        .swal-radio-item input { display: none; }
        .swal-radio-item label { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 90px; background: #f8f9fa; border-radius: 15px; 
            font-size: 14px; font-weight: 700; color: #636e72; cursor: pointer; 
            border: 2px solid transparent; transition: 0.2s; 
        }
        .swal-radio-item label span { font-size: 28px; margin-bottom: 5px; }
        .swal-radio-item input:checked + label { 
            background: #ede9fe; border-color: var(--primary); color: var(--primary); 
            box-shadow: 0 4px 10px rgba(108, 92, 231, 0.2);
        }
    </style>
</head>
<body>

    <div id="blockScreen">
        <h1 style="font-size: 80px; margin-bottom: 20px;">ğŸ”’</h1>
        <h2>ì ‘ê·¼ì´ ì œí•œëœ ê¸°ê¸°ì…ë‹ˆë‹¤.</h2>
        <p style="color:#666; font-size:18px;">ì„¼í„° ê´€ë¦¬ìì—ê²Œ ê¸°ê¸° ë“±ë¡ì„ ìš”ì²­í•˜ì„¸ìš”.</p>
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <p style="margin-top:20px; font-weight:bold; color:#555;">ì²˜ë¦¬ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div class="kiosk-wrapper" id="mainContent" style="display:none;">
        
        <header class="header">
            <button onclick="openTutorialModal()" class="header-btn btn-tutorial">â–¶ ê¸‰ì‹ íŠœí† ë¦¬ì–¼</button>
            <h1 class="header-title">ë…¸ì›êµ¬ ê¿ˆë“œë¦¼</h1>
            <button onclick="openRegisterModal()" class="header-btn btn-register">ğŸ†• íšŒì›ê°€ì…</button>
        </header>

        <div class="main-grid">
            
            <div class="left-column">
                
                <div class="left-top">
                    <button class="func-card card-attendance" onclick="openCombinedModal('attendance')">
                        <span class="emoji">ğŸ“…</span>
                        <span>ì¶œì„í•˜ê¸°</span>
                    </button>
                    <button class="func-card card-snack" onclick="openCombinedModal('snack')">
                        <span class="emoji">ğŸ¥ª</span>
                        <span>ë¶€ì‹ ì‹ ì²­</span>
                    </button>
                </div>

                <div class="left-bottom">
                    <div class="ad-wrapper">
                        <a id="ad1Link" href="#" target="_blank" class="ad-img" id="ad1"></a>
                    </div>
                    <div class="ad-wrapper">
                        <a id="ad2Link" href="#" target="_blank" class="ad-img" id="ad2"></a>
                    </div>
                    <div class="ad-wrapper">
                        <a id="ad3Link" href="#" target="_blank" class="ad-img" id="ad3"></a>
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="meal-title-row">
                    <div class="meal-icon-bg">ğŸš</div>
                    <h2 class="meal-title">ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</h2>
                </div>
                
                <div class="meal-list">
                    <button class="meal-card-btn" onclick="openCombinedModal('meal', 'ë‹¬ì¸ë³´ìŒˆ')">
                        <div class="meal-img-box" style="background-image: url('https://lh6.googleusercontent.com/proxy/fg-7Jv4MQ5BhHB_TKyR5FMtR7ml9_IArZWnH7NYgJgG2JfmPIUjUOHkERnJ9hMvscTsPLoOMauUHll4ZndknzFoREYeY9ipZwjCDkDo9-sZfX8V_jnk6PIqX9KG_8GFgUZxsuoh7TA');"></div>
                        <div class="meal-info">
                            <span class="meal-name">ë‹¬ì¸ë³´ìŒˆ</span>
                            <span class="meal-desc">ë§ˆëŠ˜ ë³´ìŒˆ ì •ì‹(ì›”ìš”ì¼ íœ´ë¬´)</span>
                        </div>
                    </button>

                    <button class="meal-card-btn" onclick="openCombinedModal('meal', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">
                        <div class="meal-img-box" style="background-image: url('https://cdn.e2news.com/news/photo/201511/85026_37781_5340.jpg');"></div>
                        <div class="meal-info">
                            <span class="meal-name">ë¯¸ìŠ¤í…Œë¦¬</span>
                            <span class="meal-desc">ë‹¤ì–‘í•œ ë¶„ì‹</span>
                        </div>
                    </button>

                    <button class="meal-card-btn" onclick="openCombinedModal('meal', 'ì—°ê¹€ë°¥')">
                        <div class="meal-img-box" style="background-image: url('https://newsimg.sedaily.com/2025/01/14/2GNOXAIO35_1.jpg');"></div>
                        <div class="meal-info">
                            <span class="meal-name">ì—°ê¹€ë°¥</span>
                            <span class="meal-desc">ì‹ ì„ í•œ ì¬ë£Œ ê¹€ë°¥(í¬ì¥ ì „ë¬¸, ì›”ìš”ì¼ íœ´ë¬´)</span>
                        </div>
                    </button>

                    <button class="meal-card-btn" disabled>
                        <div class="meal-img-box" style="background-color: #eee; display:flex; align-items:center; justify-content:center; color:#aaa; font-size:24px;">ğŸš«</div>
                        <div class="meal-info">
                            <span class="meal-name">ì¤€ë¹„ì¤‘</span>
                            <span class="meal-desc">Comming Soon</span>
                        </div>
                    </button>
                </div>
            </div>

        </div>
    </div>

  <script type="module">
        import { db, collection, getDocs, getDoc, setDoc, query, where, orderBy, updateDoc, addDoc, deleteDoc, doc, Timestamp } from "./js/firebase-config.js";

        const ADMIN_PW = "1388";
        const showLoading = (show) => { document.getElementById('loadingOverlay').style.display = show ? 'flex' : 'none'; }

        const getTodayStr = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        };

        // --- ì´ˆê¸°í™” ë° ì¸ì¦ ---
        window.onload = async () => {
            const { value: inputPw } = await Swal.fire({
                title: 'ê´€ë¦¬ì ì ‘ì†',
                input: 'password',
                inputPlaceholder: 'ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”',
                allowOutsideClick: false,
                confirmButtonText: 'ì ‘ì†'
            });

            if (inputPw !== ADMIN_PW) {
                document.body.innerHTML = "<div style='display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column;'><h2 style='color:#fa5252;'>â›” ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.</h2><button onclick='location.reload()' style='padding:10px 20px; cursor:pointer;'>ë‹¤ì‹œ ì‹œë„</button></div>";
                return;
            }

            // ë‚ ì§œ ì´ˆê¸°ê°’ ì„¤ì •
            const todayStr = getTodayStr();
            const monthAgo = new Date(); monthAgo.setMonth(monthAgo.getMonth() - 1);
            const monthAgoStr = monthAgo.toISOString().split('T')[0];

            document.getElementById('todayDisplay').innerText = todayStr;
            document.getElementById('settleStart').value = monthAgoStr;
            document.getElementById('settleEnd').value = todayStr;
            document.getElementById('recStart').value = monthAgoStr;
            document.getElementById('recEnd').value = todayStr;

            loadAllUsersAndApps();
        };

        // --- ê¸°ê¸° ë“±ë¡/í•´ì œ ---
        window.registerThisDevice = () => {
            if(confirm("ì´ PCë¥¼ í‚¤ì˜¤ìŠ¤í¬ìš© ê¸°ê¸°ë¡œ ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në“±ë¡ëœ ê¸°ê¸°ì—ì„œë§Œ 'í‚¤ì˜¤ìŠ¤í¬ í™”ë©´' ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.")) {
                localStorage.setItem('kiosk_auth_token', 'dream_center_pc');
                Swal.fire("ë“±ë¡ ì™„ë£Œ", "ì´ì œ ì´ ë¸Œë¼ìš°ì €ì—ì„œ í‚¤ì˜¤ìŠ¤í¬ í™”ë©´ ì ‘ì†ì´ í—ˆìš©ë©ë‹ˆë‹¤.", "success");
            }
        };
        window.unregisterThisDevice = () => {
            if(confirm("ì´ ê¸°ê¸°ì˜ ë“±ë¡ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem('kiosk_auth_token');
                Swal.fire("í•´ì œ ì™„ë£Œ", "í‚¤ì˜¤ìŠ¤í¬ ì ‘ì† ê¶Œí•œì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.", "info");
            }
        };

        // --- íƒ­ ì „í™˜ ë¡œì§ ---
        window.switchTab = (tabName) => {
            document.querySelectorAll('.table-box').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).style.display = 'block';

            // ë²„íŠ¼ í™œì„±í™” ì²˜ë¦¬ (ì¸ë±ìŠ¤ ë§¤í•‘)
            const map = { 'users': 0, 'settlement': 1, 'records': 2, 'ads': 3, 'education': 4 };
            document.querySelectorAll('.tab-btn')[map[tabName]].classList.add('active');

            if (tabName === 'users') loadAllUsersAndApps();
            if (tabName === 'ads') loadAds();
            if (tabName === 'education') loadEducationStats();
        };

        window.refreshData = () => {
            // í˜„ì¬ í™œì„± íƒ­ì— ë”°ë¼ ìƒˆë¡œê³ ì¹¨
            if (document.getElementById('tab-users').style.display !== 'none') loadAllUsersAndApps();
            else if (document.getElementById('tab-settlement').style.display !== 'none') loadSettlementData();
            else if (document.getElementById('tab-records').style.display !== 'none') loadRecords();
            else if (document.getElementById('tab-ads').style.display !== 'none') loadAds();
            else if (document.getElementById('tab-education').style.display !== 'none') loadEducationStats();
            
            const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 1000 });
            Toast.fire({ icon: 'success', title: 'ë°ì´í„° ê°±ì‹ ë¨' });
        };

        // --- [TAB 1] ì „ì²´ íšŒì› & ê¸‰ì‹ ê´€ë¦¬ (í•µì‹¬ ìˆ˜ì •) ---
        window.loadAllUsersAndApps = async () => {
            showLoading(true);
            const today = getTodayStr();
            const tbody = document.getElementById('userTableBody');
            
            try {
                // 1. ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const userSnap = await getDocs(query(collection(db, "users"), orderBy("name")));
                
                // 2. ì˜¤ëŠ˜ì ê¸‰ì‹ ì‹ ì²­ ë‚´ì—­ ê°€ì ¸ì˜¤ê¸°
                const appSnap = await getDocs(query(collection(db, "meal_applications"), where("date", "==", today)));

                let appsMap = {};
                appSnap.forEach(doc => {
                    const d = doc.data();
                    if (!appsMap[d.student_id]) appsMap[d.student_id] = [];
                    // ë¬¸ì„œ ID(doc.id)ì™€ íƒ€ì„ìŠ¤íƒ¬í”„ë¥¼ í¬í•¨í•˜ì—¬ ì €ì¥
                    appsMap[d.student_id].push({ 
                        docId: doc.id, 
                        ...d,
                        ts: d.timestamp ? d.timestamp.toMillis() : 0 
                    });
                });

                tbody.innerHTML = "";
                if (userSnap.empty) { 
                    tbody.innerHTML = "<tr><td colspan='5'>ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>"; 
                    showLoading(false); return; 
                }

                userSnap.forEach(userDoc => {
                    const u = userDoc.data();
                    const userId = userDoc.id;
                    let studentApps = appsMap[userId] || [];

                    // [ì¤‘ìš”] ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬ (ê°€ì¥ ìµœê·¼ ì‹ ì²­ì´ ë§¨ ì•ìœ¼ë¡œ)
                    studentApps.sort((a, b) => b.ts - a.ts);

                    // ì§„í–‰ ì¤‘ì¸ ì‹ ì²­(ìŠ¹ì¸ or ì‹ ì²­) ì°¾ê¸° - ê°€ì¥ ìµœì‹  ê²ƒ 1ê°œë§Œ ìœ íš¨
                    let activeApp = studentApps.find(app => app.status === 'applied' || app.status === 'approved');
                    let completedCount = studentApps.filter(app => app.status === 'completed').length;

                    let statusText = `<span style="color:#adb5bd; font-size:12px;">-</span>`;
                    let buttonsHtml = '';
                    
                    if (activeApp) {
                        const store = activeApp.store_name;
                        const status = activeApp.status;
                        const appId = activeApp.docId; // ì—¬ê¸°ì„œ DB ë¬¸ì„œ IDë¥¼ ì •í™•íˆ ê°€ì ¸ì˜´

                        if (status === 'applied') statusText = `<span class="badge badge-blue">${store} (ì‹ ì²­)</span>`;
                        else statusText = `<span class="badge badge-green" style="background:#fff9db; color:#f08c00;">${store} (ìŠ¹ì¸)</span>`;

                        // í˜„ì¬ ì„ íƒëœ ê°€ê²Œ ìŠ¤íƒ€ì¼ ì ìš©
                        const cD = store === 'ë‹¬ì¸ë³´ìŒˆ' ? 'active-dalin' : '';
                        const cM = store === 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹' ? 'active-mystery' : '';
                        const cY = store === 'ì—°ê¹€ë°¥' ? 'active-yeon' : '';

                        // [ì¤‘ìš”] ë²„íŠ¼ í´ë¦­ ì‹œ changeStore í•¨ìˆ˜ í˜¸ì¶œ (ë¬¸ì„œ ID ì „ë‹¬)
                        buttonsHtml = `
                            <div class="store-toggles">
                                <button class="toggle-btn ${cD}" onclick="changeStore('${appId}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button>
                                <button class="toggle-btn ${cM}" onclick="changeStore('${appId}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
                                <button class="toggle-btn ${cY}" onclick="changeStore('${appId}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
                            </div>`;
                    } else {
                        // ì‹ ì²­ ë‚´ì—­ì´ ì—†ìœ¼ë©´ ê°•ì œ ìŠ¹ì¸ ë²„íŠ¼ ë…¸ì¶œ
                        buttonsHtml = `
                            <div class="store-toggles">
                                <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë‹¬ì¸ë³´ìŒˆ')">ë‹¬ì¸</button>
                                <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ë¯¸ìŠ¤í…Œë¦¬ë¶„ì‹')">ë¯¸ìŠ¤í…Œë¦¬</button>
                                <button class="toggle-btn" onclick="forceApprove('${userId}', '${u.name}', 'ì—°ê¹€ë°¥')">ì—°ê¹€ë°¥</button>
                            </div>`;
                        if (completedCount > 0) statusText = `<span class="badge badge-green">ì‹ì‚¬ ì™„ë£Œ (${completedCount})</span>`;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td><div style="font-weight:bold;">${u.name}</div><div style="font-size:12px; color:#868e96;">${u.birth}</div></td>
                            <td>${statusText}</td>
                            <td>${buttonsHtml}</td>
                            <td><button class="btn-small" onclick="viewPw('${u.password}')">í™•ì¸</button><button class="btn-small btn-blue" onclick="changePw('${userId}')">ë³€ê²½</button></td>
                            <td><button class="btn-small btn-red" onclick="deleteUser('${userId}', '${u.name}')">ì‚­ì œ</button></td>
                        </tr>`;
                });
            } catch(e) { console.error(e); Swal.fire("ì˜¤ë¥˜", "ë°ì´í„° ë¡œë”© ì‹¤íŒ¨", "error"); }
            showLoading(false);
        };

        // [ìˆ˜ì •ë¨] ê°€ê²Œ ë³€ê²½ ë° ìŠ¹ì¸ (ì¦‰ì‹œ ë°˜ì˜)
        window.changeStore = async (docId, newStore) => {
            showLoading(true);
            try {
                // DB ì—…ë°ì´íŠ¸: ê°€ê²Œ ì´ë¦„ ë³€ê²½ + ìƒíƒœ ìŠ¹ì¸ìœ¼ë¡œ ê³ ì •
                await updateDoc(doc(db, "meal_applications", docId), { 
                    store_name: newStore, 
                    status: "approved" 
                });
                
                // ì„±ê³µ ì•Œë¦¼ (ì§§ê²Œ)
                const Toast = Swal.mixin({ toast: true, position: 'center', showConfirmButton: false, timer: 700 });
                Toast.fire({ icon: 'success', title: `${newStore} ë³€ê²½ ì™„ë£Œ` });

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadAllUsersAndApps();
            } catch(e) { 
                console.error(e); 
                Swal.fire("ì˜¤ë¥˜", "ë³€ê²½ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error");
            }
            showLoading(false);
        };

        // ê°•ì œ ìŠ¹ì¸ (ê´€ë¦¬ìê°€ ì§ì ‘ ì…ë ¥)
        window.forceApprove = async (userId, userName, storeName) => {
            if(confirm(`${userName}ë‹˜ì—ê²Œ [${storeName}] ì‹ì‚¬ê¶Œì„ ë°œê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                const today = getTodayStr();
                await addDoc(collection(db, "meal_applications"), {
                    student_id: userId, student_name: userName, store_name: storeName,
                    status: "approved", date: today, activity: "ê´€ë¦¬ììŠ¹ì¸", timestamp: Timestamp.now(),
                    is_settled: false
                });
                loadAllUsersAndApps();
            }
        };

        window.viewPw = (pw) => Swal.fire('ë¹„ë°€ë²ˆí˜¸', pw, 'info');
        window.changePw = async (userId) => {
            const { value: np } = await Swal.fire({ title: 'ìƒˆ ë¹„ë°€ë²ˆí˜¸', input: 'text', showCancelButton: true });
            if (np) { await updateDoc(doc(db, "users", userId), { password: np }); Swal.fire('ì™„ë£Œ', 'ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success'); }
        };
        window.deleteUser = async (userId, name) => {
            if(confirm(`${name} íšŒì›ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                await deleteDoc(doc(db, "users", userId));
                loadAllUsersAndApps();
            }
        };

        // --- [TAB 2] ì •ì‚° ê´€ë¦¬ ---
        window.loadSettlementData = async () => {
            showLoading(true);
            const start = document.getElementById('settleStart').value;
            const end = document.getElementById('settleEnd').value;
            const targetStore = document.getElementById('settleStore').value;
            const targetStatus = document.getElementById('settleStatus').value;
            const tbody = document.getElementById('settleBody');
            
            try {
                const snap = await getDocs(query(collection(db, "meal_applications"), orderBy("date", "desc")));
                let list = [], totalCnt=0, totalPrice=0, totalUnpaid=0;

                snap.forEach(doc => {
                    const d = doc.data();
                    if (d.date < start || d.date > end) return;
                    if (targetStore !== 'all' && d.store_name !== targetStore) return;
                    
                    const isSettled = d.is_settled === true;
                    if (targetStatus === 'no' && isSettled) return;
                    if (targetStatus === 'yes' && !isSettled) return;

                    const price = d.amount ? Number(d.amount) : 0;
                    // ìŠ¹ì¸ë˜ì—ˆê±°ë‚˜ ì™„ë£Œëœ ê±´ë§Œ í‘œì‹œ (ì‹ ì²­ ì¤‘ì¸ ê±´ ì œì™¸)
                    if (d.status === 'approved' || d.status === 'completed') {
                        if (price > 0 || isSettled) { // ê¸ˆì•¡ì´ ìˆê±°ë‚˜ ì •ì‚° ì™„ë£Œëœ ê²ƒ
                            totalCnt++; 
                            totalPrice += price;
                            if(!isSettled) totalUnpaid += price;
                            list.push({ id: doc.id, ...d, price, isSettled });
                        }
                    }
                });

                document.getElementById('sumCount').innerText = totalCnt + "ê±´";
                document.getElementById('sumPrice').innerText = totalPrice.toLocaleString() + "ì›";
                document.getElementById('sumUnpaid').innerText = totalUnpaid.toLocaleString() + "ì›";

                tbody.innerHTML = list.length ? "" : "<tr><td colspan='5'>ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                list.forEach(item => {
                    const btn = item.isSettled ? 
                        `<button class="btn-small btn-green" onclick="toggleSettle('${item.id}', false)">âœ… ì™„ë£Œ</button>` : 
                        `<button class="btn-small btn-red" onclick="toggleSettle('${item.id}', true)">âŒ ë¯¸ì •ì‚°</button>`;
                    
                    tbody.innerHTML += `<tr><td>${item.date}</td><td>${item.student_name}</td><td>${item.store_name}</td><td>${item.price.toLocaleString()}</td><td>${btn}</td></tr>`;
                });
            } catch(e) { console.error(e); }
            showLoading(false);
        };

        window.toggleSettle = async (id, state) => {
            if(confirm("ì •ì‚° ìƒíƒœë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                await updateDoc(doc(db, "meal_applications", id), { is_settled: state });
                loadSettlementData();
            }
        };

        // --- [TAB 3] í™œë™ ê¸°ë¡ ---
        window.loadRecords = async () => {
            showLoading(true);
            const start = document.getElementById('recStart').value;
            const end = document.getElementById('recEnd').value;
            const filterAct = document.getElementById('recActivity').value;
            const tbody = document.getElementById('recBody');
            
            try {
                // ì—¬ëŸ¬ ì»¬ë ‰ì…˜ í•©ì¹˜ê¸° (ì¶œì„, ê¸‰ì‹, ê°„ì‹)
                let records = [];
                const add = (snap, type) => snap.forEach(d => {
                    const data = d.data();
                    if(data.date >= start && data.date <= end) {
                        let actName = data.activity || (type==='meal' ? 'ì‹ì‚¬' : 'ê°„ì‹');
                        if(!filterAct || actName === filterAct) {
                            records.push({ date: data.date, name: data.student_name, act: actName });
                        }
                    }
                });

                const [attSnap, mealSnap, snackSnap] = await Promise.all([
                    getDocs(query(collection(db, "attendance"))),
                    getDocs(query(collection(db, "meal_applications"))),
                    getDocs(query(collection(db, "snacks")))
                ]);

                add(attSnap, 'attendance'); add(mealSnap, 'meal'); add(snackSnap, 'snack');
                
                // ë‚ ì§œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                records.sort((a,b) => b.date.localeCompare(a.date));

                tbody.innerHTML = records.length ? "" : "<tr><td colspan='3'>ê¸°ë¡ ì—†ìŒ</td></tr>";
                records.forEach(r => tbody.innerHTML += `<tr><td>${r.name}</td><td>${r.date}</td><td>${r.act}</td></tr>`);
            } catch(e) { console.error(e); }
            showLoading(false);
        };

        // --- [TAB 4] ê´‘ê³  ì„¤ì • ---
        window.loadAds = async () => {
            try {
                const docSnap = await getDoc(doc(db, "settings", "ads"));
                if(docSnap.exists()) {
                    const d = docSnap.data();
                    document.getElementById('ad1Img').value = d.ad1_img || "";
                    document.getElementById('ad1Link').value = d.ad1_link || "";
                    document.getElementById('ad2Img').value = d.ad2_img || "";
                    document.getElementById('ad2Link').value = d.ad2_link || "";
                }
            } catch(e) {}
        };

        window.saveAds = async () => {
            const data = {
                ad1_img: document.getElementById('ad1Img').value,
                ad1_link: document.getElementById('ad1Link').value,
                ad2_img: document.getElementById('ad2Img').value,
                ad2_link: document.getElementById('ad2Link').value
            };
            await setDoc(doc(db, "settings", "ads"), data);
            Swal.fire("ì €ì¥ ì™„ë£Œ", "í‚¤ì˜¤ìŠ¤í¬ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.", "success");
        };

        // --- [TAB 5] ê¸°ì´ˆì†Œì–‘êµìœ¡ ì´ìˆ˜ ëŒ€ì¥ (ì‹ ê·œ) ---
        window.loadEducationStats = async () => {
            showLoading(true);
            const tbody = document.getElementById('eduBody');
            const searchName = document.getElementById('eduSearchName').value.trim();
            
            try {
                const q = query(collection(db, "education_records"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                let records = [];
                
                querySnapshot.forEach(doc => records.push(doc.data()));

                if (searchName) {
                    records = records.filter(r => r.student_name && r.student_name.includes(searchName));
                }

                tbody.innerHTML = "";
                if (records.length === 0) {
                    tbody.innerHTML = "<tr><td colspan='5'>ì¡°íšŒëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                } else {
                    records.forEach(d => {
                        tbody.innerHTML += `
                            <tr>
                                <td>${d.date}</td>
                                <td>${d.student_name}</td>
                                <td>${d.student_birth || '-'}</td>
                                <td><span class="badge badge-blue">${d.category}</span></td>
                                <td style="text-align:left; padding-left:15px;">${d.video_title}</td>
                            </tr>
                        `;
                    });
                }
            } catch(e) { console.error(e); tbody.innerHTML = "<tr><td colspan='5'>ë¡œë”© ì‹¤íŒ¨</td></tr>"; }
            showLoading(false);
        };

        // --- ìœ í‹¸ë¦¬í‹° (ì—‘ì…€/PDF) ---
        window.downloadTableAsExcel = (id, name) => { 
            const wb = XLSX.utils.table_to_book(document.getElementById(id)); 
            XLSX.writeFile(wb, name + ".xlsx"); 
        };

        window.generateSettlementPDF = () => {
            // (ìƒëµ: ê¸°ì¡´ê³¼ ë™ì¼í•œ ë¡œì§, í•„ìš”ì‹œ ì´ì „ ì½”ë“œ ì°¸ì¡°)
            alert("PDF ê¸°ëŠ¥ì€ ì„œë²„ í™˜ê²½ì´ë‚˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        };
        window.generateRecordPDF = () => {
            alert("PDF ê¸°ëŠ¥ ì¤€ë¹„ì¤‘");
        };

    </script>
</body>
</html>

